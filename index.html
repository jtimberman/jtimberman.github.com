
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>jtimberman's Code Blog</title>
  <meta name="author" content="Joshua Timberman">

  
  <meta name="description" content="I&rsquo;ve started working with the audit mode feature of Chef introduced in version 12.1. Audit mode allows users to write custom rules (controls) &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jtimberman.housepub.org">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="jtimberman's Code Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud?source=profiles" />
<link rel="openid2.local_id" href="http://www.google.com/profiles/100567271038100401523" />

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26031299-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">jtimberman's Code Blog</a></h1>
  
    <h2>Chef, Ops, Ruby, Linux/Unix. Opinions are mine, not my employer's (CHEF).</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jtimberman.housepub.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/03/chef-audit-mode-introduction/">Chef Audit Mode Introduction</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-03T20:48:23-06:00" pubdate data-updated="true">Apr 3<span>rd</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve started working with the <a href="https://docs.chef.io/analytics.html#audit-mode">audit mode</a> feature of Chef introduced in version 12.1. Audit mode allows users to write custom rules (controls) in Chef recipes using new DSL helpers. In his talk, &ldquo;Compliance At Velocity,&rdquo; James Casey goes into more of the background and reasoning for this. For now, I wanted to share a few tips with users who may be experimenting with this feature on their own, too.</p>

<p>First, we need to update ChefDK to version 0.5.0 (rc 3 is current), as that includes a version of test kitchen that <a href="https://github.com/test-kitchen/test-kitchen/pull/652">allows us to configure audit mode</a> for chef-client.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -L https://chef.io/chef/install.sh | sudo bash -s -- -P chefdk -p</span></code></pre></td></tr></table></div></figure>


<p>The <code>-p</code> option tells the script to use the prerelease version, as of this writing 0.5.0 is not released, but we have a release candidate.</p>

<p>Next, create a new cookbook for the audit mode tests.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef generate cookbook audit-test
</span><span class='line'>cd audit-test</span></code></pre></td></tr></table></div></figure>


<p>Then, modify the audit-test cookbook&rsquo;s <code>.kitchen.yml</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>---
</span><span class='line'>driver:
</span><span class='line'>  name: vagrant
</span><span class='line'>
</span><span class='line'>provisioner:
</span><span class='line'>  name: chef_zero
</span><span class='line'>  client_rb:
</span><span class='line'>    audit_mode: :audit_only
</span><span class='line'>
</span><span class='line'>platforms:
</span><span class='line'>  - name: ubuntu-12.04
</span><span class='line'>  - name: centos-6.5
</span><span class='line'>
</span><span class='line'>suites:
</span><span class='line'>  - name: default
</span><span class='line'>    run_list:
</span><span class='line'>      - recipe[audit-test::default]
</span><span class='line'>    attributes:</span></code></pre></td></tr></table></div></figure>


<p>This is the generated <code>.kitchen.yml</code> with <code>client_rb</code> added to the provisioner config. Note that we must use the Ruby symbol syntax for the config value, <code>:audit_only</code>. The other valid values for <code>audit_mode</code> are <code>:enabled</code> and <code>:disabled</code>. This will be translated to an actual Ruby symbol in the generated config file (<code>/tmp/kitchen/client.rb</code>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">audit_mode</span> <span class="ss">:audit_only</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, let&rsquo;s write a control rule to test. Since we&rsquo;re using the default <code>.kitchen.yml</code>, which includes Ubuntu 12.04 and uses SSH to connect, we can assume that SSH is running, so port 22 is listening. Let&rsquo;s write a control that asserts this is true.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">control_group</span> <span class="s1">&#39;Blog Post Examples&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">control</span> <span class="s1">&#39;SSH&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should be listening on port 22&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">port</span><span class="p">(</span><span class="mi">22</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_listening</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now run <code>kitchen converge ubuntu</code> to run Chef, but not tear down the VM aftward &ndash; we&rsquo;ll use it again for another example. Here&rsquo;s the audit phase output from the Chef run:</p>

<pre><code>% kitchen converge ubuntu
Synchronizing Cookbooks:
  - audit-test
Compiling Cookbooks...
Starting audit phase

Blog Post Examples
  SSH
    should be listening on port 22

Finished in 0.10453 seconds (files took 0.37536 seconds to load)
1 example, 0 failures
Auditing complete
</code></pre>

<p>Cool! So we have asserted that the node complies with this control by default. But what does a failing control look like? Let&rsquo;s write one. Since we&rsquo;re working with SSH already, let&rsquo;s use the SSHd configuration. By default in the Vagrant base box we&rsquo;re using, root login is permitted, so this value is present:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">PermitRootLogin</span> <span class="n">yes</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, our security policy mandates that we set this to <code>no</code>, and we want to audit that.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">control_group</span> <span class="s1">&#39;Blog Post Examples&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">control</span> <span class="s1">&#39;SSH&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should be listening on port 22&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">port</span><span class="p">(</span><span class="mi">22</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_listening</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;disables root logins over ssh&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">contain</span><span class="p">(</span><span class="s1">&#39;PermitRootLogin no&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rerun <code>kitchen converge ubuntu</code> and we see the validation fails.</p>

<pre><code>Starting audit phase

Blog Post Examples
  SSH
    should be listening on port 22
    disables root logins over ssh (FAILED - 1)

Failures:

  1) Blog Post Examples SSH disables root logins over ssh
     Failure/Error: expect(file('/etc/ssh/sshd_config')).to contain('PermitRootLogin no')
expected File "/etc/ssh/sshd_config" to contain "PermitRootLogin no"
     # /tmp/kitchen/cache/cookbooks/audit-test/recipes/default.rb:8:in `block (3 levels) in from_file'

Finished in 0.13067 seconds (files took 0.32089 seconds to load)
2 examples, 1 failure

Failed examples:

rspec  # Blog Post Examples SSH disables root logins over ssh
[2015-04-04T03:29:41+00:00] ERROR: Audit phase failed with error message: Audit phase found failures - 1/2 controls failed

Audit phase exception:
Audit phase found failures - 1/2 controls failed
</code></pre>

<p>When we have a failure, we&rsquo;ll have contextual information about the failure, including the line number in the recipe where itwas found, and a stack trace (cut from the output here), in case more information is required for debugging. To fix the test, we can simply edit the config file to have the desired setting, or we can manage the file with Chef to set the value accordingly. Either way, after updating the file, the validation will pass, and all will be well.</p>

<p>We can put as many <code>control_group</code> and <code>control</code> blocks with the <code>it</code> validation rules as required to audit our policy. If we have many validations, it can be difficult to follow with all the output if there are failures. Chef&rsquo;s audit mode is based on <a href="http://serverspec.org/">Serverspec</a>, which is based on <a href="http://rspec.info/">RSpec</a>. We can use the <code>filter_tag</code> configuration feature of RSpec to only run the <code>control</code> blocks or <code>it</code> statements that we&rsquo;re interested in debugging. To do this, we need an <code>RSpec.configuration</code> block within the <code>control_group</code> &ndash; due to the way that audit mode is implemented, we can&rsquo;t do it outside of <code>control_group</code>.</p>

<p>For example, we could debug our root login configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">control_group</span> <span class="s1">&#39;Blog Post Examples&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="o">::</span><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
</span><span class='line'>    <span class="n">c</span><span class="o">.</span><span class="n">filter_run</span> <span class="ss">focus</span><span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">control</span> <span class="s1">&#39;SSH&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should be listening on port 22&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">port</span><span class="p">(</span><span class="mi">22</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_listening</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;disables root logins over ssh&#39;</span><span class="p">,</span> <span class="ss">focus</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">expect</span><span class="p">(</span><span class="n">file</span><span class="p">(</span><span class="s1">&#39;/etc/ssh/sshd_config&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">contain</span><span class="p">(</span><span class="s1">&#39;PermitRootLogin no&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The key here is to pass the argument <code>focus: true</code> (or if you like hash rockets, <code>:focus =&gt; true</code>) on the <code>it</code> block. This could also be used on a <code>control</code> block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">control</span> <span class="s1">&#39;SSH&#39;</span><span class="p">,</span> <span class="ss">focus</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;does stuff...&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, when running <code>kitchen converge ubuntu</code>, we see only that validation:</p>

<pre><code>Starting audit phase

Blog Post Examples
  SSH
    disables root logins over ssh (FAILED - 1)

Failures:

  1) Blog Post Examples SSH disables root logins over ssh
     Failure/Error: expect(file('/etc/ssh/sshd_config')).to contain('PermitRootLogin no')
</code></pre>

<p>This example is simple enough that this isn&rsquo;t necessary, but if we were implementing audit mode checks for our entire security policy, that could be dozens or even hundreds of controls.</p>

<p>As of this writing, audit mode is still under development, and is considered an experimental feature. There will be further information, guides, and documentation about it coming to the Chef blog and docs site, and I&rsquo;ll have a post coming soon with something I&rsquo;m working on, so stay tuned!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/25/missing-transitive-dependencies/">Missing Transitive Dependencies</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-25T12:54:08-06:00" pubdate data-updated="true">Mar 25<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of my home projects while I&rsquo;m on vacation this week is rebuilding my server with Fedora 21 (<a href="https://getfedora.org/en/server/">Server</a>). In order to do this, I needed to <a href="https://github.com/hw-cookbooks/runit/commit/c3d46bcf2c330e90aff8f1bb1e1701d57078cca8">add Fedora support</a> to the <a href="https://supermarket.chef.io/cookbooks/runit">runit</a> cookbook, since I use runit for a number of services on my system. That&rsquo;s really neither here nor there, as the topic of this blog post isn&rsquo;t specific to Fedora, nor runit.</p>

<p>The topic is actually about an issue with transitive dependencies and how Chef dependency resolution works.</p>

<p>Here&rsquo;s the scenario:</p>

<ol>
<li>I run chef on my node</li>
<li>The runit cookbook is synchronized</li>
<li>An older version of the runit cookbook is downloaded</li>
<li>The new changes I expected were not made</li>
<li>WTFs ensue</li>
</ol>


<p>So what happened?</p>

<p>The runit cookbook itself is updated to use Ian Meyer&rsquo;s Package Cloud repository &ndash; at least, the version I want to use is, which is on GitHub. When I submitted the PR for adding this repository for RHEL platforms, Ian had not yet added Fedora packages. That&rsquo;s okay because Fedora is not listed as supported in the cookbook. However, I wanted to use it, and figured folks in the community using Fedora Server might benefit too.</p>

<p>I digress. Ian pushed a Fedora package earlier today, so I added &ldquo;fedora&rdquo; to the various platform family conditionals, in the cookbook and opened the PR linked earlier. All was well in test kitchen. So I change my local repository&rsquo;s Berksfile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cookbook</span> <span class="s1">&#39;runit&#39;</span><span class="p">,</span> <span class="ss">github</span><span class="p">:</span> <span class="s1">&#39;hw-cookbooks/runit&#39;</span><span class="p">,</span> <span class="ss">ref</span><span class="p">:</span> <span class="s1">&#39;jtimberman/fedora-21&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then a quick <code>berks update runit</code> and <code>berks upload runit</code>, and I was in business.</p>

<p>Or so I thought. Enter scenario listed above. The problem is, that when I did the <code>berks upload</code>, it only uploaded <code>runit</code>. However in the latest <code>runit</code> cookbook from that branch, it also adds a dependency on Computology&rsquo;s <a href="https://supermarket.chef.io/cookbooks/packagecloud">packagecloud</a> cookbook, since it uses that to add the repository. When the <code>runit</code> cookbook is specified on the <code>berks upload</code> command, it doesn&rsquo;t upload the transitive dependencies when the location is a git URI. This appears to be by design.</p>

<p>What happens in Chef is that the server solves the graph, seeing that the node needs the runit cookbook. But the latest version of the runit cookbook depends on packagecloud, which hasn&rsquo;t yet been uploaded. So the dependency solver looks for the latest version of the runit cookbook that meets the constraint (none), and doesn&rsquo;t have the packagecloud cookbook. Thus, I end up with runit version 1.5.18 on my node, but it fails to converge because it doesn&rsquo;t have the changes required for Fedora, which are in 1.5.20.</p>

<p>The simple solution here is to upload the packagecloud cookbook. This can be done with <code>berks upload packagecloud</code>, as it does exist in the Berksfile.lock and has been cached in the berkshelf. Alternatively, <code>berks upload</code> will also upload the cookbook, as that operates on all cookbooks in  the Berksfile.lock.</p>

<p>I hope this helps anyone who&rsquo;s faced this issue with transitive dependencies when working on a cookbook &ldquo;in development.&rdquo;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/20/chef-gem-compile-time-compatibility/">Chef Gem Compile Time Compatibility</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-20T08:46:47-06:00" pubdate data-updated="true">Mar 20<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>TL;DR, if you&rsquo;re using Chef 11 and <code>chef-sugar</code>, upgrade <code>chef-sugar</code> to version 3.0.1. If you cannot upgrade, use the following in your <code>chef_gem</code> resources in your recipes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">compile_time</span> <span class="kp">true</span> <span class="k">if</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Resource</span><span class="o">::</span><span class="no">ChefGem</span><span class="o">.</span><span class="n">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:compile_time</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you may be aware, <a href="https://www.chef.io/blog/2015/03/03/chef-12-1-0-released/">Chef 12.1.0</a> introduces a change to the <code>chef_gem</code> resource that prints out warning messages like this:</p>

<pre><code>WARN: chef_gem[chef-vault] chef_gem compile_time installation is deprecated
WARN: chef_gem[chef-vault] Please set `compile_time false` on the resource to use the new behavior.
WARN: chef_gem[chef-vault] or set `compile_time true` on the resource if compile_time behavior is required.
</code></pre>

<p>These messages are just warnings, but if you&rsquo;re installing a lot of gems in your recipes, you may be annoyed by the output. As the warning indicates, you can set <code>compile_time true</code> property. This doesn&rsquo;t work on versions of Chef before 12.1, though:</p>

<pre><code>NoMethodError: undefined method `compile_time' for Chef::Resource::ChefGem
</code></pre>

<p>So, as a workaround, we can ask whether we respond to the <code>compile_time</code> method in the <code>chef_gem</code> resource:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chef_gem</span> <span class="s1">&#39;chef-vault&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">compile_time</span> <span class="kp">false</span> <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="ss">:compile_time</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This appears to get around the problem for most cases. However, if you&rsquo;re using <code>chef-sugar</code>, you&rsquo;ll note that until version 3.0.0, <code>chef-sugar</code> includes a <code>compile_time</code> DSL method that gets injected into <code>Chef::Resource</code> (and <code>Chef::Recipe</code>). This has been modified to <code>at_compile_time</code> in <code>chef-sugar</code> version 3.0.0 to work around Chef&rsquo;s introduction of a <code>compile_time</code> method in the <code>chef_gem</code> resource. The simple thing to do is make sure that your <code>chef-sugar</code> gem/cookbook are updated to v3.0.1. However if that isn&rsquo;t an option for some reason, you can use this conditional check:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chef_gem</span> <span class="s1">&#39;chef-vault&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">compile_time</span> <span class="kp">true</span> <span class="k">if</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Resource</span><span class="o">::</span><span class="no">ChefGem</span><span class="o">.</span><span class="n">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:compile_time</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hat tip to Anthony Scalisi, who added this in <a href="https://github.com/opscode-cookbooks/aws/pull/110">a pull request for the aws cookbook</a>. The <code>instance_methods</code> method comes from Ruby&rsquo;s <a href="http://ruby-doc.org/core-2.2.1/Module.html#method-i-instance_methods">Module class</a>. Per the documentation:</p>

<blockquote><p>Returns an array containing the names of the public and protected instance methods in the receiver. For a module, these are the public and protected methods; for a class, they are the instance (not singleton) methods. If the optional parameter is false, the methods of any ancestors are not included.</p></blockquote>

<p>If we look at this in, e.g., <code>chef-shell</code> under Chef 12.1.0:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">chef</span><span class="p">:</span><span class="n">recipe</span> <span class="o">&gt;</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Resource</span><span class="o">::</span><span class="no">ChefGem</span><span class="o">.</span><span class="n">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:gem_binary</span><span class="p">,</span> <span class="ss">:compile_time</span><span class="p">,</span> <span class="ss">:after_created</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in Chef 12.0.3 or 11.18.6:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chef</span> <span class="o">&gt;</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Resource</span><span class="o">::</span><span class="no">ChefGem</span><span class="o">.</span><span class="n">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:gem_binary</span><span class="p">,</span> <span class="ss">:after_created</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/10/awesome-syntax-highlighting-in-keynote/">Awesome Syntax Highlighting in Keynote</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-10T21:31:49-07:00" pubdate data-updated="true">Feb 10<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I am working on my presentation for ChefConf. I plan to have quite a lot of code samples. I&rsquo;ve found the options for getting code samples with nice syntax highlight a lackluster endeavour, with various GUI editors like TextMate, Sublime, and Atom having &ldquo;Copy as RTF&rdquo; plugins, but none of them being easily customizable.</p>

<p>So I did a quick Google search and happened on a gist I hadn&rsquo;t seen before. <a href="https://gist.github.com/jimbojsb/1630790">It</a> describes the following steps:</p>

<ol>
<li>Install Homebrew (done, I have that covered with Chef ;)).</li>
<li>Install &ldquo;highlight&rdquo; with <code>brew install highlight</code>.</li>
<li>Use highlight to transform the source code file to RTF and copy it to the clipboard.</li>
<li>Paste the clipboard into Keynote.app.</li>
</ol>


<p>This isn&rsquo;t much different than the other solutions, except one super cool thing I learned about highlight.</p>

<p>It has styles.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>highlight -w
</span><span class='line'>
</span><span class='line'>&lt;OMG LIST OF EIGHTY TWO DIFFERENT STYLES!!!&gt;</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s right, at least at the time of this writing highlight has 82 different styles available. Including my favorite(s) solarized &ndash; both light and dark. Note that the <code>--help</code> output says that this option is deprecated in the version I&rsquo;ve installed (3.18_1), but the styles are in <code>/usr/local/Cellar/highlight/VERSION/share/themes</code>.</p>

<p>Highlight knows the syntax highlighting for a lot of languages, these are in <code>/usr/local/Cellar/highlight/VERSION/share/langDefs</code>. For example I can get my Ruby recipe highlighted with this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>highlight -s solarized-light -O rtf recipes/client.rb | pbcopy</span></code></pre></td></tr></table></div></figure>


<p>This will use Courier New as the font, and depending on the theme/style used, some of the highlighting may be bold or italic. This is easy enough to change in Keynote though.</p>

<p>For up to date documentation and information about highlight, visit the <a href="http://www.andre-simon.de/doku/highlight/en/highlight.php">author&rsquo;s page</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/09/quick-tip-create-a-provisioner-node/">Quick Tip: Create a Provisioner Node</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-09T20:50:12-07:00" pubdate data-updated="true">Feb 9<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This quick tip is brought to you by my preparation for my ChefConf talk about using Chef Provisioning to build a Chef Server Cluster, which is based on my blog post about the same. In the blog post I used chef-zero as my Chef Server, but for the talk I&rsquo;m using Hosted Chef.</p>

<p>In order for the Chef Provisioning recipe to work the provisioning node &ndash; the node that runs chef-client &ndash; needs to have the appropriate permissions to manage objects on the Chef Server. This is easy with chef-zero &ndash; there are no ACLs at all. However in Hosted Chef, like any regular Chef Server, the ACLs don&rsquo;t allow nodes&#8217; API clients to modify other nodes, or API clients.</p>

<p>Fortunately we can do all the work necessary using knife, with the <a href="https://github.com/chef/knife-acl">knife-acl</a> plugin. In this quick tip, I&rsquo;ll create a group for provisioning nodes, and give that group the proper permissions for the Chef Provisioning recipe to create the machines&#8217; nodes and clients.</p>

<p>First of all, I&rsquo;m using ChefDK, and it&rsquo;s my Ruby environment too, so install the gem:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>chef gem install knife-acl
</span></code></pre></td></tr></table></div></figure>


<p>Next, use the <code>knife group</code> subcommand to create the new group. Groups are a number of users and/or API clients. By default, an organization on Hosted Chef will have <code>admins</code>, <code>billing-admins</code>, <code>clients</code>, and <code>users</code>. Let&rsquo;s create <code>provisioners</code> now.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>knife group create provisioners
</span></code></pre></td></tr></table></div></figure>


<p>The Role-based access control (RBAC) system in the Chef Server allows us to assign read, create, update, grant, and delete permissions to various objects in the organization. Containers are a special holder of other types of objects, in this case we need to add permissions for the clients and nodes containers. This is what allows the Chef Provisioning recipe&rsquo;s <code>machine</code> resources to have their Chef objects created.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="k">for </span>i in <span class="nb">read </span>create update grant delete
</span><span class='line'><span class="k">do</span>
</span><span class='line'><span class="k">  </span>knife acl add containers clients <span class="nv">$i</span> group provisioners
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="k">for </span>i in <span class="nb">read </span>create update grant delete
</span><span class='line'><span class="k">do</span>
</span><span class='line'><span class="k">  </span>knife acl add containers nodes <span class="nv">$i</span> group provisioners
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need the API client that will be used by the Chef Provisioning node to authenticate with the Chef Server, and the node needs to be created as well. By default the client will automatically have permissions for the node object that has the same name.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>knife client create -d chefconf-provisioner &gt; ~/.chef/chefconf-provisioner.pem
</span><span class='line'>knife node create -d chefconf-provisioner
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we need to put the new API client into the provisioners group that was created earlier. First we need to get a mapping of the actors in the organization. Then we can add the client to the group.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>knife actor map
</span><span class='line'>knife group add actor provisioners chefconf-provisioner
</span></code></pre></td></tr></table></div></figure>


<p>The <code>knife actor map</code> command will generate a YAML file like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">:user_map</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:users</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">jtimberman</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">12345678901234567890123456780123</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:usags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">12345678901234567890123456780123</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">jtimberman</span>
</span><span class='line'><span class="l-Scalar-Plain">:clients</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">chefconf-provisioner</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chefconf-provisioner</span>
</span><span class='line'>  <span class="l-Scalar-Plain">jtimberman-chefconf-validator</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">jtimberman-chefconf-validator</span>
</span></code></pre></td></tr></table></div></figure>


<p>This maps users to their USAG and stores a list of clients. More information about this is in the <a href="https://github.com/chef/knife-acl/blob/master/README.md">knife-acl README</a></p>

<p>At this point, we have a node, with the private key in <code>~/.chef</code> that can be used with the Chef Server to use Chef Provisioning&rsquo;s <code>machine</code> resource. We can also perform additional tasks that require having a node object, such as create secrets as Chef Vault items:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>knife vault create secrets dnsimple -M client -J data_bags/secrets/dnsimple.json -A jtimberman -S <span class="s1">&#39;name:chefconf-provisioner&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The entire series of commands is below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>chef gem install knife-acl
</span><span class='line'>knife group create provisioners
</span><span class='line'>
</span><span class='line'><span class="k">for </span>i in <span class="nb">read </span>create update grant delete
</span><span class='line'><span class="k">do</span>
</span><span class='line'><span class="k">  </span>knife acl add containers clients <span class="nv">$i</span> group provisioners
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="k">for </span>i in <span class="nb">read </span>create update grant delete
</span><span class='line'><span class="k">do</span>
</span><span class='line'><span class="k">  </span>knife acl add containers nodes <span class="nv">$i</span> group provisioners
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'>knife client create -d chefconf-provisioner &gt; ~/.chef/chefconf-provisioner.pem
</span><span class='line'>knife node create -d chefconf-provisioner
</span><span class='line'>knife actor map
</span><span class='line'>knife group add actor provisioners chefconf-provisioner
</span><span class='line'>
</span><span class='line'>knife vault create secrets dnsimple -M client -J data_bags/secrets/dnsimple.json -A jtimberman -S <span class="s1">&#39;name:chefconf-provisioner&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hopefully this helps you out with your use of Chef Provisioning, and a non-zero Chef server. If you have further questions, find me at ChefConf!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/17/quick-tip-define-resources-to-notifiy-in-lwrps/">Quick Tip: Define Resources to Notifiy in LWRPs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-17T22:37:06-07:00" pubdate data-updated="true">Jan 17<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this quick tip, I&rsquo;ll explain why you may need to create resources to notify in a provider, even if the resource exists in a recipe, when using <code>use_inline_resources</code> in Chef&rsquo;s <a href="http://docs.chef.io/lwrp.html">LWRP DSL</a>.</p>

<p>I&rsquo;ll use an example cookbook, <code>notif</code>, to illustrate. First, I&rsquo;ve created <code>cookbooks/notif/resources/default.rb</code>, with the following content.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">actions</span> <span class="ss">:write</span>
</span><span class='line'><span class="n">default_action</span> <span class="ss">:write</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, I have written <code>cookbooks/notif/providers/default.rb</code> like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">use_inline_resources</span>
</span><span class='line'>
</span><span class='line'><span class="n">action</span> <span class="ss">:write</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">log</span> <span class="s1">&#39;notifer&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">notifies</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">&#39;file[notified]&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then the default recipe, where I&rsquo;ll use the resource automatically generated from the resource directory, <code>notif</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">file</span> <span class="s1">&#39;notified&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="s1">&#39;something&#39;</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:nothing</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">notif</span> <span class="s1">&#39;doer&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>When I run Chef, I&rsquo;ll get an error like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="ss">Recipe</span><span class="p">:</span> <span class="ss">notif</span><span class="p">:</span><span class="ss">:default</span>
</span><span class='line'>   <span class="o">*</span> <span class="n">file</span><span class="o">[</span><span class="n">notified</span><span class="o">]</span> <span class="n">action</span> <span class="n">nothing</span> <span class="p">(</span><span class="n">skipped</span> <span class="n">due</span> <span class="n">to</span> <span class="n">action</span> <span class="ss">:nothing</span><span class="p">)</span>
</span><span class='line'>   <span class="o">*</span> <span class="n">notif</span><span class="o">[</span><span class="n">doer</span><span class="o">]</span> <span class="n">action</span> <span class="n">write</span>
</span><span class='line'>
</span><span class='line'>     <span class="o">================================================================================</span>
</span><span class='line'>     <span class="no">Error</span> <span class="n">executing</span> <span class="n">action</span> <span class="sb">`write`</span> <span class="n">on</span> <span class="n">resource</span> <span class="s1">&#39;notif[doer]&#39;</span>
</span><span class='line'>     <span class="o">================================================================================</span>
</span><span class='line'>
</span><span class='line'>     <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Exceptions</span><span class="o">::</span><span class="no">ResourceNotFound</span>
</span><span class='line'>     <span class="o">----------------------------------</span>
</span><span class='line'>     <span class="n">resource</span> <span class="n">log</span><span class="o">[</span><span class="n">notifer</span><span class="o">]</span> <span class="n">is</span> <span class="n">configured</span> <span class="n">to</span> <span class="n">notify</span> <span class="n">resource</span> <span class="n">file</span><span class="o">[</span><span class="n">notified</span><span class="o">]</span> <span class="n">with</span> <span class="n">action</span> <span class="n">create</span><span class="p">,</span> <span class="n">but</span> <span class="n">file</span><span class="o">[</span><span class="n">notified</span><span class="o">]</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">found</span> <span class="k">in</span> <span class="n">the</span> <span class="n">resource</span> <span class="n">collection</span><span class="o">.</span> <span class="n">log</span><span class="o">[</span><span class="n">notifer</span><span class="o">]</span> <span class="n">is</span> <span class="n">defined</span> <span class="k">in</span> <span class="sr">/tmp/</span><span class="n">kitchen</span><span class="o">/</span><span class="n">cookbooks</span><span class="o">/</span><span class="n">notif</span><span class="o">/</span><span class="n">providers</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">rb</span><span class="p">:</span><span class="mi">4</span><span class="ss">:in</span> <span class="sb">`block in class_from_file&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="sb">     Resource Declaration:</span>
</span><span class='line'><span class="sb">     ---------------------</span>
</span><span class='line'><span class="sb">     # In /tmp/kitchen/cookbooks/notif/recipes/default.rb</span>
</span><span class='line'>
</span><span class='line'><span class="sb">      12: notif &#39;doer&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="sb">     Compiled Resource:</span>
</span><span class='line'><span class="sb"> ------------------</span>
</span><span class='line'><span class="sb">     # Declared in /tmp/kitchen/cookbooks/notif/recipes/default.rb:12:in `</span><span class="n">from_file</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">notif</span><span class="p">(</span><span class="s2">&quot;doer&quot;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>       <span class="n">action</span> <span class="ss">:write</span>
</span><span class='line'>       <span class="n">retries</span> <span class="mi">0</span>
</span><span class='line'>       <span class="n">retry_delay</span> <span class="mi">2</span>
</span><span class='line'>       <span class="n">default_guard_interpreter</span> <span class="ss">:default</span>
</span><span class='line'>       <span class="n">declared_type</span> <span class="ss">:notif</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">recipe_name</span> <span class="s2">&quot;default&quot;</span>
</span><span class='line'>     <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>To fix this, I define the <code>file</code> resource in the provider:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">use_inline_resources</span>
</span><span class='line'>
</span><span class='line'><span class="n">action</span> <span class="ss">:write</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">log</span> <span class="s1">&#39;notifer&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">notifies</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">&#39;file[notified]&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">file</span> <span class="s1">&#39;notified&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">content</span> <span class="n">new_resource</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then when I run Chef, it will converge and notify the file resource to be configured.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Recipe</span><span class="p">:</span> <span class="ss">notif</span><span class="p">:</span><span class="ss">:default</span>
</span><span class='line'>  <span class="o">*</span> <span class="n">file</span><span class="o">[</span><span class="n">notified</span><span class="o">]</span> <span class="n">action</span> <span class="n">nothing</span> <span class="p">(</span><span class="n">skipped</span> <span class="n">due</span> <span class="n">to</span> <span class="n">action</span> <span class="ss">:nothing</span><span class="p">)</span>
</span><span class='line'>  <span class="o">*</span> <span class="n">notif</span><span class="o">[</span><span class="n">doer</span><span class="o">]</span> <span class="n">action</span> <span class="n">write</span>
</span><span class='line'>    <span class="o">*</span> <span class="n">log</span><span class="o">[</span><span class="n">notifer</span><span class="o">]</span> <span class="n">action</span> <span class="n">write</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">*</span> <span class="n">file</span><span class="o">[</span><span class="n">notified</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span>
</span><span class='line'>      <span class="o">-</span> <span class="n">create</span> <span class="kp">new</span> <span class="n">file</span> <span class="n">notified</span>
</span><span class='line'>      <span class="o">-</span> <span class="n">update</span> <span class="n">content</span> <span class="k">in</span> <span class="n">file</span> <span class="n">notified</span> <span class="n">from</span> <span class="n">none</span> <span class="n">to</span> <span class="mi">935</span><span class="n">e8e</span>
</span><span class='line'>      <span class="o">---</span> <span class="n">notified</span>       <span class="mi">2015</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">18</span> <span class="mo">05</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">49</span><span class="o">.</span><span class="mi">186399317</span> <span class="o">+</span><span class="mo">0000</span>
</span><span class='line'>      <span class="o">+++</span> <span class="o">.</span><span class="n">/</span><span class="o">.</span><span class="n">notified20150118</span><span class="o">-</span><span class="mi">15795</span><span class="o">-</span><span class="n">om5fiw</span>       <span class="mi">2015</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">18</span> <span class="mo">05</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">49</span><span class="o">.</span><span class="mi">186399317</span> <span class="o">+</span><span class="mo">0000</span>
</span><span class='line'>      <span class="err">@@</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="err">@@</span>
</span><span class='line'>      <span class="o">+</span><span class="n">doer</span>
</span><span class='line'>    <span class="o">*</span> <span class="n">file</span><span class="o">[</span><span class="n">notified</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span> <span class="p">(</span><span class="n">up</span> <span class="n">to</span> <span class="n">date</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="no">Running</span> <span class="ss">handlers</span><span class="p">:</span>
</span><span class='line'><span class="no">Running</span> <span class="n">handlers</span> <span class="n">complete</span>
</span><span class='line'><span class="no">Chef</span> <span class="no">Client</span> <span class="n">finished</span><span class="p">,</span> <span class="mi">3</span><span class="o">/</span><span class="mi">4</span> <span class="n">resources</span> <span class="n">updated</span> <span class="k">in</span> <span class="mi">1</span><span class="o">.</span><span class="mi">298990565</span> <span class="n">seconds</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Why does this happen?</h2>

<p>The reason for this is because <code>use_inline_resources</code> tells Chef that in this provider, we&rsquo;re using inline resources that will be added to their own run context, with their own resource collection. We don&rsquo;t have access to the resource collection from the recipe. Even though the <code>file[notified]</code> resource exists from the recipe, it doesn&rsquo;t actually get inherited in the provider&rsquo;s run context, raising the error we saw before.</p>

<p>We can turn off <code>use_inline_resources</code> by removing it, and the custom resource will be configured:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">action</span> <span class="ss">:write</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">log</span> <span class="s1">&#39;notifer&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">notifies</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">&#39;file[notified]&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then run Chef:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Recipe</span><span class="p">:</span> <span class="ss">notif</span><span class="p">:</span><span class="ss">:default</span>
</span><span class='line'>  <span class="o">*</span> <span class="n">file</span><span class="o">[</span><span class="n">notified</span><span class="o">]</span> <span class="n">action</span> <span class="n">nothing</span> <span class="p">(</span><span class="n">skipped</span> <span class="n">due</span> <span class="n">to</span> <span class="n">action</span> <span class="ss">:nothing</span><span class="p">)</span>
</span><span class='line'>  <span class="o">*</span> <span class="n">notif</span><span class="o">[</span><span class="n">doer</span><span class="o">]</span> <span class="n">action</span> <span class="n">write</span> <span class="p">(</span><span class="n">up</span> <span class="n">to</span> <span class="n">date</span><span class="p">)</span>
</span><span class='line'>  <span class="o">*</span> <span class="n">log</span><span class="o">[</span><span class="n">notifer</span><span class="o">]</span> <span class="n">action</span> <span class="n">write</span>
</span><span class='line'>  <span class="o">*</span> <span class="n">file</span><span class="o">[</span><span class="n">notified</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">update</span> <span class="n">content</span> <span class="k">in</span> <span class="n">file</span> <span class="n">notified</span> <span class="n">from</span> <span class="mi">935</span><span class="n">e8e</span> <span class="n">to</span> <span class="mi">3</span><span class="n">fc9b6</span>
</span><span class='line'>    <span class="o">---</span> <span class="n">notified</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">18</span> <span class="mo">05</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">49</span><span class="o">.</span><span class="mi">186399317</span> <span class="o">+</span><span class="mo">0000</span>
</span><span class='line'>    <span class="o">+++</span> <span class="o">.</span><span class="n">/</span><span class="o">.</span><span class="n">notified20150118</span><span class="o">-</span><span class="mi">16159</span><span class="o">-</span><span class="n">r18q7z</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">18</span> <span class="mo">05</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">57</span><span class="o">.</span><span class="mi">832140405</span> <span class="o">+</span><span class="mo">0000</span>
</span><span class='line'>    <span class="err">@@</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="err">@@</span>
</span><span class='line'>    <span class="o">-</span><span class="n">doer</span>
</span><span class='line'>    <span class="o">+</span><span class="n">something</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that the <code>file[notified]</code> resource wasn&rsquo;t updated at the start of the run, when it was encountered in the recipe, but it was when notified by the log resource in the provider action, changing the content.</p>

<h2>Use inline compile mode!</h2>

<p>The <code>use_inline_resources</code> method in the lightweight provider DSL is strongly recommended. It makes it easier to send notifications from the custom resource itself to other resources in the recipe&rsquo;s resource collection. Read more about the <a href="http://docs.chef.io/lwrp.html#inline-compile-mode">inline compile mode</a> in the Chef docs.</p>

<p>Also, define the resources that you need to notify when you&rsquo;re doing this in your provider&rsquo;s actions. A common example is within a provider that writes configuration for a service, and needs to tell that service to restart.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/12/quick-tip-testing-conditionals-in-chefspec/">Quick Tip: Testing Conditionals in ChefSpec</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-12T14:07:06-07:00" pubdate data-updated="true">Jan 12<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This tip is brought to you by the <a href="https://supermarket.chef.io/cookbooks/homebrew">homebrew</a> cookbook.</p>

<p><a href="http://sethvargo.github.io/chefspec/">ChefSpec</a> is a great way to create tests for Chef recipes to catch regressions. Sometimes recipes end up having branching conditional logic that can have very different outcomes based on external factors &ndash; attributes, existing system state, or cross-platform support.</p>

<p>The homebrew cookbook only supports OS X, so we don&rsquo;t have cross-platform support to test there. However, its default recipe has four conditionals to test. You can read the entire <a href="https://github.com/opscode-cookbooks/homebrew/blob/master/spec/recipes/default_spec.rb">default_spec.rb</a> for full context, I&rsquo;m going to focus on just one aspect here:</p>

<ul>
<li>Installing homebrew should only happen if the <code>brew</code> binary does not exist.</li>
</ul>


<p>This is a common use case in Chef recipes. The best way to go about converging your node to the desired state involves running some arbitrary command. In this case, it&rsquo;s the installation of Homebrew itself. Normally for installations we want to use an idempotent, convergent resource like <code>package</code>. However, since homebrew is to be our package management system, we have to do something else. As it turns out the homebrew project provides an installation script and that script will install a binary, <code>/usr/local/bin/brew</code>. We will assume that if Chef converged on a node after running the script, and the <code>brew</code> binary exists, then we don&rsquo;t need to attempt reinstallation. There&rsquo;s more robust ways to go about it (e.g., running <code>brew</code> gives some desired output), but this works for example purposes today.</p>

<p>From <a href="https://github.com/opscode-cookbooks/homebrew/blob/master/recipes/default.rb">the recipe</a>, here&rsquo;s the resource:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">execute</span> <span class="s1">&#39;install homebrew&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">command</span> <span class="n">homebrew_go</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;homebrew&#39;</span><span class="o">][</span><span class="s1">&#39;owner&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="n">homebrew_owner</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="p">{</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exist?</span> <span class="s1">&#39;/usr/local/bin/brew&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>command</code> is a script, called <code>homebrew_go</code>, which is a local variable set to a path in <code>Chef::Config[:file_cache_path]</code>. It is retrieved in the recipe with <code>remote_file</code>. The resource used to have <code>execute homebrew_go</code>, but when ChefSpec runs, it does so in a random temporary directory, which we cannot predict the name.</p>

<p>The astute observer will note that the <code>user</code> parameter has another conditional (designated by the <code>||</code>). That&rsquo;s actually the subject of another post. In this post, I&rsquo;m concerned only with testing the guard, <code>not_if</code>.</p>

<p>The <code>not_if</code> is a Ruby block, which means the Ruby code is evaluated inline during the Chef run. How we go about testing that is the subject of this post.</p>

<p>First, we need to mock the return result of sending the <code>#exist?</code> method to the <code>File</code> class. There are two reasons. First, we want to control the conditional so we can write a test for each outcome. Second, someone running the test (like me) might have already installed homebrew on their local system (which I have), and so <code>/usr/local/bin/brew</code> will exist. To do this, in our context, we have a <code>before</code> block that stubs the return to false:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">allow_any_instance_of</span><span class="p">(</span><span class="ss">Chef</span><span class="p">:</span><span class="ss">:Resource</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:homebrew_owner</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s1">&#39;vagrant&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">allow_any_instance_of</span><span class="p">(</span><span class="ss">Chef</span><span class="p">:</span><span class="ss">:Recipe</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:homebrew_owner</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s1">&#39;vagrant&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">allow</span><span class="p">(</span><span class="no">File</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:exist?</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span>
</span><span class='line'>  <span class="n">stub_command</span><span class="p">(</span><span class="s1">&#39;which git&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s some other mocked values here. I&rsquo;ll talk about the <code>vagrant</code> user for <code>homebrew_owner</code> in a moment, though again, that&rsquo;s the subject of another post.</p>

<p>The actual spec will test that the installation script will actually get executed when we run chef, and as the <code>vagrant</code> user.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">it</span> <span class="s1">&#39;runs homebrew installation as the default user&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">expect</span><span class="p">(</span><span class="n">chef_run</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">run_execute</span><span class="p">(</span><span class="s1">&#39;install homebrew&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span>
</span><span class='line'>    <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="s1">&#39;vagrant&#39;</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>When rspec runs, we see this is the case:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">homebrew</span><span class="p">:</span><span class="ss">:default</span>
</span><span class='line'>  <span class="n">default</span> <span class="n">user</span>
</span><span class='line'>    <span class="n">runs</span> <span class="n">homebrew</span> <span class="n">installation</span> <span class="n">as</span> <span class="n">the</span> <span class="n">default</span> <span class="n">user</span>
</span></code></pre></td></tr></table></div></figure>


<p>If I didn&rsquo;t mock the user, it would be <code>jtimberman</code>, as that is the user that is running Chef via rspec/ChefSpec. The test would fail. If you&rsquo;re looking at the full file, there&rsquo;s some other details we&rsquo;re going to look at shortly. If I didn&rsquo;t mock the return for <code>File.exist?</code>, the execute wouldn&rsquo;t run at all.</p>

<p>To test what happens when <code>/usr/local/bin/brew</code> exists, I set up a new context in rspec, and create a new <code>before</code> block.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span> <span class="s1">&#39;/usr/local/bin/brew exists&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">allow</span><span class="p">(</span><span class="no">File</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:exist?</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'>    <span class="n">stub_command</span><span class="p">(</span><span class="s1">&#39;which git&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;does not run homebrew installation&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">expect</span><span class="p">(</span><span class="n">chef_run</span><span class="p">)</span><span class="o">.</span><span class="n">to_not</span> <span class="n">run_execute</span><span class="p">(</span><span class="s1">&#39;install homebrew&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We don&rsquo;t need the <code>vagrant</code> mocks earlier, but we do need to stub <code>File.exist?</code>. This test would pass on my system without it, but not on, e.g., a Linux system that doesn&rsquo;t have homebrew.</p>

<p>Then running rspec, we see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">homebrew</span><span class="p">:</span><span class="ss">:default</span>
</span><span class='line'>  <span class="sr">/usr/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">brew</span> <span class="n">exists</span>
</span><span class='line'>    <span class="n">does</span> <span class="ow">not</span> <span class="n">run</span> <span class="n">homebrew</span> <span class="n">installation</span>
</span><span class='line'>  <span class="n">default</span> <span class="n">user</span>
</span><span class='line'>    <span class="n">runs</span> <span class="n">homebrew</span> <span class="n">installation</span> <span class="n">as</span> <span class="n">the</span> <span class="n">default</span> <span class="n">user</span>
</span></code></pre></td></tr></table></div></figure>


<p>In a coming post, I will walk through the conditionals related to the <code>homebrew_owner</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/31/quick-tip-serverspec-spec-helper-in-test-kitchen/">Quick Tip: Serverspec Spec_helper in Test Kitchen</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-31T16:01:23-07:00" pubdate data-updated="true">Dec 31<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently, I&rsquo;ve started refactoring some <a href="https://supermarket.chef.io/cookbooks/daemontools">old</a> <a href="https://supermarket.chef.io/cookbooks/djbdns">cookbooks</a> <a href="https://supermarket.chef.io/cookbooks/ucspi-tcp">I wrote</a> ages ago. I&rsquo;m adding Serverspec coverage that can be run with <code>kitchen verify</code>. In this <a href="/blog/categories/quicktips">quicktip</a>, I&rsquo;ll describe how to create a <code>spec_helper</code> that can be used in all the specs. This is a convention used by <a href="http://pivotallabs.com/spec-helper/">many</a> in the Ruby community to add configuration for RSpec.</p>

<p>For Chef, we can run integration tests after convergence using <a href="http://kitchen.ci">Test Kitchen</a> using Serverspec. To do that, we need to require Serverspec, and then set its backend. In some cookbooks, the author/developer may have written <code>spec_helper</code> files in the various <code>test/integration/SUITE/serverspec/</code> directories, but this will use a single shared file for them all. Let&rsquo;s get started.</p>

<p>In the <code>.kitchen.yml</code>, add the <code>data_path</code> configuration directive in the provisioner.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">provisioner</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chef_zero</span>
</span><span class='line'>  <span class="l-Scalar-Plain">data_path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test/shared</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, create the <code>test/shared</code> directory in the cookbook, and create the <code>spec_helper.rb</code> in it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mkdir <span class="nb">test</span>/shared
</span><span class='line'><span class="nv">$EDITOR</span> <span class="nb">test</span>/shared/spec_helper.rb
</span></code></pre></td></tr></table></div></figure>


<p>Minimally, it should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;serverspec&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:backend</span><span class="p">,</span> <span class="ss">:exec</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then in your specs, for example <code>test/integration/default/serverspec/default_spec.rb</code>, require the <code>spec_helper</code>. On the instances under test, the file will be copied to <code>/tmp/kitchen/data/spec_helper.rb</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">require_relative</span> <span class="s1">&#39;../../../kitchen/data/spec_helper&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it, now when running <code>kitchen test</code>, or <code>kitchen verify</code> on a converged instance, the helper will be used.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/29/chef-12-homebrew-user-mixin/">Quick Tip: Chef 12 Homebrew User Mixin</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-29T08:56:01-07:00" pubdate data-updated="true">Dec 29<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>OS X is an interesting operating system. It is a Unix, but is primarily used for workstations. As such, many system settings can, and should, be done as a non-privileged user. Some tasks, however, require administrative privileges. OS X uses <code>sudo</code> to escalate privileges. This is done by a nice GUI pop-up requesting the user password when done through another GUI element. However, one must use <code>sudo $COMMAND</code> when working at the Terminal.</p>

<p>The <a href="http://brew.sh">Homebrew</a> package manager tries to do everything as a non-privileged user. The <a href="https://raw.githubusercontent.com/Homebrew/install/master/install">installation script</a> will invoke some commands with <code>sudo</code> &ndash; namely to create and set the correct permissions on <code>/usr/local</code> (its default installation location). Once that is complete, <code>brew install</code> will not require privileged access for installing packages. In fact, the <a href="https://github.com/Homebrew/homebrew/blob/b19d3afccef0ddc31820f1cb7d1a5316017e29df/share/doc/homebrew/FAQ.md#why-does-homebrew-say-sudo-is-bad-">Homebrew project recommends</a> never using <code>sudo</code> with the <code>brew</code> commands.</p>

<p>In Chef 12 the default provider for the <code>package</code> resource is <code>homebrew</code>. This originally came from the <a href="https://supermarket.chef.io/cookbooks/homebrew">homebrew cookbook</a>. In order to not use <code>sudo</code> when managing packages, there&rsquo;s a helper method (mixin) that attempts to determine what non-privileged user should run the <code>brew install</code> command. This is also <a href="https://github.com/opscode/chef/blob/4cb27331d81b394b816278e2bed6b3395b54b9c9/lib/chef/mixin/homebrew_user.rb">ported to Chef 12</a>. The method can also take an argument that specifies a particular user that should run the <code>brew</code> command.</p>

<p>When managing an OS X system with Chef, it is often easier to just run <code>chef-client</code> as <code>root</code>, rather than be around when <code>sudo</code> prompts for a password. This means that we need a way to execute other commands for managing OS X as a non-privileged user. We can reuse the mixin to do this. I&rsquo;ll demonstrate this using plain old Ruby with <code>pry</code>, which is installed in ChefDK, and I&rsquo;ll start it up with <code>sudo</code>. Then, I&rsquo;ll show a short recipe with <code>chef-apply</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% which pry
</span><span class='line'>/opt/chefdk/embedded/bin/pry
</span><span class='line'>% sudo pry</span></code></pre></td></tr></table></div></figure>


<p>Paste in the following Ruby code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;chef&#39;</span>
</span><span class='line'><span class="kp">include</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Mixin</span><span class="o">::</span><span class="no">HomebrewUser</span>
</span><span class='line'><span class="kp">include</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Mixin</span><span class="o">::</span><span class="no">ShellOut</span>
</span><span class='line'>
</span><span class='line'><span class="n">find_homebrew_uid</span> <span class="c1">#=&gt; 501</span>
</span></code></pre></td></tr></table></div></figure>


<p>The method <code>find_homebrew_uid</code> is the helper we want. As we can see, rather than returning <code>0</code> (for <code>root</code>), it returns <code>501</code>, which is the UID of the <code>jtimberman</code> user on my system. To prove that I&rsquo;m executing in a process owned by <code>root</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Process</span><span class="o">.</span><span class="n">uid</span> <span class="c1">#=&gt; 0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or, I can shell out to the <code>whoami</code> command using Chef&rsquo;s <code>shell_out</code> method &ndash; which is the same method Chef would use to run <code>brew install</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">shell_out</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span> <span class="c1">#=&gt; &quot;root\n&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>shell_out</code> method can take a <code>:user</code> attribute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">shell_out</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="n">find_homebrew_uid</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span> <span class="c1">#=&gt; &quot;jtimberman\n&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So this can be used to install packages with <code>brew</code>, and is exactly what Chef 12 does.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">shell_out</span><span class="p">(</span><span class="s1">&#39;brew install coreutils&#39;</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="n">find_homebrew_uid</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or, it can be used to run <code>defaults(1)</code> settings that require running as a specific user, rather than <code>root</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Turn off iPhoto face detection, please</span>
</span><span class='line'><span class="n">shell_out</span><span class="p">(</span><span class="s1">&#39;defaults write com.apple.iPhoto PKFaceDetectionEnabled 0&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="n">find_homebrew_uid</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># before...</span>
</span><span class='line'>jtimberman@localhost% defaults <span class="nb">read </span>com.apple.iPhoto PKFaceDetectionEnabled
</span><span class='line'>1
</span><span class='line'><span class="c"># after!</span>
</span><span class='line'>jtimberman@localhost% defaults <span class="nb">read </span>com.apple.iPhoto PKFaceDetectionEnabled
</span><span class='line'>0
</span></code></pre></td></tr></table></div></figure>


<p>Putting this together in a Chef recipe that gets run by <code>root</code>, we can disable face detection in iPhoto like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Chef</span><span class="p">:</span><span class="ss">:Resource</span><span class="o">::</span><span class="no">Execute</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Mixin</span><span class="o">::</span><span class="no">HomebrewUser</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">execute</span> <span class="s1">&#39;defaults write com.apple.iPhoto PKFaceDetectionEnabled 0&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">find_homebrew_uid</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line makes the method available on all <code>execute</code> resources. To make the method available to all resources, use <code>Chef::Resource.send</code>, and to make it available across everything in all recipes, use <code>Chef::Recipe.send</code>. Otherwise we would get a <code>NoMethodError</code> exception.</p>

<p>The <code>execute</code> resource takes a <code>user</code> attribute, so we use the <code>find_homebrew_uid</code> method here to set the user. And we can observe the same results as above:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">jtimberman</span><span class="vi">@localhost</span><span class="o">%</span> <span class="n">defaults</span> <span class="n">write</span> <span class="n">com</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">iPhoto</span> <span class="no">PKFaceDetectionEnabled</span> <span class="mi">1</span>
</span><span class='line'><span class="n">jtimberman</span><span class="vi">@localhost</span><span class="o">%</span> <span class="n">defaults</span> <span class="n">read</span> <span class="n">com</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">iPhoto</span> <span class="no">PKFaceDetectionEnabled</span>
</span><span class='line'><span class="mi">1</span>
</span><span class='line'><span class="n">jtimberman</span><span class="vi">@localhost</span><span class="o">%</span> <span class="n">sudo</span> <span class="n">chef</span><span class="o">-</span><span class="n">apply</span> <span class="n">nofaces</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="ss">Recipe</span><span class="p">:</span> <span class="p">(</span><span class="n">chef</span><span class="o">-</span><span class="n">apply</span> <span class="n">cookbook</span><span class="p">)</span><span class="o">::</span><span class="p">(</span><span class="n">chef</span><span class="o">-</span><span class="n">apply</span> <span class="n">recipe</span><span class="p">)</span>
</span><span class='line'><span class="o">*</span> <span class="n">execute</span><span class="o">[</span><span class="n">defaults</span> <span class="n">write</span> <span class="n">com</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">iPhoto</span> <span class="no">PKFaceDetectionEnabled</span> <span class="mi">0</span><span class="o">]</span> <span class="n">action</span> <span class="n">run</span>
</span><span class='line'><span class="o">-</span> <span class="n">execute</span> <span class="n">defaults</span> <span class="n">write</span> <span class="n">com</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">iPhoto</span> <span class="no">PKFaceDetectionEnabled</span> <span class="mi">0</span>
</span><span class='line'><span class="n">jtimberman</span><span class="vi">@localhost</span><span class="o">%</span> <span class="n">defaults</span> <span class="n">read</span> <span class="n">com</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">iPhoto</span> <span class="no">PKFaceDetectionEnabled</span>
</span><span class='line'><span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those who have read the workstation management posts on this blog in the past may be aware that I have a <a href="https://supermarket.chef.io/cookbooks/mac_os_x">cookbook</a> that can manage OS X &ldquo;<code>defaults(1)</code>&rdquo; settings. I <a href="https://github.com/chef-osx/mac_os_x/issues/21">plan to make updates</a> to the resource in that cookbook that will leverage this method.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/24/quicktip-delete-attributes/">Quick Tip: Deleting Attributes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-24T10:00:40-07:00" pubdate data-updated="true">Dec 24<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have a new goal for 2015, and that is to write at least one &ldquo;Quick Tip&rdquo; per week about Chef. I&rsquo;ve added the category &ldquo;<a href="/blog/categories/quicktips">quicktips</a>&rdquo; to make these easier to find.</p>

<p>In this quick tip, I want to talk about a new feature of Chef 12. The new feature is the ability to remove an attribute from all levels (default, normal, override) on a node so it doesn&rsquo;t get saved back to the Chef Server. This was brought up in <a href="https://github.com/opscode/chef-rfc/blob/master/rfc023-chef-12-attributes-changes.md#global-level-removals">Chef RFC 23</a>. The reason I don&rsquo;t want to save the attribute in question back to the server is that it is a secret that I have in a <a href="https://github.com/Nordstrom/chef-vault">Chef Vault item</a>.</p>

<p>I&rsquo;m using <a href="https://www.datadoghq.com">Datadog</a> for my home systems, and the wonderful folks at Datadog have a <a href="https://supermarket.chef.io/cookbooks/datadog">cookbook</a> to set it up. The documentation requires that you set two attributes to authenticate, the API key, and the application key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Secrets In Plain Text Attributes??&#39;</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;application_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;It is probably fine.&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I prefer to use chef-vault because <a href="http://jtimberman.housepub.org/blog/2013/09/10/managing-secrets-with-chef-vault/">I think it&rsquo;s the best way</a> to manage shared secrets in Chef recipes. I still need to set the attributes for Datadog&rsquo;s recipe to work, however. In order to accomplish the goal here, I will use a custom cookbook, <code>housepub-datadog</code>. It has one recipe that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;chef-vault&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">chef_vault_item</span><span class="p">(</span><span class="ss">:secrets</span><span class="p">,</span> <span class="s1">&#39;datadog&#39;</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;application_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">chef_vault_item</span><span class="p">(</span><span class="ss">:secrets</span><span class="p">,</span> <span class="s1">&#39;datadog&#39;</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">][</span><span class="s1">&#39;chef&#39;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;datadog::dd-agent&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">ruby_block</span> <span class="s1">&#39;smash-datadog-auth-attributes&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">block</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">node</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="s1">&#39;datadog&#39;</span><span class="p">,</span> <span class="s1">&#39;api_key&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">node</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="s1">&#39;datadog&#39;</span><span class="p">,</span> <span class="s1">&#39;application_key&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">subscribes</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">&#39;template[/etc/dd-agent/datadog.conf]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s take a closer look at the recipe.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;chef-vault&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, the <code>chef-vault</code> recipe is included to ensure everything works, and I have a dependency on <code>chef-vault</code> in my cookbook&rsquo;s metadata. Next, we see the attributes set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">chef_vault_item</span><span class="p">(</span><span class="ss">:secrets</span><span class="p">,</span> <span class="s1">&#39;datadog&#39;</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;application_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">chef_vault_item</span><span class="p">(</span><span class="ss">:secrets</span><span class="p">,</span> <span class="s1">&#39;datadog&#39;</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">][</span><span class="s1">&#39;chef&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>secrets/datadog</code> item looks like this in plaintext:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;datadog&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;api_key&quot;</span><span class="p">:</span> <span class="s2">&quot;My datadog API key&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;chef&quot;</span><span class="p">:</span> <span class="s2">&quot;Application key for the &#39;chef&#39; application&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When Chef runs, it will load the vault-encrypted data bag item, and populate the attributes that will be used in the template. This template comes from the <code>datadog::dd-agent</code> recipe, which is included next. The template from that recipe looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">template</span> <span class="s1">&#39;/etc/dd-agent/datadog.conf&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0644</span>
</span><span class='line'>  <span class="n">variables</span><span class="p">(</span>
</span><span class='line'>    <span class="ss">:api_key</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:dd_url</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, for the grand finale of this post, I delete the attributes that were set using a <code>ruby_block</code> resource. The timing here is important, because these attributes must be deleted after Chef has converged the template. This does get updated every run, because the ruby block is not convergent, and this is okay because the attributes are updated every run, too. I could write additional logic to make this convergent, but I&rsquo;m okay with the behavior. The <code>subscribes</code> ensures that as soon as the template is written, the node object is updated to remove the attributes. Otherwise, this happens next after the <code>dd-agent</code> recipe.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ruby_block</span> <span class="s1">&#39;smash-datadog-auth-attributes&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">block</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">node</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="s1">&#39;datadog&#39;</span><span class="p">,</span> <span class="s1">&#39;api_key&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">node</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="s1">&#39;datadog&#39;</span><span class="p">,</span> <span class="s1">&#39;application_key&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">subscribes</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">&#39;template[/etc/dd-agent/datadog.conf]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s see this in action:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">managed</span><span class="o">-</span><span class="n">node</span><span class="err">$</span> <span class="n">chef</span><span class="o">-</span><span class="n">client</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="ss">Recipe</span><span class="p">:</span> <span class="n">housepub</span><span class="o">-</span><span class="ss">datadog</span><span class="p">:</span><span class="ss">:default</span>
</span><span class='line'>  <span class="o">*</span> <span class="n">ruby_block</span><span class="o">[</span><span class="n">smash</span><span class="o">-</span><span class="n">datadog</span><span class="o">-</span><span class="n">auth</span><span class="o">-</span><span class="n">attributes</span><span class="o">]</span> <span class="n">action</span> <span class="n">run</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">ruby</span> <span class="n">block</span> <span class="n">smash</span><span class="o">-</span><span class="n">datadog</span><span class="o">-</span><span class="n">auth</span><span class="o">-</span><span class="n">attributes</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">workstation</span><span class="o">%</span> <span class="n">knife</span> <span class="n">node</span> <span class="n">show</span> <span class="n">managed</span><span class="o">-</span><span class="n">node</span> <span class="o">-</span><span class="n">a</span> <span class="n">datadog</span><span class="o">.</span><span class="n">api_key</span> <span class="o">-</span><span class="n">a</span> <span class="n">datadog</span><span class="o">.</span><span class="n">application_key</span>
</span><span class='line'><span class="n">managed</span><span class="o">-</span><span class="ss">node</span><span class="p">:</span>
</span><span class='line'>  <span class="n">datadog</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
</span><span class='line'>  <span class="n">datadog</span><span class="o">.</span><span class="n">application_key</span><span class="p">:</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Bonus quick tip!</strong> <code>knife node show</code> can take the <code>-a</code> option multiple times to display more attributes. I just discovered this in writing this post, and I don&rsquo;t know when it was added. For sure in Chef 12.0.3, so you should just upgrade anyway ;).</p>

<p><em>Update</em> This <a href="https://github.com/opscode/chef/commit/4133160972a9972a9a062579504faa40eaa4c8db">feature was added</a> by <a href="https://twitter.com/RanjibDey">Awesome Chef Ranjib Dey</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("jtimberman", 3, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/jtimberman" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @jtimberman</a>
  
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/04/03/chef-audit-mode-introduction/">Chef Audit Mode Introduction</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/25/missing-transitive-dependencies/">Missing Transitive Dependencies</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/20/chef-gem-compile-time-compatibility/">Chef Gem Compile Time Compatibility</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/10/awesome-syntax-highlighting-in-keynote/">Awesome Syntax Highlighting in Keynote</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/09/quick-tip-create-a-provisioner-node/">Quick Tip: Create a Provisioner Node</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jtimberman">@jtimberman</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jtimberman',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011-2015 - Joshua Timberman -
  <span class="credit">Powered
  by <a href="http://octopress.org">Octopress</a></span>
  <br /><a rel="license"
  href="http://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
  Commons License" style="border-width:0"
  src="http://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons Attribution-ShareAlike 3.0 United States License</a>.
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jtimberman';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
