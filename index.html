
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>jtimberman's Code Blog</title>
  <meta name="author" content="Joshua Timberman">

  
  <meta name="description" content="OS X is an interesting operating system. It is a Unix, but is primarily used for workstations. As such, many system settings can, and should, be done &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jtimberman.housepub.org">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="jtimberman's Code Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud?source=profiles" />
<link rel="openid2.local_id" href="http://www.google.com/profiles/100567271038100401523" />

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26031299-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">jtimberman's Code Blog</a></h1>
  
    <h2>Chef, Ops, Ruby, Linux/Unix. Opinions are mine, not my employer's (CHEF).</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jtimberman.housepub.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/29/chef-12-homebrew-user-mixin/">Quick Tip: Chef 12 Homebrew User Mixin</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-29T08:56:01-07:00" pubdate data-updated="true">Dec 29<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>OS X is an interesting operating system. It is a Unix, but is primarily used for workstations. As such, many system settings can, and should, be done as a non-privileged user. Some tasks, however, require administrative privileges. OS X uses <code>sudo</code> to escalate privileges. This is done by a nice GUI pop-up requesting the user password when done through another GUI element. However, one must use <code>sudo $COMMAND</code> when working at the Terminal.</p>

<p>The <a href="http://brew.sh">Homebrew</a> package manager tries to do everything as a non-privileged user. The <a href="https://raw.githubusercontent.com/Homebrew/install/master/install">installation script</a> will invoke some commands with <code>sudo</code> &ndash; namely to create and set the correct permissions on <code>/usr/local</code> (its default installation location). Once that is complete, <code>brew install</code> will not require privileged access for installing packages. In fact, the <a href="https://github.com/Homebrew/homebrew/blob/b19d3afccef0ddc31820f1cb7d1a5316017e29df/share/doc/homebrew/FAQ.md#why-does-homebrew-say-sudo-is-bad-">Homebrew project recommends</a> never using <code>sudo</code> with the <code>brew</code> commands.</p>

<p>In Chef 12 the default provider for the <code>package</code> resource is <code>homebrew</code>. This originally came from the <a href="https://supermarket.chef.io/cookbooks/homebrew">homebrew cookbook</a>. In order to not use <code>sudo</code> when managing packages, there&rsquo;s a helper method (mixin) that attempts to determine what non-privileged user should run the <code>brew install</code> command. This is also <a href="https://github.com/opscode/chef/blob/4cb27331d81b394b816278e2bed6b3395b54b9c9/lib/chef/mixin/homebrew_user.rb">ported to Chef 12</a>. The method can also take an argument that specifies a particular user that should run the <code>brew</code> command.</p>

<p>When managing an OS X system with Chef, it is often easier to just run <code>chef-client</code> as <code>root</code>, rather than be around when <code>sudo</code> prompts for a password. This means that we need a way to execute other commands for managing OS X as a non-privileged user. We can reuse the mixin to do this. I&rsquo;ll demonstrate this using plain old Ruby with <code>pry</code>, which is installed in ChefDK, and I&rsquo;ll start it up with <code>sudo</code>. Then, I&rsquo;ll show a short recipe with <code>chef-apply</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% which pry
</span><span class='line'>/opt/chefdk/embedded/bin/pry
</span><span class='line'>% sudo pry</span></code></pre></td></tr></table></div></figure>


<p>Paste in the following Ruby code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;chef&#39;</span>
</span><span class='line'><span class="kp">include</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Mixin</span><span class="o">::</span><span class="no">HomebrewUser</span>
</span><span class='line'><span class="kp">include</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Mixin</span><span class="o">::</span><span class="no">ShellOut</span>
</span><span class='line'>
</span><span class='line'><span class="n">find_homebrew_uid</span> <span class="c1">#=&gt; 501</span>
</span></code></pre></td></tr></table></div></figure>


<p>The method <code>find_homebrew_uid</code> is the helper we want. As we can see, rather than returning <code>0</code> (for <code>root</code>), it returns <code>501</code>, which is the UID of the <code>jtimberman</code> user on my system. To prove that I&rsquo;m executing in a process owned by <code>root</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Process</span><span class="o">.</span><span class="n">uid</span> <span class="c1">#=&gt; 0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or, I can shell out to the <code>whoami</code> command using Chef&rsquo;s <code>shell_out</code> method &ndash; which is the same method Chef would use to run <code>brew install</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">shell_out</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span> <span class="c1">#=&gt; &quot;root\n&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>shell_out</code> method can take a <code>:user</code> attribute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">shell_out</span><span class="p">(</span><span class="s1">&#39;whoami&#39;</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="n">find_homebrew_uid</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span> <span class="c1">#=&gt; &quot;jtimberman\n&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So this can be used to install packages with <code>brew</code>, and is exactly what Chef 12 does.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">shell_out</span><span class="p">(</span><span class="s1">&#39;brew install coreutils&#39;</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="n">find_homebrew_uid</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or, it can be used to run <code>defaults(1)</code> settings that require running as a specific user, rather than <code>root</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Turn off iPhoto face detection, please</span>
</span><span class='line'><span class="n">shell_out</span><span class="p">(</span><span class="s1">&#39;defaults write com.apple.iPhoto PKFaceDetectionEnabled 0&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="n">find_homebrew_uid</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># before...</span>
</span><span class='line'>jtimberman@localhost% defaults <span class="nb">read </span>com.apple.iPhoto PKFaceDetectionEnabled
</span><span class='line'>1
</span><span class='line'><span class="c"># after!</span>
</span><span class='line'>jtimberman@localhost% defaults <span class="nb">read </span>com.apple.iPhoto PKFaceDetectionEnabled
</span><span class='line'>0
</span></code></pre></td></tr></table></div></figure>


<p>Putting this together in a Chef recipe that gets run by <code>root</code>, we can disable face detection in iPhoto like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Chef</span><span class="p">:</span><span class="ss">:Resource</span><span class="o">::</span><span class="no">Execute</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Mixin</span><span class="o">::</span><span class="no">HomebrewUser</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">execute</span> <span class="s1">&#39;defaults write com.apple.iPhoto PKFaceDetectionEnabled 0&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">user</span> <span class="n">find_homebrew_uid</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line makes the method available on all <code>execute</code> resources. To make the method available to all resources, use <code>Chef::Resource.send</code>, and to make it available across everything in all recipes, use <code>Chef::Recipe.send</code>. Otherwise we would get a <code>NoMethodError</code> exception.</p>

<p>The <code>execute</code> resource takes a <code>user</code> attribute, so we use the <code>find_homebrew_uid</code> method here to set the user. And we can observe the same results as above:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">jtimberman</span><span class="vi">@localhost</span><span class="o">%</span> <span class="n">defaults</span> <span class="n">write</span> <span class="n">com</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">iPhoto</span> <span class="no">PKFaceDetectionEnabled</span> <span class="mi">1</span>
</span><span class='line'><span class="n">jtimberman</span><span class="vi">@localhost</span><span class="o">%</span> <span class="n">defaults</span> <span class="n">read</span> <span class="n">com</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">iPhoto</span> <span class="no">PKFaceDetectionEnabled</span>
</span><span class='line'><span class="mi">1</span>
</span><span class='line'><span class="n">jtimberman</span><span class="vi">@localhost</span><span class="o">%</span> <span class="n">sudo</span> <span class="n">chef</span><span class="o">-</span><span class="n">apply</span> <span class="n">nofaces</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'><span class="ss">Recipe</span><span class="p">:</span> <span class="p">(</span><span class="n">chef</span><span class="o">-</span><span class="n">apply</span> <span class="n">cookbook</span><span class="p">)</span><span class="o">::</span><span class="p">(</span><span class="n">chef</span><span class="o">-</span><span class="n">apply</span> <span class="n">recipe</span><span class="p">)</span>
</span><span class='line'><span class="o">*</span> <span class="n">execute</span><span class="o">[</span><span class="n">defaults</span> <span class="n">write</span> <span class="n">com</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">iPhoto</span> <span class="no">PKFaceDetectionEnabled</span> <span class="mi">0</span><span class="o">]</span> <span class="n">action</span> <span class="n">run</span>
</span><span class='line'><span class="o">-</span> <span class="n">execute</span> <span class="n">defaults</span> <span class="n">write</span> <span class="n">com</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">iPhoto</span> <span class="no">PKFaceDetectionEnabled</span> <span class="mi">0</span>
</span><span class='line'><span class="n">jtimberman</span><span class="vi">@localhost</span><span class="o">%</span> <span class="n">defaults</span> <span class="n">read</span> <span class="n">com</span><span class="o">.</span><span class="n">apple</span><span class="o">.</span><span class="n">iPhoto</span> <span class="no">PKFaceDetectionEnabled</span>
</span><span class='line'><span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those who have read the workstation management posts on this blog in the past may be aware that I have a <a href="https://supermarket.chef.io/cookbooks/mac_os_x">cookbook</a> that can manage OS X &ldquo;<code>defaults(1)</code>&rdquo; settings. I <a href="https://github.com/chef-osx/mac_os_x/issues/21">plan to make updates</a> to the resource in that cookbook that will leverage this method.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/24/quicktip-delete-attributes/">Quick Tip: Deleting Attributes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-24T10:00:40-07:00" pubdate data-updated="true">Dec 24<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have a new goal for 2015, and that is to write at least one &ldquo;Quick Tip&rdquo; per week about Chef. I&rsquo;ve added the category &ldquo;<a href="/blog/categories/quicktips">quicktips</a>&rdquo; to make these easier to find.</p>

<p>In this quick tip, I want to talk about a new feature of Chef 12. The new feature is the ability to remove an attribute from all levels (default, normal, override) on a node so it doesn&rsquo;t get saved back to the Chef Server. This was brought up in <a href="https://github.com/opscode/chef-rfc/blob/master/rfc023-chef-12-attributes-changes.md#global-level-removals">Chef RFC 23</a>. The reason I don&rsquo;t want to save the attribute in question back to the server is that it is a secret that I have in a <a href="https://github.com/Nordstrom/chef-vault">Chef Vault item</a>.</p>

<p>I&rsquo;m using <a href="https://www.datadoghq.com">Datadog</a> for my home systems, and the wonderful folks at Datadog have a <a href="https://supermarket.chef.io/cookbooks/datadog">cookbook</a> to set it up. The documentation requires that you set two attributes to authenticate, the API key, and the application key:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;Secrets In Plain Text Attributes??&#39;</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;application_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;It is probably fine.&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I prefer to use chef-vault because <a href="http://jtimberman.housepub.org/blog/2013/09/10/managing-secrets-with-chef-vault/">I think it&rsquo;s the best way</a> to manage shared secrets in Chef recipes. I still need to set the attributes for Datadog&rsquo;s recipe to work, however. In order to accomplish the goal here, I will use a custom cookbook, <code>housepub-datadog</code>. It has one recipe that looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;chef-vault&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">chef_vault_item</span><span class="p">(</span><span class="ss">:secrets</span><span class="p">,</span> <span class="s1">&#39;datadog&#39;</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;application_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">chef_vault_item</span><span class="p">(</span><span class="ss">:secrets</span><span class="p">,</span> <span class="s1">&#39;datadog&#39;</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">][</span><span class="s1">&#39;chef&#39;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;datadog::dd-agent&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">ruby_block</span> <span class="s1">&#39;smash-datadog-auth-attributes&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">block</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">node</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="s1">&#39;datadog&#39;</span><span class="p">,</span> <span class="s1">&#39;api_key&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">node</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="s1">&#39;datadog&#39;</span><span class="p">,</span> <span class="s1">&#39;application_key&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">subscribes</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">&#39;template[/etc/dd-agent/datadog.conf]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s take a closer look at the recipe.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;chef-vault&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, the <code>chef-vault</code> recipe is included to ensure everything works, and I have a dependency on <code>chef-vault</code> in my cookbook&rsquo;s metadata. Next, we see the attributes set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">chef_vault_item</span><span class="p">(</span><span class="ss">:secrets</span><span class="p">,</span> <span class="s1">&#39;datadog&#39;</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;application_key&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">chef_vault_item</span><span class="p">(</span><span class="ss">:secrets</span><span class="p">,</span> <span class="s1">&#39;datadog&#39;</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">][</span><span class="s1">&#39;chef&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>secrets/datadog</code> item looks like this in plaintext:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;datadog&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;api_key&quot;</span><span class="p">:</span> <span class="s2">&quot;My datadog API key&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;chef&quot;</span><span class="p">:</span> <span class="s2">&quot;Application key for the &#39;chef&#39; application&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When Chef runs, it will load the vault-encrypted data bag item, and populate the attributes that will be used in the template. This template comes from the <code>datadog::dd-agent</code> recipe, which is included next. The template from that recipe looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">template</span> <span class="s1">&#39;/etc/dd-agent/datadog.conf&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0644</span>
</span><span class='line'>  <span class="n">variables</span><span class="p">(</span>
</span><span class='line'>    <span class="ss">:api_key</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;api_key&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:dd_url</span> <span class="o">=&gt;</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;datadog&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, for the grand finale of this post, I delete the attributes that were set using a <code>ruby_block</code> resource. The timing here is important, because these attributes must be deleted after Chef has converged the template. This does get updated every run, because the ruby block is not convergent, and this is okay because the attributes are updated every run, too. I could write additional logic to make this convergent, but I&rsquo;m okay with the behavior. The <code>subscribes</code> ensures that as soon as the template is written, the node object is updated to remove the attributes. Otherwise, this happens next after the <code>dd-agent</code> recipe.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">ruby_block</span> <span class="s1">&#39;smash-datadog-auth-attributes&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">block</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">node</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="s1">&#39;datadog&#39;</span><span class="p">,</span> <span class="s1">&#39;api_key&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">node</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="s1">&#39;datadog&#39;</span><span class="p">,</span> <span class="s1">&#39;application_key&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">subscribes</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">&#39;template[/etc/dd-agent/datadog.conf]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s see this in action:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">managed</span><span class="o">-</span><span class="n">node</span><span class="err">$</span> <span class="n">chef</span><span class="o">-</span><span class="n">client</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="ss">Recipe</span><span class="p">:</span> <span class="n">housepub</span><span class="o">-</span><span class="ss">datadog</span><span class="p">:</span><span class="ss">:default</span>
</span><span class='line'>  <span class="o">*</span> <span class="n">ruby_block</span><span class="o">[</span><span class="n">smash</span><span class="o">-</span><span class="n">datadog</span><span class="o">-</span><span class="n">auth</span><span class="o">-</span><span class="n">attributes</span><span class="o">]</span> <span class="n">action</span> <span class="n">run</span>
</span><span class='line'>    <span class="o">-</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">ruby</span> <span class="n">block</span> <span class="n">smash</span><span class="o">-</span><span class="n">datadog</span><span class="o">-</span><span class="n">auth</span><span class="o">-</span><span class="n">attributes</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="n">workstation</span><span class="o">%</span> <span class="n">knife</span> <span class="n">node</span> <span class="n">show</span> <span class="n">managed</span><span class="o">-</span><span class="n">node</span> <span class="o">-</span><span class="n">a</span> <span class="n">datadog</span><span class="o">.</span><span class="n">api_key</span> <span class="o">-</span><span class="n">a</span> <span class="n">datadog</span><span class="o">.</span><span class="n">application_key</span>
</span><span class='line'><span class="n">managed</span><span class="o">-</span><span class="ss">node</span><span class="p">:</span>
</span><span class='line'>  <span class="n">datadog</span><span class="o">.</span><span class="n">api_key</span><span class="p">:</span>
</span><span class='line'>  <span class="n">datadog</span><span class="o">.</span><span class="n">application_key</span><span class="p">:</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Bonus quick tip!</strong> <code>knife node show</code> can take the <code>-a</code> option multiple times to display more attributes. I just discovered this in writing this post, and I don&rsquo;t know when it was added. For sure in Chef 12.0.3, so you should just upgrade anyway ;).</p>

<p><em>Update</em> This <a href="https://github.com/opscode/chef/commit/4133160972a9972a9a062579504faa40eaa4c8db">feature was added</a> by <a href="https://twitter.com/RanjibDey">Awesome Chef Ranjib Dey</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/11/chef-12-fix-untrusted-self-sign-certs/">Chef 12: Fix Untrusted Self Sign Certs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-11T13:42:41-07:00" pubdate data-updated="true">Dec 11<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Scenario: You&rsquo;ve started up a brand new Chef Server using version 12, and you have installed Chef 12 on your local system. You log into the Management Console to create a user and organization (or do this with the command-line <code>chef-server-ctl</code> commands), and you&rsquo;re ready to rock with this knife.rb:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">node_name</span>                <span class="s1">&#39;jtimberman&#39;</span>
</span><span class='line'><span class="n">client_key</span>               <span class="s1">&#39;jtimberman.pem&#39;</span>
</span><span class='line'><span class="n">validation_client_name</span>   <span class="s1">&#39;tester-validator&#39;</span>
</span><span class='line'><span class="n">validation_key</span>           <span class="s1">&#39;tester-validator.pem&#39;</span>
</span><span class='line'><span class="n">chef_server_url</span>          <span class="s1">&#39;https://chef-server.example.com/organizations/tester&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, when you try to check things out with knife:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">% knife </span><span class="n">client</span> <span class="n">list</span>
</span><span class='line'><span class="ss">ERROR</span><span class="p">:</span> <span class="no">SSL</span> <span class="no">Validation</span> <span class="n">failure</span> <span class="n">connecting</span> <span class="n">to</span> <span class="ss">host</span><span class="p">:</span> <span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span> <span class="no">SSL_connect</span> <span class="n">returned</span><span class="o">=</span><span class="mi">1</span> <span class="n">errno</span><span class="o">=</span><span class="mi">0</span> <span class="n">state</span><span class="o">=</span><span class="no">SSLv3</span> <span class="n">read</span> <span class="n">server</span> <span class="n">certificate</span> <span class="ss">B</span><span class="p">:</span> <span class="n">certificate</span> <span class="n">verify</span> <span class="n">failed</span>
</span><span class='line'><span class="ss">ERROR</span><span class="p">:</span> <span class="ss">OpenSSL</span><span class="p">:</span><span class="ss">:SSL</span><span class="o">::</span><span class="ss">SSLError</span><span class="p">:</span> <span class="no">SSL_connect</span> <span class="n">returned</span><span class="o">=</span><span class="mi">1</span> <span class="n">errno</span><span class="o">=</span><span class="mi">0</span> <span class="n">state</span><span class="o">=</span><span class="no">SSLv3</span> <span class="n">read</span> <span class="n">server</span> <span class="n">certificate</span> <span class="ss">B</span><span class="p">:</span> <span class="n">certificate</span> <span class="n">verify</span> <span class="n">failed</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is because Chef client 12 has SSL verification enabled by default for all requests. Since the certificate generated by the Chef Server 12 installation is self-signed, there isn&rsquo;t a signing CA that can be verified, and this fails. Never fear intrepid user, for you can get the SSL certificate from the server and store it as a &ldquo;trusted&rdquo; certificate. To find out how, use <code>knife ssl check</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Connecting</span> <span class="n">to</span> <span class="n">host</span> <span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">443</span>
</span><span class='line'><span class="ss">ERROR</span><span class="p">:</span> <span class="no">The</span> <span class="no">SSL</span> <span class="n">certificate</span> <span class="n">of</span> <span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="n">could</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">verified</span>
</span><span class='line'><span class="no">Certificate</span> <span class="n">issuer</span> <span class="ss">data</span><span class="p">:</span> <span class="sr">/C=US/</span><span class="no">ST</span><span class="o">=</span><span class="no">WA</span><span class="o">/</span><span class="n">L</span><span class="o">=</span><span class="no">Seattle</span><span class="o">/</span><span class="n">O</span><span class="o">=</span><span class="no">YouCorp</span><span class="o">/</span><span class="no">OU</span><span class="o">=</span><span class="no">Operations</span><span class="o">/</span><span class="no">CN</span><span class="o">=</span><span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">emailAddress</span><span class="o">=</span><span class="n">you</span><span class="vi">@example</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'>
</span><span class='line'><span class="no">Configuration</span> <span class="ss">Info</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="no">OpenSSL</span> <span class="ss">Configuration</span><span class="p">:</span>
</span><span class='line'><span class="o">*</span> <span class="ss">Version</span><span class="p">:</span> <span class="no">OpenSSL</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="n">j</span> <span class="mi">15</span> <span class="no">Oct</span> <span class="mi">2014</span>
</span><span class='line'><span class="o">*</span> <span class="no">Certificate</span> <span class="ss">file</span><span class="p">:</span> <span class="sr">/opt/</span><span class="n">chefdk</span><span class="o">/</span><span class="n">embedded</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">cert</span><span class="o">.</span><span class="n">pem</span>
</span><span class='line'><span class="o">*</span> <span class="no">Certificate</span> <span class="ss">directory</span><span class="p">:</span> <span class="sr">/opt/</span><span class="n">chefdk</span><span class="o">/</span><span class="n">embedded</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span>
</span><span class='line'><span class="no">Chef</span> <span class="no">SSL</span> <span class="ss">Configuration</span><span class="p">:</span>
</span><span class='line'><span class="o">*</span> <span class="n">ssl_ca_path</span><span class="p">:</span> <span class="kp">nil</span>
</span><span class='line'><span class="o">*</span> <span class="n">ssl_ca_file</span><span class="p">:</span> <span class="kp">nil</span>
</span><span class='line'><span class="o">*</span> <span class="n">trusted_certs_dir</span><span class="p">:</span> <span class="s2">&quot;/Users/jtimberman/Downloads/chef-repo/.chef/trusted_certs&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">TO</span> <span class="no">FIX</span> <span class="no">THIS</span> <span class="ss">ERROR</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="no">If</span> <span class="n">the</span> <span class="n">server</span> <span class="n">you</span> <span class="n">are</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">uses</span> <span class="n">a</span> <span class="nb">self</span><span class="o">-</span><span class="n">signed</span> <span class="n">certificate</span><span class="p">,</span> <span class="n">you</span> <span class="n">must</span>
</span><span class='line'><span class="n">configure</span> <span class="n">chef</span> <span class="n">to</span> <span class="n">trust</span> <span class="n">that</span> <span class="n">server</span><span class="s1">&#39;s certificate.</span>
</span><span class='line'>
</span><span class='line'><span class="s1">By default, the certificate is stored in the following location on the host</span>
</span><span class='line'><span class="s1">where your chef-server runs:</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  /var/opt/chef-server/nginx/ca/SERVER_HOSTNAME.crt</span>
</span><span class='line'>
</span><span class='line'><span class="s1">Copy that file to your trusted_certs_dir (currently: /Users/jtimberman/Downloads/chef-repo/.chef/trusted_certs)</span>
</span><span class='line'><span class="s1">using SSH/SCP or some other secure method, then re-run this command to confirm</span>
</span><span class='line'><span class="s1">that the server&#39;</span><span class="n">s</span> <span class="n">certificate</span> <span class="n">is</span> <span class="n">now</span> <span class="n">trusted</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>(note, <a href="https://github.com/opscode/chef/issues/2604">this chef-server location is incorrect</a>, it&rsquo;s <code>/var/opt/opscode</code>)</p>

<p>There is a <code>fetch</code> plugin for <code>knife</code> too. Let&rsquo;s download the certificate to the automatically preconfigured trusted certificate location mentioned in the output above.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">% knife </span><span class="n">ssl</span> <span class="n">fetch</span>
</span><span class='line'><span class="ss">WARNING</span><span class="p">:</span> <span class="no">Certificates</span> <span class="n">from</span> <span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="n">will</span> <span class="n">be</span> <span class="n">fetched</span> <span class="ow">and</span> <span class="n">placed</span> <span class="k">in</span> <span class="n">your</span> <span class="n">trusted_cert</span>
</span><span class='line'><span class="n">directory</span> <span class="p">(</span><span class="sr">/Users/</span><span class="n">jtimberman</span><span class="o">/</span><span class="no">Downloads</span><span class="o">/</span><span class="n">chef</span><span class="o">-</span><span class="n">repo</span><span class="o">/.</span><span class="n">chef</span><span class="o">/</span><span class="n">trusted_certs</span><span class="p">)</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="no">Knife</span> <span class="n">has</span> <span class="n">no</span> <span class="n">means</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">these</span> <span class="n">are</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">certificates</span><span class="o">.</span> <span class="no">You</span> <span class="n">should</span>
</span><span class='line'><span class="n">verify</span> <span class="n">the</span> <span class="n">authenticity</span> <span class="n">of</span> <span class="n">these</span> <span class="n">certificates</span> <span class="n">after</span> <span class="n">downloading</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="no">Adding</span> <span class="n">certificate</span> <span class="k">for</span> <span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="k">in</span> <span class="sr">/Users/</span><span class="n">jtimberman</span><span class="o">/</span><span class="no">Downloads</span><span class="o">/</span><span class="n">chef</span><span class="o">-</span><span class="n">repo</span><span class="o">/.</span><span class="n">chef</span><span class="o">/</span><span class="n">trusted_certs</span><span class="o">/</span><span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">crt</span>
</span></code></pre></td></tr></table></div></figure>


<p>The certificate should be verified that what was downloaded is in fact the same as the certificate on the Chef Server. For example, I compared SHA256 checksums:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">% ssh </span><span class="n">ubuntu</span><span class="vi">@chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="n">sudo</span> <span class="n">sha256sum</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">opscode</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">crt</span>
</span><span class='line'><span class="mo">04372</span><span class="mi">8</span><span class="n">b55144861ed43a426c67addca357a5889158886aee50685cf1422b5ebf</span>  <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">opscode</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">ca</span><span class="o">/</span><span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">crt</span>
</span><span class='line'><span class="sx">% gsha256sum </span><span class="o">.</span><span class="n">chef</span><span class="o">/</span><span class="n">trusted_certs</span><span class="o">/</span><span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">crt</span>
</span><span class='line'><span class="mo">04372</span><span class="mi">8</span><span class="n">b55144861ed43a426c67addca357a5889158886aee50685cf1422b5ebf</span>  <span class="o">.</span><span class="n">chef</span><span class="o">/</span><span class="n">trusted_certs</span><span class="o">/</span><span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">crt</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now check knife client list again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">% knife </span><span class="n">client</span> <span class="n">list</span>
</span><span class='line'><span class="n">tester</span><span class="o">-</span><span class="n">validator</span>
</span></code></pre></td></tr></table></div></figure>


<p>Victory!</p>

<p>Now, we need to get the ceritficate out to every node in the infrastructure in its <code>trusted_certs_dir</code> &ndash; by default this is <code>/etc/chef/trusted_certs</code>. The most simple way to do this is to use <code>knife ssh</code> to run knife on the target nodes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">% knife </span><span class="n">ssh</span> <span class="s1">&#39;name:*&#39;</span> <span class="s1">&#39;sudo knife ssl fetch -c /etc/chef/client.rb&#39;</span>
</span><span class='line'><span class="n">node</span><span class="o">-</span><span class="n">output</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="ss">WARNING</span><span class="p">:</span> <span class="no">Certificates</span> <span class="n">from</span> <span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="n">will</span> <span class="n">be</span> <span class="n">fetched</span> <span class="ow">and</span> <span class="n">placed</span> <span class="k">in</span> <span class="n">your</span> <span class="n">trusted_cert</span>
</span><span class='line'><span class="n">node</span><span class="o">-</span><span class="n">output</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="n">directory</span> <span class="p">(</span><span class="sr">/etc/</span><span class="n">chef</span><span class="o">/</span><span class="n">trusted_certs</span><span class="p">)</span><span class="o">.</span>
</span><span class='line'><span class="n">node</span><span class="o">-</span><span class="n">output</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'><span class="n">node</span><span class="o">-</span><span class="n">output</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="no">Knife</span> <span class="n">has</span> <span class="n">no</span> <span class="n">means</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">these</span> <span class="n">are</span> <span class="n">the</span> <span class="n">correct</span> <span class="n">certificates</span><span class="o">.</span> <span class="no">You</span> <span class="n">should</span>
</span><span class='line'><span class="n">node</span><span class="o">-</span><span class="n">output</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="n">verify</span> <span class="n">the</span> <span class="n">authenticity</span> <span class="n">of</span> <span class="n">these</span> <span class="n">certificates</span> <span class="n">after</span> <span class="n">downloading</span><span class="o">.</span>
</span><span class='line'><span class="n">node</span><span class="o">-</span><span class="n">output</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'><span class="n">node</span><span class="o">-</span><span class="n">output</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="no">Adding</span> <span class="n">certificate</span> <span class="k">for</span> <span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="k">in</span> <span class="sr">/etc/</span><span class="n">chef</span><span class="o">/</span><span class="n">trusted_certs</span><span class="o">/</span><span class="n">chef</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">crt</span>
</span></code></pre></td></tr></table></div></figure>


<p>The output will be interleaved for all the nodes returned by <code>knife ssh</code>. Of course, we should verify the SHA256 checksums like before, which can be done again with <code>knife ssh</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/07/reflecting-on-six-years-with-chef/">Reflecting on Six Years With Chef</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-07T11:36:43-06:00" pubdate data-updated="true">Oct 7<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It actually started a bit over seven years ago. I saw the writing on the wall at IBM; my job was soon to be outsourced. I found an open position with the SANS institute, accepted an offer there, and was due to start work in a couple of weeks. Around the same time, my friends Adam Jacob and Nathan Haneysmith had started HJK Solutions. They invited me to join them then, but it wasn&rsquo;t the right time for me. Adam told me that at SANS I should at least use the <a href="https://puppetlabs.com">automation</a> <a href="http://capistranorb.com/">tools</a> and general <a href="http://infrastructures.org">infrastructure management model</a> they planned to use. It turned out this was sage advice, for a number of reasons.</p>

<p>Around April, 2008, Adam told me he was working on &ldquo;Chef,&rdquo; a Ruby based configuration management and system integration framework. I was excited about its potential, and a few months later on July 2, 2008, I started with HJK Solutions as a Linux system administration consultant. I got familiar with HJK&rsquo;s puppet-based stack, and ancillary Ruby tools like <a href="https://github.com/adamhjk/iclassify/wiki">iClassify</a> while working on their customer infrastructures over the coming months. After Opscode was founded and we released Chef 0.5, my primary focus was porting HJK&rsquo;s puppet modules to <a href="https://github.com/opscode/cookbooks">chef cookbooks</a>.</p>

<h2>opscode/cookbooks</h2>

<p>Adam had started the repository to give new users a place to begin using Chef with full working examples. I continued their development, and had the opportunity to solve hard problems of integration web application stacks with them. There were three important reasons for the repository to exist:</p>

<ol>
<li>We have a body of knowledge as a tribe, and that can be codified.</li>
<li>Infrastructure as code is real, and it <em>can</em> be reusable.</li>
<li>The best way to learn Chef is to use Chef, and I had a goal to know Chef well enough to teach it to new users and companies.</li>
</ol>


<p>The development of general purpose cookbooks ends up being harder than any of us really imagined, I think. Every platform is different, so not only did I have to learn Chef, I had to learn how different platforms behave for common (and uncommon) pieces of software in web operations stacks. Over the years of managing these cookbooks, I learned a lot about how the community was developing workflows for using Chef, and how they differed from our opinions. I learned also learned how to manage and contribute to open source projects at a rather large scale, and how to have compassion and empathy for new or frustrated users.</p>

<h2>Training and Services</h2>

<p>In my time at CHEF, nee Opscode, I&rsquo;ve had several job role changes. After several months of working on cookbooks, I added package and release management (<a href="http://lists.opscode.com/sympa/arc/chef/2014-11/msg00015.html">RIP, apt.opscode.com</a>) to my repertoire. I then switched to technical evangelism and training. With mentorship from <a href="http://twitter.com/botchagalupe">John Willis</a>, I drafted the initial version of <a href="https://www.getchef.com/blog/2010/07/13/open-source-chef-training-open-training/">Chef Fundamentals</a>, and delivered our inaugural training class in Seattle.</p>

<p>I worked with the team John built to deliver training, speak at conferences, and work directly with customers to help make them successful with Chef. Eventually, John left the company to <a href="http://www.enstratius.com/news-events/press-releases/john-willis-announcement">build an awesome team</a> at <a href="http://www.enstratius.com/home">Enstratius</a>. I took on the role of Director of the team, but eventually I discovered that the <a href="http://fractio.nl/2014/09/19/not-a-promotion-a-career-change/">management track</a> was not the future of my career.</p>

<h2>Open Source and Community</h2>

<p>I came back to working on the cookbooks, which I had previously <a href="https://github.com/opscode-cookbooks">split into separate repositories</a>. I was also working more directly in the community, doing public training classes only (our consulting team did private/onsite classes), participating in our <a href="https://botbot.me/freenode/chef">IRC channels</a> and mailing <a href="http://lists.opscode.com">lists</a>. We had some organization churn, and I was moved around between four different managers, eventually reporting to <a href="https://twitter.com/nathenharvey">the inimitable Nathen Harvey</a>.</p>

<p>During one of our 1-1 discussions, he said, &ldquo;You know, Joshua. You write a lot of cookbooks to automate infrastructure. But you haven&rsquo;t actually worked on any infrastructure in years. You should do something about that.&rdquo;</p>

<p>Around that time, there was a &ldquo;senior system administrator&rdquo; job posting on our very own careers site. I talked to our VP of Operations, and after a brief transition period, moved completely over to the ops team. I was able to bring with me the great practices from the community for developing cookbooks: testing with <a href="http://sethvargo.github.io/chefspec/">chefspec</a> and <a href="http://serverspec.org/">serverspec</a>, code consistency with <a href="">rubocop</a> and <a href="http://foodcritic.io">foodcritic</a>, and wrapping it all up with <a href="http://kitchen.ci">test kitchen</a>.</p>

<h2>The Future</h2>

<p>I&rsquo;ve had the privilege to do work that I love, which is automating hard problems using Chef. I&rsquo;ve also had the privilege of being part of the web operations, infrastructure as code, devops, and Chef communities over the past six years. I&rsquo;ve been to all four Chef summits, and all three ChefConfs. A thing I&rsquo;ve noticed over the years is that many conversations keep coming up at the summits and ChefConf. Fresh on my mind because the last summit was so recent is the topic of cookbook reusability. See, during the time that I managed opscode/cookbooks, I eventually saw the point people in the community were making about these being real software repositories that need to be managed like other complex software projects. We split up the repository into individual repositories per cookbook. We started adding test coverage, and conforming to consistency via syntax and style lint checking. That didn&rsquo;t make cookboks more reusable, but it lowered the barrier of contribution, which in turn made them more reusable as more use cases could be covered. I got to be a part of that evolution, and it&rsquo;s been awesome.</p>

<p>While using Chef is one of my favorite technical things to do, I have come to the conclusion that based on my experience the best thing I can do is be a facilitator of stronger technical discipline with regard to using Chef. Primarily, this means improving how CHEF uses Chef to build Chef for our community and customers. We&rsquo;re already really good at using Chef to build Chef (the product), and run Hosted Chef (the service). However, awesome tools from the community such as Test Kitchen, Berkshelf, ChefSpec, and Foodcritic did not exist when we started out. Between new, awesome tools, and growing our organization with new awesome people, we need to improve on getting our team members up to speed on the process and workflow that helps us deliver higher quality products.</p>

<p>That is why I&rsquo;m moving into a new role at CHEF. The sixth year marks as good a time as any to make a change, and I&rsquo;m no stranger to that. I&rsquo;m joining a team of quality advocacy led by Joseph Smith, as part of Jez Humble&rsquo;s &ldquo;Office of Continuous Improvement and Velocity.&rdquo; In this new role, I will focus on improving our overall technical excellence so we can deliver better products to our community and customers, and so we can have awesome use cases and examples for managing Chef Server and its add-ons at scale.</p>

<p>My first short term goal in this new role is a workstation automation cookbook that can be used and extended by our internal teams for ensuring everyone has a consistent set of tools to work on the product. This will be made an open source project that the community can use and extend as well. We&rsquo;ll have more information about this as it becomes &ldquo;a thing.&rdquo;</p>

<p>Next, I want to improve how we work on incidents. We&rsquo;ve had sporadic blog posts about issues in Hosted Chef and Supermarket, and I&rsquo;d like to see this get better.</p>

<p>I&rsquo;m also interested in managing Chef Server 12 clusters, including all the add-ons. Recently I worked on the <a href="https://github.com/opscode-cookbooks/chef-server-cluster">chef-server-cluster</a> cookbook, which will become the way CHEF deploys and manages Hosted Chef using the version 12 packages. Part of the earliest days of opscode/cookbooks, I maintained cookbooks to setup the open source Chef Server. Long time users may remember the &ldquo;chef solo bootstrap&rdquo; stack. Since then, CHEF has continued to iterate on that idea, and the &ldquo;ctl&rdquo; management commands largely use chef-solo under the hood. The new cookbook combines and wraps up manual processes and the &ldquo;ctl&rdquo; commands to enable us, our community, and our customers to build scalable Chef Server clusters using the omnibus packages. The cookbook uses chef-provisioning to do much of the heavy lifting.</p>

<p>It should be easy for organizations to be successful with Chef. That includes CHEF! My goal in my new position is to fuel the love of Chef internally and externally, whip up awesome, and stir up more delight. I also look forward to seeing what our community and customers do with Chef in their organizations.</p>

<h2>Thank you</h2>

<p>I&rsquo;d like to thank the friends and mentors I&rsquo;ve had along this journey. You&rsquo;re all important, and we&rsquo;ve shared some good times and code, and sometimes hugs. It&rsquo;s been amazing to see so many people become successful with Chef.</p>

<p>Above all, I&rsquo;d like to thank Adam Jacob: for the opportunity to join in this ride, for inspiration to be a better system administrator and operations professional, for mentorship along the way, and for writing Chef in the first place. Cheers, my friend.</p>

<p>Here&rsquo;s to many more years of whipping up awesome!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/07/chef-reporting-api-and-resource-updates/">Chef Reporting API and Resource Updates</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-07T06:18:34-06:00" pubdate data-updated="true">Oct 7<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Have you ever wanted to find a list of nodes that updated a specific resource in a period of time? Such as &ldquo;show me all the nodes in production that had an application service restart in the last hour&rdquo;? Or, &ldquo;which nodes have updated their apt cache recently?&rdquo; For example,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife report resource 'role:supermarket-app AND chef_environment:supermarket-prod' execute 'apt-get update'
</span><span class='line'>execute[apt-get update] changed in the following runs:
</span><span class='line'>app-supermarket1.example.com 2230cf30-6d95-4e43-be18-211137eaf802 @ 2014-10-07T14:07:03Z
</span><span class='line'>app-supermarket2.example.com c5e4d7bf-95a6-4385-9d8e-c6f5617ed79b @ 2014-10-07T14:14:04Z
</span><span class='line'>app-supermarket3.example.com c4c4b4bb-91b6-4f73-9876-b24b093c7f1e @ 2014-10-07T14:09:54Z
</span><span class='line'>app-supermarket4.example.com 3eb09034-7539-4a3c-af6d-5b01d35bc63f @ 2014-10-07T13:31:56Z
</span><span class='line'>app-supermarket5.example.com aa48c1d3-da91-4031-a43d-582a577cbf2d @ 2014-10-07T13:35:15Z
</span><span class='line'>Use `knife runs show` with the run UUID to get more info</span></code></pre></td></tr></table></div></figure>


<p>I have released a new knife plugin to do that, but first some background.</p>

<p>At CHEF, we run the community&rsquo;s cookbook site, <a href="https://supermarket.getchef.com">Supermarket</a>. We monitor the systems that run the site with <a href="http://sensuapp.org">Sensu</a>. The current infrastructure runs instances on Amazon Web Services EC2, with an Elastic Load Balancer (ELB) in front of them. As a corrective action for a <a href="https://www.getchef.com/blog/2014/07/10/supermarket-intermittent-unresponsiveness-postmortem/">Supermarket outage</a>, CHEF&rsquo;s operations team added a new check for elevated HTTP 500 responses from the application servers behind the ELB. One thing we found was that when Supermarket was deployed, and the <code>unicorn</code> server restarted, we would see elevated 500&rsquo;s, but the site often wouldn&rsquo;t actually be impacted.</p>

<p>The Sensu check is run from a &ldquo;relay&rdquo; node. That is, it isn&rsquo;t run on the application servers or the Sensu server &ndash; it&rsquo;s run out of band since it&rsquo;s for the ELB. One might imagine we could have similar checks for other services that aren&rsquo;t run on &ldquo;managed nodes,&rdquo; but that&rsquo;s neither here nor there. The issue is that we get an alert message that looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Sensu Alerts  ALERT - [i-d1dfd5d9/check-elb-backend-500] - CheckELBMetrics CRITICAL: supermarket-elb; Sum of HTTPCode_Backend_5XX is 2538.0. (expected lower than 30.0); (HTTPCode_Backend_5XX '2538.0' within 300 seconds between 2014-08-19 13:33:36 +0000 to 2014-08-19 13:38:36 +0000) [Playbook].</span></code></pre></td></tr></table></div></figure>


<p>The first part, <code>[i-d1dfd5d9/check-elb-backend-500]</code> is the node name and the check that alerted. The node name here is the monitoring relay that runs the check, not the actual node or nodes where Supermarket was deployed and restarted. This is where Chef Reporting comes into play. In Chef Reporting, we can view information about recent Chef client runs, which gives us a graph like this.</p>

<p><img src="/images/reporting-graph.png"></p>

<p>If we go look at the reports in the Chef Manage console, we can drill down to something like this.</p>

<p><img src="/images/reporting-resources.png"></p>

<p>This shows that unicorn was restarted in this run. That&rsquo;s great, but if I&rsquo;m getting this alert at a time when I&rsquo;m not particularly coherent (e.g, 2AM), I want a command in a playbook that I can run to get more information quickly without having to log into the webui and click around imprecisely. CHEF publishes a <code>knife-reporting</code> gem that has a couple handy sub-commands to retrieve this run data. For example, we can list runs.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife runs list
</span><span class='line'>node_name:  i-3022aa3b
</span><span class='line'>run_id:     9eccd8f6-876b-4a57-87ac-0b3e7b7ef1e7
</span><span class='line'>start_time: 2014-08-21T17:03:56Z
</span><span class='line'>status:     started
</span><span class='line'>
</span><span class='line'>node_name:  i-a09424a8
</span><span class='line'>run_id:     f2b7871a-149b-4fd3-abdc-d74a838d719a
</span><span class='line'>start_time: 2014-08-21T17:00:23Z
</span><span class='line'>status:     success</span></code></pre></td></tr></table></div></figure>


<p>Or, we can display a specific run.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife runs show eecb04fb-11df-438a-8e81-dd610eb66616
</span><span class='line'>run_detail:
</span><span class='line'>  data:
</span><span class='line'>  end_time:          2014-08-20T17:50:12Z
</span><span class='line'>  node_name:         i-9f22aa94
</span><span class='line'>  run_id:            eecb04fb-11df-438a-8e81-dd610eb66616
</span><span class='line'>  run_list:          ["role[base]","role[supermarket-app]"]
</span><span class='line'>  start_time:        2014-08-20T17:45:37Z
</span><span class='line'>  status:            success
</span><span class='line'>  total_res_count:   261
</span><span class='line'>  updated_res_count: 17
</span><span class='line'>run_resources:
</span><span class='line'>  cookbook_name:    supermarket
</span><span class='line'>  cookbook_version: 2.7.2
</span><span class='line'>  duration:         209
</span><span class='line'>  final_state:
</span><span class='line'>    enabled: false
</span><span class='line'>    running: true
</span><span class='line'>  id:               unicorn
</span><span class='line'>  initial_state:
</span><span class='line'>    enabled: false
</span><span class='line'>    running: true
</span><span class='line'>  name:             unicorn
</span><span class='line'>  result:           restart
</span><span class='line'>  type:             service
</span><span class='line'>  uri:              https://api.opscode.com/organizations/supermarket/reports/org/runs/eecb04fb-11df-438a-8e81-dd610eb66616/15</span></code></pre></td></tr></table></div></figure>


<p>This is handy, but a little limited. What if I want to display only the runs containing the <code>service[unicorn]</code> resource?</p>

<p>That&rsquo;s where my <code>knife-report-resource</code> plugin helps. At first, it was very much specific to finding unicorn restarts on Supermarket app servers. However, I wanted to make it more general purpose as I think people would want to be able to find when arbitrary resources were updated. This is how it works:</p>

<ol>
<li>Query the Chef Server for a particular set of nodes. For example, <code>'role:supermarket-app AND chef_environment:supermarket-prod'</code>.</li>
<li>Get all the Chef client runs for a specified time period up until the current time. By default, it starts from one hour ago, but we can pass an ISO8601 timestamp.</li>
<li>Iterate over all the runs looking for runs by the nodes that were returned by the search query, gathering the specified resource type and name.</li>
<li>Display some nice output with the node&rsquo;s FQDN, the run&rsquo;s UUID, and a timestamp.</li>
</ol>


<p>From the earlier example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife report resource 'role:supermarket-app AND chef_environment:supermarket-prod' execute 'apt-get update'
</span><span class='line'>execute[apt-get update] changed in the following runs:
</span><span class='line'>app-supermarket1.example.com 2230cf30-6d95-4e43-be18-211137eaf802 @ 2014-10-07T14:07:03Z
</span><span class='line'>app-supermarket2.example.com c5e4d7bf-95a6-4385-9d8e-c6f5617ed79b @ 2014-10-07T14:14:04Z
</span><span class='line'>app-supermarket3.example.com c4c4b4bb-91b6-4f73-9876-b24b093c7f1e @ 2014-10-07T14:09:54Z
</span><span class='line'>app-supermarket4.example.com 3eb09034-7539-4a3c-af6d-5b01d35bc63f @ 2014-10-07T13:31:56Z
</span><span class='line'>app-supermarket5.example.com aa48c1d3-da91-4031-a43d-582a577cbf2d @ 2014-10-07T13:35:15Z
</span><span class='line'>Use `knife runs show` with the run UUID to get more info</span></code></pre></td></tr></table></div></figure>


<p>Then, we can drill down further into one of these runs with the <code>knife-reporting</code> plugin.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife runs show 2230cf30-6d95-4e43-be18-211137eaf802
</span><span class='line'>run_detail:
</span><span class='line'>  data:
</span><span class='line'>  end_time:          2014-10-07T14:07:03Z
</span><span class='line'>  node_name:         i-d7fed0df
</span><span class='line'>  run_id:            2230cf30-6d95-4e43-be18-211137eaf802
</span><span class='line'>  run_list:          ["role[base]","role[supermarket-app]"]
</span><span class='line'>  start_time:        2014-10-07T14:03:59Z
</span><span class='line'>  status:            success
</span><span class='line'>  total_res_count:   271
</span><span class='line'>  updated_res_count: 12
</span><span class='line'>run_resources:
</span><span class='line'>  cookbook_name:    chef-client
</span><span class='line'>  cookbook_version: 3.6.0
</span><span class='line'>  duration:         99
</span><span class='line'>  final_state:
</span><span class='line'>    enabled: true
</span><span class='line'>    running: false
</span><span class='line'>  id:               chef-client
</span><span class='line'>  initial_state:
</span><span class='line'>    enabled: true
</span><span class='line'>    running: true
</span><span class='line'>  name:             chef-client
</span><span class='line'>  result:           enable
</span><span class='line'>  type:             runit_service
</span><span class='line'>  uri:              https://api.opscode.com/organizations/supermarket/reports/org/runs/2230cf30-6d95-4e43-be18-211137eaf802/0
</span><span class='line'>...
</span><span class='line'>  cookbook_name:    supermarket
</span><span class='line'>  cookbook_version: 2.11.0
</span><span class='line'>  duration:         8506
</span><span class='line'>  final_state:
</span><span class='line'>  id:               apt-get update
</span><span class='line'>  initial_state:
</span><span class='line'>  name:             apt-get update
</span><span class='line'>  result:           run
</span><span class='line'>  type:             execute
</span><span class='line'>  uri:              https://api.opscode.com/organizations/supermarket/reports/org/runs/2230cf30-6d95-4e43-be18-211137eaf802/5</span></code></pre></td></tr></table></div></figure>


<p>Hopefully you find this plugin useful! It is a RubyGem, and is available on RubyGems.org, and the source is available on GitHub.</p>

<ul>
<li><a href="https://supermarket.getchef.com/tools/knife-report-resource">Supermarket tool page</a></li>
<li><a href="https://rubygems.org/gems/knife-report-resource">RubyGem page</a></li>
<li><a href="https://github.com/jtimberman/knife-report-resource">GitHub repository</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/02/chef-node-dot-debug-value/">Chef::Node.debug_value</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-02T14:26:21-06:00" pubdate data-updated="true">Sep 2<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Update: As mentioned by <a href="https://twitter.com/kallistec/status/506953082404483072">Dan DeLeo</a>, he discussed this feature on <a href="http://www.getchef.com/blog/2013/02/05/chef-11-in-depth-attributes-changes/">Chef 11 In-Depth: Attributes Changes</a> last year when Chef 11 was released. I somehow never got a chance to use it, and thought this post would be a helpful example.</p>

<p>Earlier today I was reminded by <a href="https://github.com/stevendanna">Steven Danna</a> about a newer feature of Chef called <code>debug_value</code>. This is a method on the <code>node</code> object (<code>Chef::Node</code>) which will show where in Chef&rsquo;s attribute hierarchy a particular attribute or sub-attribute was set on the node.</p>

<p>Fire up a chef shell in client mode on the node you want to see:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef-shell -z</span></code></pre></td></tr></table></div></figure>


<p>For example, I&rsquo;ll use my minecraft server, using the excellent <a href="https://supermarket.getchef.com/cookbooks/minecraft">minecraft cookbook</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef &gt; node.run_list
</span><span class='line'> =&gt; role[minecraft-server]</span></code></pre></td></tr></table></div></figure>


<p>The cookbook itself sets a <code>node['minecraft']</code> attribute hash.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef &gt; node['minecraft']
</span><span class='line'> =&gt; {"user"=&gt;"mcserver", "group"=&gt;"mcserver", "install_dir"=&gt;"/srv/minecraft", "install_type"=&gt;"vanilla" ... omg a huge hash of attributes}</span></code></pre></td></tr></table></div></figure>


<p>Of note are the <a href="http://minecraft.gamepedia.com/Server.properties">server properties</a> attributes, which I customize in the role. Here is the <code>node['minecraft']['properties']</code> attributes hash on my node:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef &gt; node['minecraft']['properties']
</span><span class='line'> =&gt; {"allow-flight"=&gt;false, "allow-nether"=&gt;true, "difficulty"=&gt;"1", "enable-query"=&gt;false, "enable-rcon"=&gt;false, "enable-command-block"=&gt;false, "force-gamemode"=&gt;true, "gamemode"=&gt;"0", "generate-structures"=&gt;true, "hardcore"=&gt;false, "level-name"=&gt;"creative-survival", "level-seed"=&gt;"", "level-type"=&gt;"DEFAULT", "max-build-height"=&gt;"256", "max-players"=&gt;"20", "motd"=&gt;"It's the will to survive", "online-mode"=&gt;true, "op-permission-level"=&gt;4, "player-idle-timeout"=&gt;0, "pvp"=&gt;"false", "query.port"=&gt;"25565", "rcon.password"=&gt;"", "rcon.port"=&gt;"25575", "server-ip"=&gt;"", "server-name"=&gt;"Housepub", "server-port"=&gt;"25565", "snooper-enabled"=&gt;"false", "spawn-animals"=&gt;true, "spawn-monsters"=&gt;true, "spawn-npcs"=&gt;true, "spawn-protection"=&gt;1, "texture-pack"=&gt;"", "view-distance"=&gt;10, "white-list"=&gt;false}</span></code></pre></td></tr></table></div></figure>


<p>And I can see where these were set using the <code>#debug_value</code> method. Each sub-attribute should be passed as an argument.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef &gt; pp node.debug_value('minecraft', 'properties')
</span><span class='line'>[["set_unless_enabled?", false],
</span><span class='line'> ["default",
</span><span class='line'>  {"allow-flight"=&gt;false,
</span><span class='line'>   "allow-nether"=&gt;true,
</span><span class='line'>   "difficulty"=&gt;1,
</span><span class='line'>   "enable-query"=&gt;false,
</span><span class='line'>   "enable-rcon"=&gt;false,
</span><span class='line'>   "enable-command-block"=&gt;false,
</span><span class='line'>   "force-gamemode"=&gt;false,
</span><span class='line'>   "gamemode"=&gt;0,
</span><span class='line'>   "generate-structures"=&gt;true,
</span><span class='line'>   "hardcore"=&gt;false,
</span><span class='line'>   "level-name"=&gt;"world",
</span><span class='line'>   "level-seed"=&gt;"",
</span><span class='line'>   "level-type"=&gt;"DEFAULT",
</span><span class='line'>   "max-build-height"=&gt;"256",
</span><span class='line'>   "max-players"=&gt;"20",
</span><span class='line'>   "motd"=&gt;"A Minecraft Server",
</span><span class='line'>   "online-mode"=&gt;true,
</span><span class='line'>   "op-permission-level"=&gt;4,
</span><span class='line'>   "player-idle-timeout"=&gt;0,
</span><span class='line'>   "pvp"=&gt;true,
</span><span class='line'>   "query.port"=&gt;"25565",
</span><span class='line'>   "rcon.password"=&gt;"",
</span><span class='line'>   "rcon.port"=&gt;"25575",
</span><span class='line'>   "server-ip"=&gt;"",
</span><span class='line'>   "server-name"=&gt;"Unknown Server",
</span><span class='line'>   "server-port"=&gt;"25565",
</span><span class='line'>   "snooper-enabled"=&gt;true,
</span><span class='line'>   "spawn-animals"=&gt;true,
</span><span class='line'>   "spawn-monsters"=&gt;true,
</span><span class='line'>   "spawn-npcs"=&gt;true,
</span><span class='line'>   "spawn-protection"=&gt;16,
</span><span class='line'>   "texture-pack"=&gt;"",
</span><span class='line'>   "view-distance"=&gt;10,
</span><span class='line'>   "white-list"=&gt;false}],
</span><span class='line'> ["env_default", :not_present],
</span><span class='line'> ["role_default",
</span><span class='line'>  {"difficulty"=&gt;"1",
</span><span class='line'>   "gamemode"=&gt;"0",
</span><span class='line'>   "force-gamemode"=&gt;true,
</span><span class='line'>   "motd"=&gt;"It's the will to survive",
</span><span class='line'>   "pvp"=&gt;"false",
</span><span class='line'>   "server-name"=&gt;"Housepub",
</span><span class='line'>   "level-name"=&gt;"creative-survival",
</span><span class='line'>   "spawn-protection"=&gt;1,
</span><span class='line'>   "snooper-enabled"=&gt;"false"}],
</span><span class='line'> ["force_default", :not_present],
</span><span class='line'> ["normal", :not_present],
</span><span class='line'> ["override", :not_present],
</span><span class='line'> ["role_override", :not_present],
</span><span class='line'> ["env_override", :not_present],
</span><span class='line'> ["force_override", :not_present],
</span><span class='line'> ["automatic", :not_present]]</span></code></pre></td></tr></table></div></figure>


<p>From the role, we can see some properties attributes are set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="o">[</span><span class="s2">&quot;role_default&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">{</span><span class="s2">&quot;difficulty&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;gamemode&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;0&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;force-gamemode&quot;</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;motd&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;It&#39;s the will to survive&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;pvp&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;server-name&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Housepub&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;level-name&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;creative-survival&quot;</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;spawn-protection&quot;</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span>
</span><span class='line'>   <span class="s2">&quot;snooper-enabled&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;false&quot;</span><span class="p">}</span><span class="o">]</span><span class="p">,</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that even though these are also set by default, we get them in the output here too.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/21/load-current-resource-and-chef-shell/">Load_current_resource and Chef-shell</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-21T09:50:56-06:00" pubdate data-updated="true">Jul 21<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post will illustrate <code>load_current_resource</code> and a basic use of chef-shell.</p>

<p>The <code>chef-shell</code> is an <code>irb</code>-based <a href="http://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">REPL (read-eval-print-loop)</a>. Everything I do is Ruby code, just like in Chef recipes or other cookbook components. I&rsquo;m going to use a <code>package</code> resource example, so need privileged access (<code>sudo</code>).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% sudo chef-shell</span></code></pre></td></tr></table></div></figure>


<p>The chef-shell program loads its configuration, determines what session type, and displays a banner. In this case, we&rsquo;re taking all the defaults, which means no special configuration, and a <code>standalone</code> session.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>loading configuration: none (standalone session)
</span><span class='line'>Session type: standalone
</span><span class='line'>Loading...done.
</span><span class='line'>
</span><span class='line'>This is the chef-shell.
</span><span class='line'> Chef Version: 11.14.0.rc.2
</span><span class='line'> http://www.opscode.com/chef
</span><span class='line'> http://docs.opscode.com/
</span><span class='line'>
</span><span class='line'>run `help' for help, `exit' or ^D to quit.
</span><span class='line'>
</span><span class='line'>Ohai2u jtimberman@jenkins.int.housepub.org!</span></code></pre></td></tr></table></div></figure>


<p>To evaluate resources as we&rsquo;d write them in a recipe, we need to switch to recipe mode.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef &gt; recipe_mode</span></code></pre></td></tr></table></div></figure>


<p>I can do anything here that I can do in a recipe. I could paste in my own recipes. Here, I&rsquo;m just going to add a <code>package</code> resource to manage the <code>vim</code> package. Note that this works like the &ldquo;compile&rdquo; phase of a <code>chef-client</code> run. The resource will be added to the <code>Chef::ResourceCollection</code> object. We&rsquo;ll look at this in a little more detail shortly.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef:recipe &gt; package "vim"
</span><span class='line'> =&gt; &lt;package[vim] @name: "vim" @noop: nil @before: nil @params: {} @provider: nil @allowed_actions: [:nothing, :install, :upgrade, :remove, :purge, :reconfig] @action: :install @updated: false @updated_by_last_action: false @supports: {} @ignore_failure: false @retries: 0 @retry_delay: 2 @source_line: "(irb#1):1:in `irb_binding'" @guard_interpreter: :default @elapsed_time: 0 @sensitive: false @candidate_version: nil @options: nil @package_name: "vim" @resource_name: :package @response_file: nil @response_file_variables: {} @source: nil @version: nil @timeout: 900 @cookbook_name: nil @recipe_name: nil&gt;</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m done adding resources/writing code to test, so I&rsquo;ll initiate a Chef run with the <code>run_chef</code> method (this is a special method in <code>chef-shell</code>).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef:recipe &gt; run_chef
</span><span class='line'>[2014-07-21T09:04:51-06:00] INFO: Processing package[vim] action install ((irb#1) line 1)
</span><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: Chef::Version::Comparable does not know how to parse the platform version: jessie/sid
</span><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: Chef::Version::Comparable does not know how to parse the platform version: jessie/sid
</span><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: package[vim] checking package status for vim
</span><span class='line'>vim:
</span><span class='line'>  Installed: 2:7.4.335-1
</span><span class='line'>  Candidate: 2:7.4.335-1
</span><span class='line'>  Version table:
</span><span class='line'> *** 2:7.4.335-1 0
</span><span class='line'>        500 http://ftp.us.debian.org/debian/ testing/main amd64 Packages
</span><span class='line'>        100 /var/lib/dpkg/status
</span><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: package[vim] current version is 2:7.4.335-1
</span><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: package[vim] candidate version is 2:7.4.335-1
</span><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: package[vim] is already installed - nothing to do</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s take a look at what&rsquo;s happening. Note that we have INFO and DEBUG output. By default, <code>chef-shell</code> runs with <code>Chef::Log#level</code> set to <code>:debug</code>. In a normal Chef Client run with <code>:info</code> output, we see the first line, but not the others. I&rsquo;ll show each line, and then explain what Chef did.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2014-07-21T09:04:51-06:00] INFO: Processing package[vim] action install ((irb#1) line 1)</span></code></pre></td></tr></table></div></figure>


<p>There is a timestamp, the resource, <code>package[vim]</code>, the action <code>install</code> Chef will take, and the location in the recipe where this was encountered. I didn&rsquo;t specify one in the resource, that&rsquo;s the default action for package resources. The <code>irb#1 line 1</code> just means that it was the first line of the <code>irb</code> in recipe mode.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: Chef::Version::Comparable does not know how to parse the platform version: jessie/sid
</span><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: Chef::Version::Comparable does not know how to parse the platform version: jessie/sid</span></code></pre></td></tr></table></div></figure>


<p>Chef chooses the default provider for each resource based on a mapping of platforms and their versions. It uses an internal class, <code>Chef::Version::Comparable</code> to do this. The system I&rsquo;m using is a Debian &ldquo;testing&rdquo; system, which has the codename <code>jessie</code>, but it isn&rsquo;t a specific release number. Chef knows that for all <code>debian</code> platforms to use the <code>apt</code> package provider, and that&rsquo;ll do here.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: package[vim] checking package status for vim
</span><span class='line'>vim:
</span><span class='line'>  Installed: 2:7.4.335-1
</span><span class='line'>  Candidate: 2:7.4.335-1
</span><span class='line'>  Version table:
</span><span class='line'> *** 2:7.4.335-1 0
</span><span class='line'>        500 http://ftp.us.debian.org/debian/ testing/main amd64 Packages
</span><span class='line'>        100 /var/lib/dpkg/status
</span><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: package[vim] current version is 2:7.4.335-1
</span><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: package[vim] candidate version is 2:7.4.335-1</span></code></pre></td></tr></table></div></figure>


<p>This output is the <code>load_current_resource</code> method implemented in the <a href="https://github.com/opscode/chef/blob/c507822d7b3fe0b34d02719dea0ab483ec292195/lib/chef/provider/package/apt.rb#L33-L38">apt package provider</a>.</p>

<p>The <code>check_package_state</code> method does all the heavy lifting. It runs <code>apt-cache policy</code> and parses the output looking for the version number. If we used the <code>:update</code> action, and the installed version wasn&rsquo;t the same as the candidate version, Chef would install the candidate version.</p>

<p>Chef resources are convergent. They only get updated if they need to be. In this case, the <code>vim</code> package is installed already (our implicitly specified action), so we see the following line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2014-07-21T09:04:51-06:00] DEBUG: package[vim] is already installed - nothing to do</span></code></pre></td></tr></table></div></figure>


<p>Nothing to do, Chef finishes its run.</p>

<h2>Modifying Existing Resources</h2>

<p>We can manipulate the state of the resources in the resource collection. This isn&rsquo;t common in most recipes. It&rsquo;s required for certain kinds of development patterns like &ldquo;wrapper&rdquo; cookbooks. As an example, I&rsquo;m going to modify the resource object so I don&rsquo;t have to log into the system again and run <code>apt-get remove vim</code>, to show the next section.</p>

<p>First, I&rsquo;m going to create a local variable in the context of the recipe. This is just like any other variable in Ruby. For its value, I&rsquo;m going to use the <code>#resources()</code> <a href="http://docs.opscode.com/chef/dsl_recipe.html#resources">method to look up</a> a resource in the resource collection.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef:recipe &gt; local_package_variable = resources("package[vim]")
</span><span class='line'> =&gt; &lt;package[vim] @name: "vim" @noop: nil @before: nil @params: {} @provider: nil @allowed_actions: [:nothing, :install, :upgrade, :remove, :purge, :reconfig] @action: :install @updated: false @updated_by_last_action: false @supports: {} @ignore_failure: false @retries: 0 @retry_delay: 2 @source_line: "(irb#1):1:in `irb_binding'" @guard_interpreter: :default @elapsed_time: 0.029617095 @sensitive: false @candidate_version: nil @options: nil @package_name: "vim" @resource_name: :package @response_file: nil @response_file_variables: {} @source: nil @version: nil @timeout: 900 @cookbook_name: nil @recipe_name: nil&gt;</span></code></pre></td></tr></table></div></figure>


<p>The return value is the package resource object:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef:recipe &gt; local_package_variable.class
</span><span class='line'> =&gt; Chef::Resource::Package</span></code></pre></td></tr></table></div></figure>


<p>(<code>#class</code> is a method on the Ruby <code>Object</code> class that returns the class of the object)</p>

<p>To remove the <code>vim</code> package, I use the <code>#run_action</code> method (available to all <code>Chef::Resource</code> subclasses), specifying the <code>:remove</code> action as a symbol:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef:recipe &gt; local_package_variable.run_action(:remove)
</span><span class='line'>[2014-07-21T09:11:50-06:00] INFO: Processing package[vim] action remove ((irb#1) line 1)
</span><span class='line'>[2014-07-21T09:11:52-06:00] INFO: package[vim] removed</span></code></pre></td></tr></table></div></figure>


<p>There is no additional debug to display. Chef will run <code>apt-get remove vim</code> to converge the resource with this action.</p>

<h2>Load Current Resource Redux</h2>

<p>Now that the package has been removed from the system, what happens if we run Chef again? Well, Chef is convergent, and it takes idempotent actions on the system to ensure that the managed resources are in the desired state. That means it will install the <code>vim</code> package.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>chef:recipe &gt; run_chef
</span><span class='line'>[2014-07-21T09:11:57-06:00] INFO: Processing package[vim] action install ((irb#1) line 1)</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ll see some familiar messages here about the version, then:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2014-07-21T09:11:57-06:00] DEBUG: package[vim] checking package status for vim
</span><span class='line'>vim:
</span><span class='line'>  Installed: (none)
</span><span class='line'>  Candidate: 2:7.4.335-1
</span><span class='line'>  Version table:
</span><span class='line'>     2:7.4.335-1 0
</span><span class='line'>        500 http://ftp.us.debian.org/debian/ testing/main amd64 Packages
</span><span class='line'>[2014-07-21T09:11:57-06:00] DEBUG: package[vim] current version is nil
</span><span class='line'>[2014-07-21T09:11:57-06:00] DEBUG: package[vim] candidate version is 2:7.4.335-1</span></code></pre></td></tr></table></div></figure>


<p>This is <code>load_current_resource</code> working as expected. As we can see from the <code>apt-cache policy</code> output, the package is not installed, and as the action to take is <code>:install</code>, Chef will do what we think:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Reading package lists...
</span><span class='line'>Building dependency tree...
</span><span class='line'>Reading state information...
</span><span class='line'>The following packages were automatically installed and are no longer required:
</span><span class='line'>  g++-4.8 geoclue geoclue-hostip geoclue-localnet geoclue-manual
</span><span class='line'>  geoclue-nominatim gstreamer0.10-plugins-ugly libass4 libblas3gf libcolord1
</span><span class='line'>  libcolorhug1 libgeoclue0 libgnustep-base1.22 libgnutls28 libminiupnpc8
</span><span class='line'>  libpoppler44 libqmi-glib0 libstdc++-4.8-dev python3-ply xulrunner-29
</span><span class='line'>Use 'apt-get autoremove' to remove them.
</span><span class='line'>Suggested packages:
</span><span class='line'>  vim-doc vim-scripts
</span><span class='line'>The following NEW packages will be installed:
</span><span class='line'>  vim
</span><span class='line'>0 upgraded, 1 newly installed, 0 to remove and 28 not upgraded.
</span><span class='line'>Need to get 0 B/905 kB of archives.
</span><span class='line'>After this operation, 2,088 kB of additional disk space will be used.
</span><span class='line'>Selecting previously unselected package vim.
</span><span class='line'>(Reading database ... 220338 files and directories currently installed.)
</span><span class='line'>Preparing to unpack .../vim_2%3a7.4.335-1_amd64.deb ...
</span><span class='line'>Unpacking vim (2:7.4.335-1) ...
</span><span class='line'>Setting up vim (2:7.4.335-1) ...
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/vim (vim) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/vimdiff (vimdiff) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/rvim (rvim) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/rview (rview) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/vi (vi) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/view (view) in auto mode
</span><span class='line'>update-alternatives: using /usr/bin/vim.basic to provide /usr/bin/ex (ex) in auto mode</span></code></pre></td></tr></table></div></figure>


<p>This should be familiar to anyone that uses Debian/Ubuntu, it&rsquo;s standard <code>apt-get install</code> output. Of course, this is a development system so I have some cruft, but we&rsquo;ll ignore that ;).</p>

<p>If we run_chef again, we get the output we saw in the original example in this post:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2014-07-21T09:50:06-06:00] DEBUG: package[vim] is already installed - nothing to do</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/30/chefdk-and-ruby/">ChefDK and Ruby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-30T22:32:18-06:00" pubdate data-updated="true">Apr 30<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently, Chef <a href="http://www.getchef.com/blog/2014/04/15/chef-development-kit/">released ChefDK</a>, the &ldquo;Chef Development Kit.&rdquo; This is a self-contained package of everything required to run Chef, work with Chef cookbooks, and includes the best of breed community tools, test frameworks, and other utility programs that are commonly used when working with Chef in infrastructure as code. <a href="http://www.getchef.com/blog/2014/04/29/chefdk-0-1-0-released/">ChefDK version 0.1.0 was released last week</a>. A new feature mentioned in the <a href="https://github.com/opscode/chef-dk/blob/master/README.md#using-chefdk-as-your-primary-development-environment">README.md</a> is very important, in my opinion.</p>

<p><strong>Using ChefDK as your primary development environment</strong></p>

<p>What does that mean?</p>

<p>It means that if the only reason you have Ruby installed on your local system is to do Chef development or otherwise work with Chef, <em>you no longer have to maintain a separate Ruby installation</em>. That means you won&rsquo;t need any of these:</p>

<ul>
<li><a href="https://github.com/sstephenson/rbenv">rbenv</a></li>
<li><a href="http://rvm.io">rvm</a></li>
<li><a href="https://github.com/postmodern/chruby">chruby</a> (*note)</li>
<li>&ldquo;system ruby&rdquo; (e.g., OS X&rsquo;s included /usr/bin/ruby, or the <code>ruby</code> package from your Linux distro)</li>
<li><a href="https://github.com/poise/poise-ruby">poise ruby</a>)</li>
</ul>


<p>(*note: You can optionally use chruby with ChefDK if it&rsquo;s part of your workflow and you have other Rubies installed.)</p>

<p>Do not misunderstand me: These are all extremely good solutions for getting and using Ruby on your system. They definitely have their place if you do other Ruby development, such as <a href="http://www.sinatrarb.com/">web applications</a>. This is especially true if you have to work with multiple versions of Ruby. However, if you&rsquo;re like me and mainly use Ruby for Chef, then ChefDK has you covered.</p>

<p>In this post, I will describe how I have set up my system with ChefDK, and use its embedded Ruby by default.</p>

<h2>Getting Started</h2>

<p>Download ChefDK from the <a href="http://www.getchef.com/downloads/chef-dk/">downloads page</a>. At the time of this blog post, the available builds are limited to OS X and Linux (Debian/Ubuntu or RHEL), but Chef is <a href="http://www.getchef.com/blog/2014/05/06/chefdk-for-windows-progress-update/">working on Windows packages</a>.</p>

<p>For example, here&rsquo;s what I did on my Ubuntu 14.04 system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget https://opscode-omnibus-packages.s3.amazonaws.com/ubuntu/13.10/x86_64/chefdk_0.1.0-1_amd64.deb
</span><span class='line'>sudo dpkg -i /tmp/chefdk_0.1.0-1_amd64.deb</span></code></pre></td></tr></table></div></figure>


<p>OS X users will be happy to know that the download is a .DMG, which includes a standard OS X .pkg (complete with developer signing). Simply install it like many other products on OS X.</p>

<p>For either Linux or OS X, in <a href="https://github.com/opscode/omnibus-ruby/">omnibus</a> fashion, the post-installation creates several symbolic links in <code>/usr/bin</code> for tools that are included in ChefDK:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% ls -l /usr/bin | grep chefdk
</span><span class='line'>lrwxrwxrwx 1 root root 21 Apr 30 22:13 berks -&gt; /opt/chefdk/bin/berks
</span><span class='line'>lrwxrwxrwx 1 root root 20 Apr 30 22:13 chef -&gt; /opt/chefdk/bin/chef
</span><span class='line'>lrwxrwxrwx 1 root root 26 Apr 30 22:13 chef-apply -&gt; /opt/chefdk/bin/chef-apply
</span><span class='line'>lrwxrwxrwx 1 root root 27 Apr 30 22:13 chef-client -&gt; /opt/chefdk/bin/chef-client
</span><span class='line'>lrwxrwxrwx 1 root root 26 Apr 30 22:13 chef-shell -&gt; /opt/chefdk/bin/chef-shell
</span><span class='line'>lrwxrwxrwx 1 root root 25 Apr 30 22:13 chef-solo -&gt; /opt/chefdk/bin/chef-solo
</span><span class='line'>lrwxrwxrwx 1 root root 25 Apr 30 22:13 chef-zero -&gt; /opt/chefdk/bin/chef-zero
</span><span class='line'>lrwxrwxrwx 1 root root 23 Apr 30 22:13 fauxhai -&gt; /opt/chefdk/bin/fauxhai
</span><span class='line'>lrwxrwxrwx 1 root root 26 Apr 30 22:13 foodcritic -&gt; /opt/chefdk/bin/foodcritic
</span><span class='line'>lrwxrwxrwx 1 root root 23 Apr 30 22:13 kitchen -&gt; /opt/chefdk/bin/kitchen
</span><span class='line'>lrwxrwxrwx 1 root root 21 Apr 30 22:13 knife -&gt; /opt/chefdk/bin/knife
</span><span class='line'>lrwxrwxrwx 1 root root 20 Apr 30 22:13 ohai -&gt; /opt/chefdk/bin/ohai
</span><span class='line'>lrwxrwxrwx 1 root root 23 Apr 30 22:13 rubocop -&gt; /opt/chefdk/bin/rubocop
</span><span class='line'>lrwxrwxrwx 1 root root 20 Apr 30 22:13 shef -&gt; /opt/chefdk/bin/shef
</span><span class='line'>lrwxrwxrwx 1 root root 22 Apr 30 22:13 strain -&gt; /opt/chefdk/bin/strain
</span><span class='line'>lrwxrwxrwx 1 root root 24 Apr 30 22:13 strainer -&gt; /opt/chefdk/bin/strainer</span></code></pre></td></tr></table></div></figure>


<p>These should cover the 80% use case of ChefDK: using the various Chef and Chef Community tools so users can follow their favorite workflow, without shaving the yak of managing a Ruby environment.</p>

<p>But, as I noted, and the thesis of this post, is that one could use this Ruby environment included in ChefDK as their own! So where is that?</p>

<h2>ChefDK&rsquo;s Ruby</h2>

<p>Tucked away in every &ldquo;omnibus&rdquo; package is a directory of &ldquo;embedded&rdquo; software &ndash; the things that were required to meet the end goal. In the case of Chef or ChefDK, this is Ruby, openssl, zlib, libpng, and so on. This is a fully contained directory tree, complete with lib, share, and yes indeed, bin.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% ls /opt/chefdk/embedded/bin
</span><span class='line'>(there's a bunch of commands here, trust me)</span></code></pre></td></tr></table></div></figure>


<p>Of particular note are <code>/opt/chefdk/embedded/bin/ruby</code> and <code>/opt/chefdk/embedded/bin/gem</code>.</p>

<p>To use ChefDK&rsquo;s Ruby as default, simply edit the <code>$PATH</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export PATH="/opt/chefdk/embedded/bin:${HOME}/.chefdk/gem/ruby/2.1.0/bin:$PATH"</span></code></pre></td></tr></table></div></figure>


<p>Add that, or its equivalent, to a login shell profile/dotrc file, and rejoice. Here&rsquo;s what I have now:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ which ruby
</span><span class='line'>/opt/chefdk/embedded/bin/ruby
</span><span class='line'>$ which gem
</span><span class='line'>/opt/chefdk/embedded/bin/gem
</span><span class='line'>$ ruby --version
</span><span class='line'>ruby 2.1.1p76 (2014-02-24 revision 45161) [x86_64-linux]
</span><span class='line'>$ gem --version
</span><span class='line'>2.2.1
</span><span class='line'>$ gem env
</span><span class='line'>RubyGems Environment:
</span><span class='line'>  - RUBYGEMS VERSION: 2.2.1
</span><span class='line'>  - RUBY VERSION: 2.1.1 (2014-02-24 patchlevel 76) [x86_64-linux]
</span><span class='line'>  - INSTALLATION DIRECTORY: /opt/chefdk/embedded/lib/ruby/gems/2.1.0
</span><span class='line'>  - RUBY EXECUTABLE: /opt/chefdk/embedded/bin/ruby
</span><span class='line'>  - EXECUTABLE DIRECTORY: /opt/chefdk/embedded/bin
</span><span class='line'>  - SPEC CACHE DIRECTORY: /home/ubuntu/.gem/specs
</span><span class='line'>  - RUBYGEMS PLATFORMS:
</span><span class='line'>    - ruby
</span><span class='line'>    - x86_64-linux
</span><span class='line'>  - GEM PATHS:
</span><span class='line'>     - /opt/chefdk/embedded/lib/ruby/gems/2.1.0
</span><span class='line'>     - /home/ubuntu/.chefdk/gem/ruby/2.1.0
</span><span class='line'>  - GEM CONFIGURATION:
</span><span class='line'>     - :update_sources =&gt; true
</span><span class='line'>     - :verbose =&gt; true
</span><span class='line'>     - :backtrace =&gt; false
</span><span class='line'>     - :bulk_threshold =&gt; 1000
</span><span class='line'>     - "install" =&gt; "--user"
</span><span class='line'>     - "update" =&gt; "--user"
</span><span class='line'>  - REMOTE SOURCES:
</span><span class='line'>     - https://rubygems.org/
</span><span class='line'>  - SHELL PATH:
</span><span class='line'>     - /opt/chefdk/embedded/bin
</span><span class='line'>     - /home/ubuntu/.chefdk/gem/ruby/2.1.0/bin
</span><span class='line'>     - /usr/local/sbin
</span><span class='line'>     - /usr/local/bin
</span><span class='line'>     - /usr/sbin
</span><span class='line'>     - /usr/bin
</span><span class='line'>     - /sbin
</span><span class='line'>     - /bin
</span><span class='line'>     - /usr/games
</span><span class='line'>     - /usr/local/games</span></code></pre></td></tr></table></div></figure>


<p>Note that this is the current stable release of Ruby, version 2.1.1 patchlevel 76, and the {almost} latest version of RubyGems, version 2.2.1. Also note the Gem paths &ndash; the first is the embedded gems path, which is where gems installed by <code>root</code> with the <code>chef gem</code> command will go. The other is in my home directory &ndash; ChefDK is set up so that gems can be installed as a non-root user within the <code>~/.chefdk/gems</code> directory.</p>

<h2>Installing Gems</h2>

<p>Let&rsquo;s see this in action. Install a gem using the <code>gem</code> command.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gem install knife-solve
</span><span class='line'>Fetching: knife-solve-1.0.1.gem (100%)
</span><span class='line'>Successfully installed knife-solve-1.0.1
</span><span class='line'>Parsing documentation for knife-solve-1.0.1
</span><span class='line'>Installing ri documentation for knife-solve-1.0.1
</span><span class='line'>Done installing documentation for knife-solve after 0 seconds
</span><span class='line'>1 gem installed</span></code></pre></td></tr></table></div></figure>


<p>And as I said, this will be installed in the home directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gem content knife-solve
</span><span class='line'>/home/ubuntu/.chefdk/gem/ruby/2.1.0/gems/knife-solve-1.0.1/LICENSE
</span><span class='line'>/home/ubuntu/.chefdk/gem/ruby/2.1.0/gems/knife-solve-1.0.1/README.md
</span><span class='line'>/home/ubuntu/.chefdk/gem/ruby/2.1.0/gems/knife-solve-1.0.1/Rakefile
</span><span class='line'>/home/ubuntu/.chefdk/gem/ruby/2.1.0/gems/knife-solve-1.0.1/lib/chef/knife/solve.rb
</span><span class='line'>/home/ubuntu/.chefdk/gem/ruby/2.1.0/gems/knife-solve-1.0.1/lib/knife-solve.rb
</span><span class='line'>/home/ubuntu/.chefdk/gem/ruby/2.1.0/gems/knife-solve-1.0.1/lib/knife-solve/version.rb</span></code></pre></td></tr></table></div></figure>


<h2>Using Bundler</h2>

<p>ChefDK also includes <a href="http://bundler.io/">bundler</a>. As a &ldquo;non-Chef, Ruby use case&rdquo;, I installed octopress for this blog.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% bundle install --path vendor --binstubs
</span><span class='line'>Fetching gem metadata from https://rubygems.org/.......
</span><span class='line'>Fetching additional metadata from https://rubygems.org/..
</span><span class='line'>Installing rake (0.9.6)
</span><span class='line'>Installing RedCloth (4.2.9)
</span><span class='line'>Installing chunky_png (1.2.9)
</span><span class='line'>Installing fast-stemmer (1.0.2)
</span><span class='line'>Installing classifier (1.3.3)
</span><span class='line'>Installing fssm (0.2.10)
</span><span class='line'>Installing sass (3.2.12)
</span><span class='line'>Installing compass (0.12.2)
</span><span class='line'>Installing directory_watcher (1.4.1)
</span><span class='line'>Installing haml (3.1.8)
</span><span class='line'>Installing kramdown (0.14.2)
</span><span class='line'>Installing liquid (2.3.0)
</span><span class='line'>Installing maruku (0.7.0)
</span><span class='line'>Installing posix-spawn (0.3.6)
</span><span class='line'>Installing yajl-ruby (1.1.0)
</span><span class='line'>Installing pygments.rb (0.3.7)
</span><span class='line'>Installing jekyll (0.12.1)
</span><span class='line'>Installing rack (1.5.2)
</span><span class='line'>Installing rack-protection (1.5.0)
</span><span class='line'>Installing rb-fsevent (0.9.3)
</span><span class='line'>Installing rdiscount (2.0.7.3)
</span><span class='line'>Installing rubypants (0.2.0)
</span><span class='line'>Installing sass-globbing (1.0.0)
</span><span class='line'>Installing tilt (1.4.1)
</span><span class='line'>Installing sinatra (1.4.3)
</span><span class='line'>Installing stringex (1.4.0)
</span><span class='line'>Using bundler (1.5.2)
</span><span class='line'>Updating files in vendor/cache
</span><span class='line'>  * classifier-1.3.3.gem
</span><span class='line'>  * fssm-0.2.10.gem
</span><span class='line'>  * sass-3.2.12.gem
</span><span class='line'>  * compass-0.12.2.gem
</span><span class='line'>  * directory_watcher-1.4.1.gem
</span><span class='line'>  * haml-3.1.8.gem
</span><span class='line'>  * kramdown-0.14.2.gem
</span><span class='line'>  * liquid-2.3.0.gem
</span><span class='line'>  * maruku-0.7.0.gem
</span><span class='line'>  * posix-spawn-0.3.6.gem
</span><span class='line'>  * yajl-ruby-1.1.0.gem
</span><span class='line'>  * pygments.rb-0.3.7.gem
</span><span class='line'>  * jekyll-0.12.1.gem
</span><span class='line'>  * rack-1.5.2.gem
</span><span class='line'>  * rack-protection-1.5.0.gem
</span><span class='line'>  * rb-fsevent-0.9.3.gem
</span><span class='line'>  * rdiscount-2.0.7.3.gem
</span><span class='line'>  * rubypants-0.2.0.gem
</span><span class='line'>  * sass-globbing-1.0.0.gem
</span><span class='line'>  * tilt-1.4.1.gem
</span><span class='line'>  * sinatra-1.4.3.gem
</span><span class='line'>  * stringex-1.4.0.gem
</span><span class='line'>Your bundle is complete!
</span><span class='line'>It was installed into ./vendor</span></code></pre></td></tr></table></div></figure>


<p>Then I can use for example the rake task to preview things while writing this post.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ./bin/rake preview
</span><span class='line'>Starting to watch source with Jekyll and Compass. Starting Rack on port 4000
</span><span class='line'>directory source/stylesheets/
</span><span class='line'>   create source/stylesheets/screen.css
</span><span class='line'>[2014-05-07 21:46:35] INFO  WEBrick 1.3.1
</span><span class='line'>[2014-05-07 21:46:35] INFO  ruby 2.1.1 (2014-02-24) [x86_64-linux]
</span><span class='line'>[2014-05-07 21:46:35] INFO  WEBrick::HTTPServer#start: pid=10815 port=4000</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>I&rsquo;ve used Chef before it was even released. As the project has evolved, and as the Ruby community around it has established new best practices installing and maintaining Ruby development environments, I&rsquo;ve followed along. I&rsquo;ve used all the version managers listed above. I&rsquo;ve spent untold hours getting the right set of gems installed just to have to upgrade everything again and debug my workstation. I&rsquo;ve written blog posts, <a href="http://wiki.opscode.com">wiki</a> pages, and helped countless users do this on their own systems.</p>

<p>Now, we have an all-in-one environment that provides a great solution. Give ChefDK a whirl on your workstation &ndash; I think you&rsquo;ll like it!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/01/evolution-of-cookbook-development/">Evolution of Cookbook Development</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-01T12:48:49-07:00" pubdate data-updated="true">Feb 1<span>st</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post, I will explore some development patterns that I&rsquo;ve seen
(and done!) with Chef cookbooks, and then explain how we can evolve to
a new level of cookbook development. The examples here come from
Chef&rsquo;s new
<a href="http://www.getchef.com/blog/2014/01/28/chefs-splunk-cookbook-2/">chef-splunk cookbook</a>,
which is a refactored version of an old <code>splunk42</code> cookbook. While
there is a public <code>splunk</code> cookbook on the Chef community site, it
shares some of the issues that I saw with our old one, which are
partially subject matter of this post.</p>

<p>Anyway, on to the evolution!</p>

<h1>Sub-optimal patterns</h1>

<p>These are the general patterns I&rsquo;m going to address.</p>

<ul>
<li>Composing URLs from multiple local variables or attributes</li>
<li>Large conditional logic branches like case statements in recipes</li>
<li>Not using definitions when it is best to do so</li>
<li>Knowledge of how node run lists are composed for search, or
searching for &ldquo;<code>role:some-server</code>&rdquo;</li>
<li>Repeated resources across multiple orthogonal recipes</li>
<li>Plaintext secrets in attributes or data bag items</li>
</ul>


<p>Cookbook development is a wide and varied topic, so there are many
other patterns to consider, but these are the ones most relevant to
the refactored cookbook.</p>

<h2>Composing URLs</h2>

<p>It may seem like a good idea, to compose URL strings as attributes or
local variables in a recipe based on other attributes and local
variables. For example, in our <code>splunk42</code> cookbook we have this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">splunk_root</span> <span class="o">=</span> <span class="s2">&quot;http://download.splunk.com/releases/&quot;</span>
</span><span class='line'><span class="n">splunk_version</span> <span class="o">=</span> <span class="s2">&quot;4.2.1&quot;</span>
</span><span class='line'><span class="n">splunk_build</span> <span class="o">=</span> <span class="s2">&quot;98164&quot;</span>
</span><span class='line'><span class="n">splunk_file</span> <span class="o">=</span> <span class="s2">&quot;splunkforwarder-</span><span class="si">#{</span><span class="n">splunk_version</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">splunk_build</span><span class="si">}</span><span class="s2">-linux-2.6-amd64.deb&quot;</span>
</span><span class='line'><span class="n">os</span> <span class="o">=</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;os&#39;</span><span class="o">].</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\d*/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>These get used in the following <code>remote_file</code> resource:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">remote_file</span> <span class="s2">&quot;/opt/</span><span class="si">#{</span><span class="n">splunk_file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">splunk_root</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">splunk_version</span><span class="si">}</span><span class="s2">/universalforwarder/</span><span class="si">#{</span><span class="n">os</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">splunk_file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:create_if_missing</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>We reused the filename variable, and composed the URL to the file to
download. Then to upgrade, we can simply modify the <code>splunk_version</code>
and <code>splunk_build</code>, as Splunk uses a consistent naming theme for their
package URLs (thanks, Splunk!). The filename itself is built from a
case statement (more on that in the next section). We could further
make the version and build attributes, so users can update to newer
versions by simply changing the attribute.</p>

<p>So what is bad about this? Two things.</p>

<ol>
<li>This is in the <code>splunk42::client</code> recipe, and repeated again in the
<code>splunk42::server</code> recipe with only minor differences (the package
name, splunk vs splunkforwarder).</li>
<li>Ruby has excellent libraries for manipulating URIs and paths as
strings, and it is easier to break up a string than compose a new one.</li>
</ol>


<p>How can this be improved? First, we can set attributes for the full URL.
The actual code for that is below, but suffice to say, it will look
like this (note the version is different because the new cookbook installs
a new Splunk version).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">default</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;forwarder&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;http://download.splunk.com/releases/6.0.1/universalforwarder/linux/splunkforwarder-6.0.1-189883-linux-2.6-amd64.deb&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Second, we have
<a href="https://github.com/opscode-cookbooks/chef-splunk/blob/master/libraries/helpers.rb">helper libraries</a>
distributed with the cookbook that break up the URI so we can return
just the package filename.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">splunk_file</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;pathname&#39;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;uri&#39;</span>
</span><span class='line'>  <span class="no">Pathname</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The previous <code>remote_file</code> resource is rewritten like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">remote_file</span> <span class="s2">&quot;/opt/</span><span class="si">#{</span><span class="n">splunk_file</span><span class="p">(</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;forwarder&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;forwarder&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:create_if_missing</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As a bonus, the helper methods are available in other places like
other cookbooks and recipes, rather than the local scope of local
variables.</p>

<h2>Conditional Logic Branches</h2>

<p>One of the wonderful things about Chef is that simple Ruby
conditionals can be used in recipes to selectively set values for
resource attributes, define resources that should be used, and other
decisions. One of the horrible things about Chef is that simple Ruby
conditionals can be used in recipes and often end up being far more
complicated than originally intended, especially when handling
multiple platforms and versions.</p>

<p>In the earlier example, we had a <code>splunk_file</code> local variable set in a
recipe. I mentioned it was built from a case statement, which looks
like this, in full:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">splunk_file</span> <span class="o">=</span> <span class="k">case</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;platform_family&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">when</span> <span class="s2">&quot;rhel&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;kernel&#39;</span><span class="o">][</span><span class="s1">&#39;machine&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;x86_64&quot;</span>
</span><span class='line'>      <span class="n">splunk_file</span> <span class="o">=</span> <span class="s2">&quot;splunkforwarder-</span><span class="si">#{</span><span class="n">splunk_version</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">splunk_build</span><span class="si">}</span><span class="s2">-linux-2.6-x86_64.rpm&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">splunk_file</span> <span class="o">=</span> <span class="s2">&quot;splunkforwarder-</span><span class="si">#{</span><span class="n">splunk_version</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">splunk_build</span><span class="si">}</span><span class="s2">.i386.rpm&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">when</span> <span class="s2">&quot;debian&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;kernel&#39;</span><span class="o">][</span><span class="s1">&#39;machine&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;x86_64&quot;</span>
</span><span class='line'>      <span class="n">splunk_file</span> <span class="o">=</span> <span class="s2">&quot;splunkforwarder-</span><span class="si">#{</span><span class="n">splunk_version</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">splunk_build</span><span class="si">}</span><span class="s2">-linux-2.6-amd64.deb&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">splunk_file</span> <span class="o">=</span> <span class="s2">&quot;splunkforwarder-</span><span class="si">#{</span><span class="n">splunk_version</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">splunk_build</span><span class="si">}</span><span class="s2">-linux-2.6-intel.deb&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">when</span> <span class="s2">&quot;omnios&quot;</span>
</span><span class='line'>    <span class="n">splunk_file</span> <span class="o">=</span> <span class="s2">&quot;splunkforwarder-</span><span class="si">#{</span><span class="n">splunk_version</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">splunk_build</span><span class="si">}</span><span class="s2">-solaris-10-intel.pkg.Z&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Splunk itself supports many platforms, and not all of them are covered
by this conditional, so it&rsquo;s easy to imagine how this can get further
out of control and make the recipe even harder to follow. Also
consider that this is just the <code>client</code> portion for the
<code>splunkforwarder</code> package, this same block is repeated in the <code>server</code>
recipe, for the <code>splunk</code> package.</p>

<p>So why is this bad? There are three reasons.</p>

<ol>
<li>We have a large block of conditionals that sit in front of a user
reading a recipe.</li>
<li>This logic isn&rsquo;t reusable elsewhere, so it has to be duplicated in
the other recipe.</li>
<li>This is only the logic for the package filename, but we care about
the entire URL. I&rsquo;ve also covered that composing URLs isn&rsquo;t delightful.</li>
</ol>


<p>What is a better approach? Use the full URL as I mentioned before, and
set it as an attribute. We will still have the gnarly case statement,
but it will be tucked away in the <code>attributes/default.rb</code> file, and
hidden from anyone reading the recipe (which is the thing they
probably care most about reading).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">case</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;platform_family&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">when</span> <span class="s1">&#39;rhel&#39;</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;kernel&#39;</span><span class="o">][</span><span class="s1">&#39;machine&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;x86_64&#39;</span>
</span><span class='line'>    <span class="n">default</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;forwarder&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;http://download.splunk.com/releases/6.0.1/universalforwarder/linux/splunkforwarder-6.0.1-189883-linux-2.6-x86_64.rpm&#39;</span>
</span><span class='line'>    <span class="n">default</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;server&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;http://download.splunk.com/releases/6.0.1/splunk/linux/splunk-6.0.1-189883-linux-2.6-x86_64.rpm&#39;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">default</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;forwarder&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;http://download.splunk.com/releases/6.0.1/universalforwarder/linux/splunkforwarder-6.0.1-189883.i386.rpm&#39;</span>
</span><span class='line'>    <span class="n">default</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;server&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;http://download.splunk.com/releases/6.0.1/splunk/linux/splunk-6.0.1-189883.i386.rpm&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">when</span> <span class="s1">&#39;debian&#39;</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>The the complete case block can be viewed in the
<a href="https://github.com/opscode-cookbooks/chef-splunk/blob/master/attributes/default.rb#L46-L66">repository</a>.
Also, since this is an attribute, consumers of this cookbook can set
the URL to whatever they want, including a local HTTP server.</p>

<p>Another example of gnarly conditional logic looks like this, also from
the <code>splunk42::client</code> recipe.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">case</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;platform_family&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">when</span> <span class="s2">&quot;rhel&quot;</span>
</span><span class='line'>  <span class="n">rpm_package</span> <span class="s2">&quot;/opt/</span><span class="si">#{</span><span class="n">splunk_file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">source</span> <span class="s2">&quot;/opt/</span><span class="si">#{</span><span class="n">splunk_file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">when</span> <span class="s2">&quot;debian&quot;</span>
</span><span class='line'>  <span class="n">dpkg_package</span> <span class="s2">&quot;/opt/</span><span class="si">#{</span><span class="n">splunk_file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">source</span> <span class="s2">&quot;/opt/</span><span class="si">#{</span><span class="n">splunk_file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">when</span> <span class="s2">&quot;omnios&quot;</span>
</span><span class='line'>  <span class="c1"># tl;dr, this was more lines than you want to read, and</span>
</span><span class='line'>  <span class="c1"># will be covered in the next section.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why is this bad? After all, we&rsquo;re selecting the proper package
resource to install from a local file on disk. The main issue is the
conditional creates different resources that can&rsquo;t be looked up in the
resource collection. Our recipe doesn&rsquo;t do this, but perhaps a wrapper
cookbook would. The consumer wrapping the cookbook has to duplicate
this logic in their own. Instead, it is better to select the provider
for a single <code>package</code> resource.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">package</span> <span class="s2">&quot;/opt/</span><span class="si">#{</span><span class="n">splunk_file</span><span class="p">(</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;forwarder&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;platform_family&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">when</span> <span class="s1">&#39;rhel&#39;</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Provider</span><span class="o">::</span><span class="ss">Package</span><span class="p">:</span><span class="ss">:Rpm</span>
</span><span class='line'>  <span class="k">when</span> <span class="s1">&#39;debian&#39;</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Provider</span><span class="o">::</span><span class="ss">Package</span><span class="p">:</span><span class="ss">:Dpkg</span>
</span><span class='line'>  <span class="k">when</span> <span class="s1">&#39;omnios&#39;</span>
</span><span class='line'>    <span class="n">provider</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Provider</span><span class="o">::</span><span class="ss">Package</span><span class="p">:</span><span class="ss">:Solaris</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Definitions Aren&rsquo;t Bad</h2>

<p>Definitions are simply defined as recipe &ldquo;macros.&rdquo; They are not
actually Chef Resources themselves, they just look like them, and
contain their own Chef resources. This has some disadvantages, such as
lack of metaparameters (like action), which has lead people to prefer
using the &ldquo;Lightweight Resource/Provider&rdquo; (LWRP) DSL instead. In fact,
some feel that definitions are bad, and that one should feel bad for
using them. I argue that they have their place. One advantage is their
relative simplicity.</p>

<p>In our <code>splunk42</code> cookbook, the client and server recipes duplicate a
lot of logic. As mentioned a lot of this is case statements for the
Splunk package file. They also repeat the same logic for choosing the
provider to install the package. I snipped the content from the <code>when
"omnios"</code> block, but it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cache_dir</span> <span class="o">=</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:file_cache_path</span><span class="o">]</span>
</span><span class='line'><span class="n">splunk_pkg</span> <span class="o">=</span> <span class="n">splunk_file</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\.Z/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;uncompress /opt/</span><span class="si">#{</span><span class="n">splunk_file</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="p">{</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">splunk_cmd</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">cookbook_file</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/splunk-nocheck&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s2">&quot;splunk-nocheck&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">file</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/splunkforwarder-response&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="s2">&quot;BASEDIR=/opt&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">pkgopts</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;-a </span><span class="si">#{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/splunk-nocheck&quot;</span><span class="p">,</span>
</span><span class='line'>           <span class="s2">&quot;-r </span><span class="si">#{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/splunkforwarder-response&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">package</span> <span class="s2">&quot;splunkforwarder&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s2">&quot;/opt/</span><span class="si">#{</span><span class="n">splunk_pkg</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">options</span> <span class="n">pkgopts</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">provider</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Provider</span><span class="o">::</span><span class="ss">Package</span><span class="p">:</span><span class="ss">:Solaris</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>(Note: the logic for setting the provider is required since we&rsquo;re not using the default over-the-network package providers, and installing from a local file on the system.)</p>

<p>This isn&rsquo;t <em>too</em> bad on its own, but needs to be repeated again in the
server recipe if one wanted to run a Splunk server on OmniOS. The
actual differences between the client and server package installation
are the package name, <code>splunkforwarder</code> vs <code>splunk</code>. The earlier URL
attribute example established a <code>forwarder</code> and <code>server</code> attribute.
Using a definition, named <code>splunk_installer</code>, allows us to simplify
the package installation used by the client and server recipes to look
like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">splunk_installer</span> <span class="s1">&#39;splunkforwarder&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">url</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;forwarder&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">splunk_installer</span> <span class="s1">&#39;splunk&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">url</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;server&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>How is this better than an LWRP? Simply that there was less ceremony
in creating it. There is less cognitive load for a cookbook developer
to worry about. Definitions by their very nature of containing
resources are already idempotent and convergent with no additional
effort. They also automatically support why-run mode, whereas in an
LWRP that must be done by the developer. Finally, between resources in
the definition and the rest of the Chef run, notifications may be
sent.</p>

<p>Contrast this to an LWRP, we need <code>resources</code> and <code>providers</code>
directories, and the attributes of the resource need to be defined in
the resource. Then the action methods need to be written in the
provider. If we&rsquo;re using inline resources (which we are) we need to
declare those so any notifications work. Finally, we should ensure
that why-run works properly.</p>

<p>The actual definition is ~40 lines, and can be viewed in the cookbook
<a href="https://github.com/opscode-cookbooks/chef-splunk/blob/master/definitions/splunk_installer.rb">repository</a>.
I don&rsquo;t have a comparable LWRP for this, but suffice to say that it
would be longer and more complicated than the definition.</p>

<h2>Reasonability About Search</h2>

<p>Search is one of the killer features of running a Chef Server.
Dynamically configuring load balancer configuration, or finding the
master database server is simple with a search. Because we often think
about the functionality a service provides based on the role it
serves, we end up doing searches that look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">splunk_servers</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s2">&quot;role:splunk-server&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we do something with <code>splunk_servers</code>, like send it to a
template. What if someone doesn&rsquo;t like the <a href="http://bikeshed.io">role name</a>?
Then we have to do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">splunk_servers</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s2">&quot;role:</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;server_role&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then consumers of the cookbook can use whatever server role name they
want, and just update the attribute for it. But, the internet has said
that roles are bad, so we shouldn&rsquo;t use them (even though they
aren&rsquo;t ;)). So instead, we need something like one of these queries:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">splunk_servers</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s2">&quot;recipes:splunk42\:\:server&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">#or</span>
</span><span class='line'><span class="n">splunk_servers</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;splunk&#39;</span><span class="o">][</span><span class="s1">&#39;server_search_query&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The problem with the first is similar to the problem with the first
(<code>role:splunk-server</code>), we need knowledge about the run list in order
to search properly. The problem with the second is that we now have to
worry about constructing a query properly as a string that gets
interpolated correctly.</p>

<p>How can we improve this? I think it is more &ldquo;Chef-like&rdquo; to use an
attribute on the server&rsquo;s node object itself that informs queries the
intention that the node is in fact a Splunk server. In our
<code>chef-splunk</code> cookbook, we use <code>node['splunk']['is_server']</code>. The
query looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">splunk_servers</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s2">&quot;splunk_is_server:true&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This reads clearly, and the <code>is_server</code> attribute can be set in one of
15 places (for good or bad, but that&rsquo;s a different post).</p>

<h2>Repeating Resources, Composable Recipes</h2>

<p>In the past, it was deemed okay to repeat resources across recipes
when those recipes were not included on the same node. For example,
client and server recipes that have similar resource requirements, but
may pass in separate data. Another example is in the
<a href="http://community.opscode.com/cookbooks/haproxy">haproxy</a>) cookbook I
wrote where one recipe statically manages the configuration files, and
the other uses a Chef search to populate the configuration.</p>

<p>As I have mentioned above, a lot of code was duplicated between the
client and server recipes for our <code>splunk42</code> cookbook: user and group,
the case statements, package resources, execute statements (that
haven&rsquo;t been shared here), and the service resource. It is definitely
important to ensure that all the resources needed to converge a recipe
are defined, particularly when using notifications. That is why
sometimes a recipe will have a <code>service</code> resource with no actions like
this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">service</span> <span class="s1">&#39;mything&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>However Chef 11will generate a warning about
<a href="http://tickets.opscode.com/browse/CHEF-3694">cloned resources</a> when
they are repeated in the same Chef run.</p>

<p>Why is this bad? Well, CHEF-3694 explains in more detail that
particular issue, of cloned resources. The other reason is that it
makes recipes harder to reuse when they have a larger scope than
absolutely necessary. How can we make this better? A solution to this
is to write small, composable recipes that contain resources that may
be optional for certain use cases. For example, we can put the service
resource in a recipe and include that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">service</span> <span class="s1">&#39;splunk&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">supports</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:restart</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">provider</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Provider</span><span class="o">::</span><span class="ss">Service</span><span class="p">:</span><span class="ss">:Init</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:start</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then when we need to make sure we have the <code>service</code> resource
available (e.g., for notifications):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">template</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">splunk_dir</span><span class="si">}</span><span class="s2">/etc/system/local/outputs.conf&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s1">&#39;outputs.conf.erb&#39;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0644</span>
</span><span class='line'>  <span class="n">variables</span> <span class="ss">:splunk_servers</span> <span class="o">=&gt;</span> <span class="n">splunk_servers</span>
</span><span class='line'>  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="s1">&#39;service[splunk]&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">include_recipe</span> <span class="s1">&#39;chef-splunk::service&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that the service is included <em>after</em> the resource that notifies
it. This is a feature of the notification system, where the notified
resource can appear anywhere in the resource collection, and brings up
another excellent practice, which is to declare service resources
after other resources which affect their configuration. This prevents
a race condition where, if a bad config is deployed, the service would
attempt to start, fail, and cause the Chef run to exit before the
config file could correct the problem.</p>

<p>Making recipes composable in this way means that users can pick and
choose the ones they want. Our <code>chef-splunk</code> cookbook has a
prescriptive default recipe, but the client and server recipes mainly
include the others they need. If someone doesn&rsquo;t share our opinion on
this for their use case, they can pick and choose the ones they want.
Perhaps they have the <code>splunk</code> user and group created on systems
through some other means. They won&rsquo;t need the <code>chef-splunk::user</code>
recipe, and can write their own wrapper to handle that. Overall this
is good, though it does mean there are multiple places where a user
must look to follow a recipe.</p>

<h2>Plaintext Secrets</h2>

<p>Managing secrets is one of the hardest problems to solve in system
administration and configuration management. In Chef, it is very easy
to simply set attributes, or use data bag items for authentication
credentials. Our old <code>splunk42</code> cookbook had this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">splunk_password</span> <span class="o">=</span> <span class="n">node</span><span class="o">[</span><span class="ss">:splunk</span><span class="o">][</span><span class="ss">:auth</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where <code>node[:splunk][:auth]</code> was set in a role with the
<code>username:password</code>. This isn&rsquo;t particularly <em>bad</em> since our Chef
server runs on a private network and is secured with HTTPS and RSA
keys, but a defense in depth security posture has more controls in
place for secrets.</p>

<p>How can this be improved? At Chef, we started using
<a href="https://github.com/Nordstrom/chef-vault">Chef Vault</a> to manage
secrets. I wrote a
<a href="http://www.getchef.com/blog/2013/09/19/managing-secrets-with-chef-vault/">post about chef-vault</a>
a few months ago, so I won&rsquo;t dig too deep into the details here. The
current <code>chef-splunk</code> cookbook loads the authentication information
like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">splunk_auth_info</span> <span class="o">=</span> <span class="n">chef_vault_item</span><span class="p">(</span><span class="ss">:vault</span><span class="p">,</span> <span class="s2">&quot;splunk_</span><span class="si">#{</span><span class="n">node</span><span class="o">.</span><span class="n">chef_environment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">[</span><span class="s1">&#39;auth&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">user</span><span class="p">,</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">splunk_auth_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">splunk_cmd</span><span class="si">}</span><span class="s2"> edit user </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2"> -password &#39;</span><span class="si">#{</span><span class="n">pw</span><span class="si">}</span><span class="s2">&#39; -role admin -auth admin:changeme&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">not_if</span> <span class="p">{</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">splunk_dir</span><span class="si">}</span><span class="s2">/etc/.setup_</span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">_password&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">file</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">splunk_dir</span><span class="si">}</span><span class="s2">/etc/.setup_</span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">_password&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="s1">&#39;true\n&#39;</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">00600</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line loads the authentication information from the
encrypted-with-chef-vault data bag item. Then we make a couple of
convenient local variables, and change the password from Splunk&rsquo;s
built-in default. Then, we control convergence of the execute by
writing a file that indicates that the password has been set.</p>

<p>The advantage of this over attributes or data bag items is that the
content is encrypted. The advantage over regular encrypted data bags
is that we don&rsquo;t need to distribute the secret key out to every
system, we can update the list of nodes that have access with a knife
command.</p>

<h1>Conclusion</h1>

<p>Neither Chef (the company), nor I are here to tell anyone how to
write cookbooks. One of the benefits of Chef (the product) is its
flexibility, allowing users to write blocks of Ruby code in recipes
that quickly solve an immediate problem. That&rsquo;s how we got to where we
were with <code>splunk42</code>, and we certainly have other cookbooks that can
be refactored similarly. When it comes to sharing cookbooks with the
community, well-factored, easy to follow, understand, and use code is
preferred.</p>

<p>Many of the ideas here came from community members like Miah Johnson,
Noah Kantrowitz, Jamie Winsor, and Mike Fiedler. I owe them thanks for
challenging me over the years on a lot of the older patterns that I
held onto. Together we can build better automation through cookbooks,
and a strong collaborative community. I hope this information is
helpful to those goals.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/19/managing-multiple-aws-account-credentials/">Managing Multiple AWS Account Credentials</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-19T17:55:00-06:00" pubdate data-updated="true">Oct 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>UPDATE</strong>: All non-default profiles must have their profile name
  start with &ldquo;profile.&rdquo; Below, this is &ldquo;profile nondefault.&rdquo; The ruby
  code is updated to reflect this.</p>

<p>In this post, I will describe my local setup for using the
<a href="http://aws.amazon.com/cli/">AWS CLI</a>, the
<a href="http://aws.amazon.com/sdkforruby/">AWS Ruby SDK</a>, and of course the
<a href="http://rubygems.org/gems/knife-ec2">Knife EC2 plugin</a>.</p>

<p>The general practice I&rsquo;ve used is to set the appropriate shell
environment variables that are used by default by these tools (and the
&ldquo;legacy&rdquo; ec2-api-tools, the java-based CLI). Over time and between
tools, there have been several environment variables set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>AWS_ACCESS_KEY_ID
</span><span class='line'>AWS_SECRET_ACCESS_KEY
</span><span class='line'>AWS_DEFAULT_REGION
</span><span class='line'>AWS_SSH_KEY
</span><span class='line'>AMAZON_ACCESS_KEY_ID
</span><span class='line'>AMAZON_SECRET_ACCESS_KEY
</span><span class='line'>AWS_ACCESS_KEY
</span><span class='line'>AWS_SECRET_KEY
</span></code></pre></td></tr></table></div></figure>


<p>There is now a config file (ini-flavored) that can be used to set
credentials, <code>~/.aws/config</code>. Each ini section in this file is a
different account&rsquo;s credentials. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>default<span class="o">]</span>
</span><span class='line'><span class="nv">aws_access_key_id</span><span class="o">=</span>MY_DEFAULT_KEY
</span><span class='line'><span class="nv">aws_secret_access_key</span><span class="o">=</span>MY_DEFAULT_SECRET
</span><span class='line'><span class="nv">region</span><span class="o">=</span>us-east-1
</span><span class='line'><span class="o">[</span>profile nondefault<span class="o">]</span>
</span><span class='line'><span class="nv">aws_access_key_id</span><span class="o">=</span>NOT_MY_DEFAULT_KEY
</span><span class='line'><span class="nv">aws_secret_access_key</span><span class="o">=</span>NOT_MY_DEFAULT_SECRET
</span><span class='line'><span class="nv">region</span><span class="o">=</span>us-east-1
</span></code></pre></td></tr></table></div></figure>


<p>I have two accounts listed here. Obviously, the actual keys are not
listed :). I source a shell script that sets the environment variables
with these values. Before, I maintained a separate script for each
account. Now, I install the <code>inifile</code>
<a href="http://rubygems.org/gems/inifile">RubyGem</a> and use a one-liner for
each of the keys.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="sb">`</span>ruby -rinifile -e <span class="s2">&quot;puts IniFile.load(File.join(File.expand_path(&#39;~&#39;), &#39;.aws&#39;, &#39;config&#39;))[&#39;default&#39;][&#39;aws_access_key_id&#39;]&quot;</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="sb">`</span>ruby -rinifile -e <span class="s2">&quot;puts IniFile.load(File.join(File.expand_path(&#39;~&#39;), &#39;.aws&#39;, &#39;config&#39;))[&#39;default&#39;][&#39;aws_secret_access_key&#39;]&quot;</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_SSH_KEY</span><span class="o">=</span><span class="s1">&#39;jtimberman&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will load the specified file, <code>~/.aws/config</code> with the
<code>IniFile.load</code> method, retrieving the <code>default</code> section&rsquo;s
<code>aws_access_key_id</code> value. Then repeat the same for the
<code>aws_secret_access_key</code>.</p>

<p>To use the nondefault profile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="sb">`</span>ruby -rinifile -e <span class="s2">&quot;puts IniFile.load(File.join(File.expand_path(&#39;~&#39;), &#39;.aws&#39;, &#39;config&#39;))[&#39;profile nondefault&#39;][&#39;aws_access_key_id&#39;]&quot;</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="sb">`</span>ruby -rinifile -e <span class="s2">&quot;puts IniFile.load(File.join(File.expand_path(&#39;~&#39;), &#39;.aws&#39;, &#39;config&#39;))[&#39;profile nondefault&#39;][&#39;aws_secret_access_key&#39;]&quot;</span><span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that this uses <code>['profile nondefault']</code>.</p>

<p>Since different tools historically have used slightly different
environment variables, I export those too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">AMAZON_ACCESS_KEY_ID</span><span class="o">=</span><span class="nv">$AWS_ACCESS_KEY_ID</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AMAZON_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="nv">$AWS_SECRET_ACCESS_KEY</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY</span><span class="o">=</span><span class="nv">$AWS_ACCESS_KEY_ID</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_SECRET_KEY</span><span class="o">=</span><span class="nv">$AWS_SECRET_ACCESS_KEY</span>
</span></code></pre></td></tr></table></div></figure>


<p>I create a separate config script for each account.</p>

<p>The AWS CLI tool will automatically use the <code>~/.aws/config</code>, and can
load different profiles with the <code>--profile</code> option. The <code>aws-sdk</code>
Ruby library will use the environment variables, however. So
authentication in a Ruby script is automatically set up.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;aws-sdk&#39;</span>
</span><span class='line'><span class="n">iam</span> <span class="o">=</span> <span class="ss">AWS</span><span class="p">:</span><span class="ss">:IAM</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without this, it would be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;aws-sdk&#39;</span>
</span><span class='line'><span class="n">iam</span> <span class="o">=</span> <span class="ss">AWS</span><span class="p">:</span><span class="ss">:IAM</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:access_key_id</span> <span class="o">=&gt;</span> <span class="s1">&#39;YOUR_ACCESS_KEY_ID&#39;</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:secret_access_key</span> <span class="o">=&gt;</span> <span class="s1">&#39;YOUR_SECRET_ACCESS_KEY&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which is a little ornerous.</p>

<p>To use this with <code>knife-ec2</code>, I have the following in my
<code>.chef/knife.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">knife</span><span class="o">[</span><span class="ss">:aws_access_key_id</span><span class="o">]</span>      <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;AWS_ACCESS_KEY_ID&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">knife</span><span class="o">[</span><span class="ss">:aws_secret_access_key</span><span class="o">]</span>  <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;AWS_SECRET_ACCESS_KEY&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Naturally, since <code>knife.rb</code> is Ruby, I could use <code>Inifile.load</code> there,
but I only started using that library recently, and I have my knife
configuration setup already.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("jtimberman", 3, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/jtimberman" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @jtimberman</a>
  
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/12/29/chef-12-homebrew-user-mixin/">Quick Tip: Chef 12 Homebrew User Mixin</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/24/quicktip-delete-attributes/">Quick Tip: Deleting Attributes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/11/chef-12-fix-untrusted-self-sign-certs/">Chef 12: Fix Untrusted Self Sign Certs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/07/reflecting-on-six-years-with-chef/">Reflecting on Six Years With Chef</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/07/chef-reporting-api-and-resource-updates/">Chef Reporting API and Resource Updates</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jtimberman">@jtimberman</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jtimberman',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011-2014 - Joshua Timberman -
  <span class="credit">Powered
  by <a href="http://octopress.org">Octopress</a></span>
  <br /><a rel="license"
  href="http://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
  Commons License" style="border-width:0"
  src="http://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons Attribution-ShareAlike 3.0 United States License</a>.
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jtimberman';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
