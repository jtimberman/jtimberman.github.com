<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: chef | jtimberman's Code Blog]]></title>
  <link href="http://jtimberman.housepub.org/blog/categories/chef/atom.xml" rel="self"/>
  <link href="http://jtimberman.housepub.org/"/>
  <updated>2014-12-24T18:46:50-07:00</updated>
  <id>http://jtimberman.housepub.org/</id>
  <author>
    <name><![CDATA[Joshua Timberman]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Quick Tip: Deleting Attributes]]></title>
    <link href="http://jtimberman.housepub.org/blog/2014/12/24/quicktip-delete-attributes/"/>
    <updated>2014-12-24T10:00:40-07:00</updated>
    <id>http://jtimberman.housepub.org/blog/2014/12/24/quicktip-delete-attributes</id>
    <content type="html"><![CDATA[<p>I have a new goal for 2015, and that is to write at least one &ldquo;Quick Tip&rdquo; per week about Chef. I&rsquo;ve added the category &ldquo;<a href="/blog/categories/quicktips">quicktips</a>&rdquo; to make these easier to find.</p>

<p>In this quick tip, I want to talk about a new feature of Chef 12. The new feature is the ability to remove an attribute from all levels (default, normal, override) on a node so it doesn&rsquo;t get saved back to the Chef Server. This was brought up in <a href="https://github.com/opscode/chef-rfc/blob/master/rfc023-chef-12-attributes-changes.md#global-level-removals">Chef RFC 23</a>. The reason I don&rsquo;t want to save the attribute in question back to the server is that it is a secret that I have in a <a href="https://github.com/Nordstrom/chef-vault">Chef Vault item</a>.</p>

<p>I&rsquo;m using <a href="https://www.datadoghq.com">Datadog</a> for my home systems, and the wonderful folks at Datadog have a <a href="https://supermarket.chef.io/cookbooks/datadog">cookbook</a> to set it up. The documentation requires that you set two attributes to authenticate, the API key, and the application key:</p>

<p><code>ruby
node.default['datadog']['api_key'] = 'Secrets In Plain Text Attributes??'
node.default['datadog']['application_key'] = 'It is probably fine.'
</code></p>

<p>I prefer to use chef-vault because <a href="http://jtimberman.housepub.org/blog/2013/09/10/managing-secrets-with-chef-vault/">I think it&rsquo;s the best way</a> to manage shared secrets in Chef recipes. I still need to set the attributes for Datadog&rsquo;s recipe to work, however. In order to accomplish the goal here, I will use a custom cookbook, <code>housepub-datadog</code>. It has one recipe that looks like this:</p>

<p>```ruby
include_recipe &lsquo;chef-vault&rsquo;</p>

<p>node.default[&lsquo;datadog&rsquo;][&lsquo;api_key&rsquo;] = chef_vault_item(:secrets, &lsquo;datadog&rsquo;)[&lsquo;data&rsquo;][&lsquo;api_key&rsquo;]
node.default[&lsquo;datadog&rsquo;][&lsquo;application_key&rsquo;] = chef_vault_item(:secrets, &lsquo;datadog&rsquo;)[&lsquo;data&rsquo;][&lsquo;chef&rsquo;]</p>

<p>include_recipe &lsquo;datadog::dd-agent&rsquo;</p>

<p>ruby_block &lsquo;smash-datadog-auth-attributes&rsquo; do
  block do</p>

<pre><code>node.rm('datadog', 'api_key')
node.rm('datadog', 'application_key')
</code></pre>

<p>  end
  subscribes :create, &lsquo;template[/etc/dd-agent/datadog.conf]&rsquo;, :immediately
end
```</p>

<p>Let&rsquo;s take a closer look at the recipe.</p>

<p><code>ruby
include_recipe 'chef-vault'
</code></p>

<p>Here, the <code>chef-vault</code> recipe is included to ensure everything works, and I have a dependency on <code>chef-vault</code> in my cookbook&rsquo;s metadata. Next, we see the attributes set:</p>

<p><code>ruby
node.default['datadog']['api_key'] = chef_vault_item(:secrets, 'datadog')['data']['api_key']
node.default['datadog']['application_key'] = chef_vault_item(:secrets, 'datadog')['data']['chef']
</code></p>

<p>The <code>secrets/datadog</code> item looks like this in plaintext:</p>

<p>```json
{
  &ldquo;id&rdquo;: &ldquo;datadog&rdquo;,
  &ldquo;data&rdquo;: {</p>

<pre><code>"api_key": "My datadog API key",
"chef": "Application key for the 'chef' application"
</code></pre>

<p>  }
}
```</p>

<p>When Chef runs, it will load the vault-encrypted data bag item, and populate the attributes that will be used in the template. This template comes from the <code>datadog::dd-agent</code> recipe, which is included next. The template from that recipe looks like this:</p>

<p>```ruby
template &lsquo;/etc/dd-agent/datadog.conf&rsquo; do
  owner &lsquo;root&rsquo;
  group &lsquo;root&rsquo;
  mode 0644
  variables(</p>

<pre><code>:api_key =&gt; node['datadog']['api_key'],
:dd_url =&gt; node['datadog']['url']
</code></pre>

<p>  )
end
```</p>

<p>Now, for the grand finale of this post, I delete the attributes that were set using a <code>ruby_block</code> resource. The timing here is important, because these attributes must be deleted after Chef has converged the template. This does get updated every run, because the ruby block is not convergent, and this is okay because the attributes are updated every run, too. I could write additional logic to make this convergent, but I&rsquo;m okay with the behavior. The <code>subscribes</code> ensures that as soon as the template is written, the node object is updated to remove the attributes. Otherwise, this happens next after the <code>dd-agent</code> recipe.</p>

<p>```ruby
ruby_block &lsquo;smash-datadog-auth-attributes&rsquo; do
  block do</p>

<pre><code>node.rm('datadog', 'api_key')
node.rm('datadog', 'application_key')
</code></pre>

<p>  end
  subscribes :create, &lsquo;template[/etc/dd-agent/datadog.conf]&rsquo;, :immediately
end
```</p>

<p>Let&rsquo;s see this in action:</p>

<p>```
managed-node$ chef-client
&hellip;
Recipe: housepub-datadog::default
  * ruby_block[smash-datadog-auth-attributes] action run</p>

<pre><code>- execute the ruby block smash-datadog-auth-attributes
</code></pre>

<p>&hellip;
workstation% knife node show managed-node -a datadog.api_key -a datadog.application_key
managed-node:
  datadog.api_key:
  datadog.application_key:
```</p>

<p><strong>Bonus quick tip!</strong> <code>knife node show</code> can take the <code>-a</code> option multiple times to display more attributes. I just discovered this in writing this post, and I don&rsquo;t know when it was added. For sure in Chef 12.0.3, so you should just upgrade anyway ;).</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Chef 12: Fix Untrusted Self Sign Certs]]></title>
    <link href="http://jtimberman.housepub.org/blog/2014/12/11/chef-12-fix-untrusted-self-sign-certs/"/>
    <updated>2014-12-11T13:42:41-07:00</updated>
    <id>http://jtimberman.housepub.org/blog/2014/12/11/chef-12-fix-untrusted-self-sign-certs</id>
    <content type="html"><![CDATA[<p>Scenario: You&rsquo;ve started up a brand new Chef Server using version 12, and you have installed Chef 12 on your local system. You log into the Management Console to create a user and organization (or do this with the command-line <code>chef-server-ctl</code> commands), and you&rsquo;re ready to rock with this knife.rb:</p>

<p><code>ruby
node_name                'jtimberman'
client_key               'jtimberman.pem'
validation_client_name   'tester-validator'
validation_key           'tester-validator.pem'
chef_server_url          'https://chef-server.example.com/organizations/tester'
</code></p>

<p>However, when you try to check things out with knife:</p>

<p><code>
% knife client list
ERROR: SSL Validation failure connecting to host: chef-server.example.com - SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed
ERROR: OpenSSL::SSL::SSLError: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed
</code></p>

<p>This is because Chef client 12 has SSL verification enabled by default for all requests. Since the certificate generated by the Chef Server 12 installation is self-signed, there isn&rsquo;t a signing CA that can be verified, and this fails. Never fear intrepid user, for you can get the SSL certificate from the server and store it as a &ldquo;trusted&rdquo; certificate. To find out how, use <code>knife ssl check</code>.</p>

<p>```
Connecting to host chef-server.example.com:443
ERROR: The SSL certificate of chef-server.example.com could not be verified
Certificate issuer data: /C=US/ST=WA/L=Seattle/O=YouCorp/OU=Operations/CN=chef-server.example.com/emailAddress=<a href="&#109;&#97;&#x69;&#108;&#x74;&#x6f;&#x3a;&#121;&#x6f;&#117;&#x40;&#x65;&#x78;&#97;&#x6d;&#x70;&#x6c;&#101;&#46;&#x63;&#x6f;&#x6d;">&#x79;&#111;&#x75;&#x40;&#101;&#120;&#97;&#109;&#112;&#108;&#x65;&#46;&#99;&#111;&#x6d;</a></p>

<p>Configuration Info:</p>

<p>OpenSSL Configuration:
* Version: OpenSSL 1.0.1j 15 Oct 2014
* Certificate file: /opt/chefdk/embedded/ssl/cert.pem
* Certificate directory: /opt/chefdk/embedded/ssl/certs
Chef SSL Configuration:
* ssl_ca_path: nil
* ssl_ca_file: nil
* trusted_certs_dir: &ldquo;/Users/jtimberman/Downloads/chef-repo/.chef/trusted_certs&rdquo;</p>

<p>TO FIX THIS ERROR:</p>

<p>If the server you are connecting to uses a self-signed certificate, you must
configure chef to trust that server&rsquo;s certificate.</p>

<p>By default, the certificate is stored in the following location on the host
where your chef-server runs:</p>

<p>  /var/opt/chef-server/nginx/ca/SERVER_HOSTNAME.crt</p>

<p>Copy that file to your trusted_certs_dir (currently: /Users/jtimberman/Downloads/chef-repo/.chef/trusted_certs)
using SSH/SCP or some other secure method, then re-run this command to confirm
that the server&rsquo;s certificate is now trusted.
```</p>

<p>(note, <a href="https://github.com/opscode/chef/issues/2604">this chef-server location is incorrect</a>, it&rsquo;s <code>/var/opt/opscode</code>)</p>

<p>There is a <code>fetch</code> plugin for <code>knife</code> too. Let&rsquo;s download the certificate to the automatically preconfigured trusted certificate location mentioned in the output above.</p>

<p>```
% knife ssl fetch
WARNING: Certificates from chef-server.example.com will be fetched and placed in your trusted_cert
directory (/Users/jtimberman/Downloads/chef-repo/.chef/trusted_certs).</p>

<p>Knife has no means to verify these are the correct certificates. You should
verify the authenticity of these certificates after downloading.</p>

<p>Adding certificate for chef-server.example.com in /Users/jtimberman/Downloads/chef-repo/.chef/trusted_certs/chef-server.example.com.crt
```</p>

<p>The certificate should be verified that what was downloaded is in fact the same as the certificate on the Chef Server. For example, I compared SHA256 checksums:</p>

<p><code>
% ssh ubuntu@chef-server.example.com sudo sha256sum /var/opt/opscode/nginx/ca/chef-server.example.com.crt
043728b55144861ed43a426c67addca357a5889158886aee50685cf1422b5ebf  /var/opt/opscode/nginx/ca/chef-server.example.com.crt
% gsha256sum .chef/trusted_certs/chef-server.example.com.crt
043728b55144861ed43a426c67addca357a5889158886aee50685cf1422b5ebf  .chef/trusted_certs/chef-server.example.com.crt
</code></p>

<p>Now check knife client list again.</p>

<p><code>
% knife client list
tester-validator
</code></p>

<p>Victory!</p>

<p>Now, we need to get the ceritficate out to every node in the infrastructure in its <code>trusted_certs_dir</code> &ndash; by default this is <code>/etc/chef/trusted_certs</code>. The most simple way to do this is to use <code>knife ssh</code> to run knife on the target nodes.</p>

<p><code>
% knife ssh 'name:*' 'sudo knife ssl fetch -c /etc/chef/client.rb'
node-output.example.com WARNING: Certificates from chef-server-example.com will be fetched and placed in your trusted_cert
node-output.example.com directory (/etc/chef/trusted_certs).
node-output.example.com
node-output.example.com Knife has no means to verify these are the correct certificates. You should
node-output.example.com verify the authenticity of these certificates after downloading.
node-output.example.com
node-output.example.com Adding certificate for chef-server.example.com in /etc/chef/trusted_certs/chef-server.example.com.crt
</code></p>

<p>The output will be interleaved for all the nodes returned by <code>knife ssh</code>. Of course, we should verify the SHA256 checksums like before, which can be done again with <code>knife ssh</code>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Reflecting on Six Years with Chef]]></title>
    <link href="http://jtimberman.housepub.org/blog/2014/10/07/reflecting-on-six-years-with-chef/"/>
    <updated>2014-10-07T11:36:43-06:00</updated>
    <id>http://jtimberman.housepub.org/blog/2014/10/07/reflecting-on-six-years-with-chef</id>
    <content type="html"><![CDATA[<p>It actually started a bit over seven years ago. I saw the writing on the wall at IBM; my job was soon to be outsourced. I found an open position with the SANS institute, accepted an offer there, and was due to start work in a couple of weeks. Around the same time, my friends Adam Jacob and Nathan Haneysmith had started HJK Solutions. They invited me to join them then, but it wasn&rsquo;t the right time for me. Adam told me that at SANS I should at least use the <a href="https://puppetlabs.com">automation</a> <a href="http://capistranorb.com/">tools</a> and general <a href="http://infrastructures.org">infrastructure management model</a> they planned to use. It turned out this was sage advice, for a number of reasons.</p>

<p>Around April, 2008, Adam told me he was working on &ldquo;Chef,&rdquo; a Ruby based configuration management and system integration framework. I was excited about its potential, and a few months later on July 2, 2008, I started with HJK Solutions as a Linux system administration consultant. I got familiar with HJK&rsquo;s puppet-based stack, and ancillary Ruby tools like <a href="https://github.com/adamhjk/iclassify/wiki">iClassify</a> while working on their customer infrastructures over the coming months. After Opscode was founded and we released Chef 0.5, my primary focus was porting HJK&rsquo;s puppet modules to <a href="https://github.com/opscode/cookbooks">chef cookbooks</a>.</p>

<h2>opscode/cookbooks</h2>

<p>Adam had started the repository to give new users a place to begin using Chef with full working examples. I continued their development, and had the opportunity to solve hard problems of integration web application stacks with them. There were three important reasons for the repository to exist:</p>

<ol>
<li>We have a body of knowledge as a tribe, and that can be codified.</li>
<li>Infrastructure as code is real, and it <em>can</em> be reusable.</li>
<li>The best way to learn Chef is to use Chef, and I had a goal to know Chef well enough to teach it to new users and companies.</li>
</ol>


<p>The development of general purpose cookbooks ends up being harder than any of us really imagined, I think. Every platform is different, so not only did I have to learn Chef, I had to learn how different platforms behave for common (and uncommon) pieces of software in web operations stacks. Over the years of managing these cookbooks, I learned a lot about how the community was developing workflows for using Chef, and how they differed from our opinions. I learned also learned how to manage and contribute to open source projects at a rather large scale, and how to have compassion and empathy for new or frustrated users.</p>

<h2>Training and Services</h2>

<p>In my time at CHEF, nee Opscode, I&rsquo;ve had several job role changes. After several months of working on cookbooks, I added package and release management (<a href="http://lists.opscode.com/sympa/arc/chef/2014-11/msg00015.html">RIP, apt.opscode.com</a>) to my repertoire. I then switched to technical evangelism and training. With mentorship from <a href="http://twitter.com/botchagalupe">John Willis</a>, I drafted the initial version of <a href="https://www.getchef.com/blog/2010/07/13/open-source-chef-training-open-training/">Chef Fundamentals</a>, and delivered our inaugural training class in Seattle.</p>

<p>I worked with the team John built to deliver training, speak at conferences, and work directly with customers to help make them successful with Chef. Eventually, John left the company to <a href="http://www.enstratius.com/news-events/press-releases/john-willis-announcement">build an awesome team</a> at <a href="http://www.enstratius.com/home">Enstratius</a>. I took on the role of Director of the team, but eventually I discovered that the <a href="http://fractio.nl/2014/09/19/not-a-promotion-a-career-change/">management track</a> was not the future of my career.</p>

<h2>Open Source and Community</h2>

<p>I came back to working on the cookbooks, which I had previously <a href="https://github.com/opscode-cookbooks">split into separate repositories</a>. I was also working more directly in the community, doing public training classes only (our consulting team did private/onsite classes), participating in our <a href="https://botbot.me/freenode/chef">IRC channels</a> and mailing <a href="http://lists.opscode.com">lists</a>. We had some organization churn, and I was moved around between four different managers, eventually reporting to <a href="https://twitter.com/nathenharvey">the inimitable Nathen Harvey</a>.</p>

<p>During one of our 1-1 discussions, he said, &ldquo;You know, Joshua. You write a lot of cookbooks to automate infrastructure. But you haven&rsquo;t actually worked on any infrastructure in years. You should do something about that.&rdquo;</p>

<p>Around that time, there was a &ldquo;senior system administrator&rdquo; job posting on our very own careers site. I talked to our VP of Operations, and after a brief transition period, moved completely over to the ops team. I was able to bring with me the great practices from the community for developing cookbooks: testing with <a href="http://sethvargo.github.io/chefspec/">chefspec</a> and <a href="http://serverspec.org/">serverspec</a>, code consistency with <a href="">rubocop</a> and <a href="http://foodcritic.io">foodcritic</a>, and wrapping it all up with <a href="http://kitchen.ci">test kitchen</a>.</p>

<h2>The Future</h2>

<p>I&rsquo;ve had the privilege to do work that I love, which is automating hard problems using Chef. I&rsquo;ve also had the privilege of being part of the web operations, infrastructure as code, devops, and Chef communities over the past six years. I&rsquo;ve been to all four Chef summits, and all three ChefConfs. A thing I&rsquo;ve noticed over the years is that many conversations keep coming up at the summits and ChefConf. Fresh on my mind because the last summit was so recent is the topic of cookbook reusability. See, during the time that I managed opscode/cookbooks, I eventually saw the point people in the community were making about these being real software repositories that need to be managed like other complex software projects. We split up the repository into individual repositories per cookbook. We started adding test coverage, and conforming to consistency via syntax and style lint checking. That didn&rsquo;t make cookboks more reusable, but it lowered the barrier of contribution, which in turn made them more reusable as more use cases could be covered. I got to be a part of that evolution, and it&rsquo;s been awesome.</p>

<p>While using Chef is one of my favorite technical things to do, I have come to the conclusion that based on my experience the best thing I can do is be a facilitator of stronger technical discipline with regard to using Chef. Primarily, this means improving how CHEF uses Chef to build Chef for our community and customers. We&rsquo;re already really good at using Chef to build Chef (the product), and run Hosted Chef (the service). However, awesome tools from the community such as Test Kitchen, Berkshelf, ChefSpec, and Foodcritic did not exist when we started out. Between new, awesome tools, and growing our organization with new awesome people, we need to improve on getting our team members up to speed on the process and workflow that helps us deliver higher quality products.</p>

<p>That is why I&rsquo;m moving into a new role at CHEF. The sixth year marks as good a time as any to make a change, and I&rsquo;m no stranger to that. I&rsquo;m joining a team of quality advocacy led by Joseph Smith, as part of Jez Humble&rsquo;s &ldquo;Office of Continuous Improvement and Velocity.&rdquo; In this new role, I will focus on improving our overall technical excellence so we can deliver better products to our community and customers, and so we can have awesome use cases and examples for managing Chef Server and its add-ons at scale.</p>

<p>My first short term goal in this new role is a workstation automation cookbook that can be used and extended by our internal teams for ensuring everyone has a consistent set of tools to work on the product. This will be made an open source project that the community can use and extend as well. We&rsquo;ll have more information about this as it becomes &ldquo;a thing.&rdquo;</p>

<p>Next, I want to improve how we work on incidents. We&rsquo;ve had sporadic blog posts about issues in Hosted Chef and Supermarket, and I&rsquo;d like to see this get better.</p>

<p>I&rsquo;m also interested in managing Chef Server 12 clusters, including all the add-ons. Recently I worked on the <a href="https://github.com/opscode-cookbooks/chef-server-cluster">chef-server-cluster</a> cookbook, which will become the way CHEF deploys and manages Hosted Chef using the version 12 packages. Part of the earliest days of opscode/cookbooks, I maintained cookbooks to setup the open source Chef Server. Long time users may remember the &ldquo;chef solo bootstrap&rdquo; stack. Since then, CHEF has continued to iterate on that idea, and the &ldquo;ctl&rdquo; management commands largely use chef-solo under the hood. The new cookbook combines and wraps up manual processes and the &ldquo;ctl&rdquo; commands to enable us, our community, and our customers to build scalable Chef Server clusters using the omnibus packages. The cookbook uses chef-provisioning to do much of the heavy lifting.</p>

<p>It should be easy for organizations to be successful with Chef. That includes CHEF! My goal in my new position is to fuel the love of Chef internally and externally, whip up awesome, and stir up more delight. I also look forward to seeing what our community and customers do with Chef in their organizations.</p>

<h2>Thank you</h2>

<p>I&rsquo;d like to thank the friends and mentors I&rsquo;ve had along this journey. You&rsquo;re all important, and we&rsquo;ve shared some good times and code, and sometimes hugs. It&rsquo;s been amazing to see so many people become successful with Chef.</p>

<p>Above all, I&rsquo;d like to thank Adam Jacob: for the opportunity to join in this ride, for inspiration to be a better system administrator and operations professional, for mentorship along the way, and for writing Chef in the first place. Cheers, my friend.</p>

<p>Here&rsquo;s to many more years of whipping up awesome!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Chef Reporting API and Resource Updates]]></title>
    <link href="http://jtimberman.housepub.org/blog/2014/10/07/chef-reporting-api-and-resource-updates/"/>
    <updated>2014-10-07T06:18:34-06:00</updated>
    <id>http://jtimberman.housepub.org/blog/2014/10/07/chef-reporting-api-and-resource-updates</id>
    <content type="html"><![CDATA[<p>Have you ever wanted to find a list of nodes that updated a specific resource in a period of time? Such as &ldquo;show me all the nodes in production that had an application service restart in the last hour&rdquo;? Or, &ldquo;which nodes have updated their apt cache recently?&rdquo; For example,</p>

<p><code>
% knife report resource 'role:supermarket-app AND chef_environment:supermarket-prod' execute 'apt-get update'
execute[apt-get update] changed in the following runs:
app-supermarket1.example.com 2230cf30-6d95-4e43-be18-211137eaf802 @ 2014-10-07T14:07:03Z
app-supermarket2.example.com c5e4d7bf-95a6-4385-9d8e-c6f5617ed79b @ 2014-10-07T14:14:04Z
app-supermarket3.example.com c4c4b4bb-91b6-4f73-9876-b24b093c7f1e @ 2014-10-07T14:09:54Z
app-supermarket4.example.com 3eb09034-7539-4a3c-af6d-5b01d35bc63f @ 2014-10-07T13:31:56Z
app-supermarket5.example.com aa48c1d3-da91-4031-a43d-582a577cbf2d @ 2014-10-07T13:35:15Z
Use `knife runs show` with the run UUID to get more info
</code></p>

<p>I have released a new knife plugin to do that, but first some background.</p>

<p>At CHEF, we run the community&rsquo;s cookbook site, <a href="https://supermarket.getchef.com">Supermarket</a>. We monitor the systems that run the site with <a href="http://sensuapp.org">Sensu</a>. The current infrastructure runs instances on Amazon Web Services EC2, with an Elastic Load Balancer (ELB) in front of them. As a corrective action for a <a href="https://www.getchef.com/blog/2014/07/10/supermarket-intermittent-unresponsiveness-postmortem/">Supermarket outage</a>, CHEF&rsquo;s operations team added a new check for elevated HTTP 500 responses from the application servers behind the ELB. One thing we found was that when Supermarket was deployed, and the <code>unicorn</code> server restarted, we would see elevated 500&rsquo;s, but the site often wouldn&rsquo;t actually be impacted.</p>

<p>The Sensu check is run from a &ldquo;relay&rdquo; node. That is, it isn&rsquo;t run on the application servers or the Sensu server &ndash; it&rsquo;s run out of band since it&rsquo;s for the ELB. One might imagine we could have similar checks for other services that aren&rsquo;t run on &ldquo;managed nodes,&rdquo; but that&rsquo;s neither here nor there. The issue is that we get an alert message that looks like this:</p>

<p><code>
Sensu Alerts     ALERT - [i-d1dfd5d9/check-elb-backend-500] - CheckELBMetrics CRITICAL: supermarket-elb; Sum of HTTPCode_Backend_5XX is 2538.0. (expected lower than 30.0); (HTTPCode_Backend_5XX '2538.0' within 300 seconds between 2014-08-19 13:33:36 +0000 to 2014-08-19 13:38:36 +0000) [Playbook].
</code></p>

<p>The first part, <code>[i-d1dfd5d9/check-elb-backend-500]</code> is the node name and the check that alerted. The node name here is the monitoring relay that runs the check, not the actual node or nodes where Supermarket was deployed and restarted. This is where Chef Reporting comes into play. In Chef Reporting, we can view information about recent Chef client runs, which gives us a graph like this.</p>

<p><img src="/images/reporting-graph.png"></p>

<p>If we go look at the reports in the Chef Manage console, we can drill down to something like this.</p>

<p><img src="/images/reporting-resources.png"></p>

<p>This shows that unicorn was restarted in this run. That&rsquo;s great, but if I&rsquo;m getting this alert at a time when I&rsquo;m not particularly coherent (e.g, 2AM), I want a command in a playbook that I can run to get more information quickly without having to log into the webui and click around imprecisely. CHEF publishes a <code>knife-reporting</code> gem that has a couple handy sub-commands to retrieve this run data. For example, we can list runs.</p>

<p>```
% knife runs list
node_name:  i-3022aa3b
run_id:     9eccd8f6-876b-4a57-87ac-0b3e7b7ef1e7
start_time: 2014-08-21T17:03:56Z
status:     started</p>

<p>node_name:  i-a09424a8
run_id:     f2b7871a-149b-4fd3-abdc-d74a838d719a
start_time: 2014-08-21T17:00:23Z
status:     success
```</p>

<p>Or, we can display a specific run.</p>

<p>```
% knife runs show eecb04fb-11df-438a-8e81-dd610eb66616
run_detail:
  data:
  end_time:          2014-08-20T17:50:12Z
  node_name:         i-9f22aa94
  run_id:            eecb04fb-11df-438a-8e81-dd610eb66616
  run_list:          [&ldquo;role[base]&rdquo;,&ldquo;role[supermarket-app]&rdquo;]
  start_time:        2014-08-20T17:45:37Z
  status:            success
  total_res_count:   261
  updated_res_count: 17
run_resources:
  cookbook_name:    supermarket
  cookbook_version: 2.7.2
  duration:         209
  final_state:</p>

<pre><code>enabled: false
running: true
</code></pre>

<p>  id:               unicorn
  initial_state:</p>

<pre><code>enabled: false
running: true
</code></pre>

<p>  name:             unicorn
  result:           restart
  type:             service
  uri:              <a href="https://api.opscode.com/organizations/supermarket/reports/org/runs/eecb04fb-11df-438a-8e81-dd610eb66616/15">https://api.opscode.com/organizations/supermarket/reports/org/runs/eecb04fb-11df-438a-8e81-dd610eb66616/15</a>
```</p>

<p>This is handy, but a little limited. What if I want to display only the runs containing the <code>service[unicorn]</code> resource?</p>

<p>That&rsquo;s where my <code>knife-report-resource</code> plugin helps. At first, it was very much specific to finding unicorn restarts on Supermarket app servers. However, I wanted to make it more general purpose as I think people would want to be able to find when arbitrary resources were updated. This is how it works:</p>

<ol>
<li>Query the Chef Server for a particular set of nodes. For example, <code>'role:supermarket-app AND chef_environment:supermarket-prod'</code>.</li>
<li>Get all the Chef client runs for a specified time period up until the current time. By default, it starts from one hour ago, but we can pass an ISO8601 timestamp.</li>
<li>Iterate over all the runs looking for runs by the nodes that were returned by the search query, gathering the specified resource type and name.</li>
<li>Display some nice output with the node&rsquo;s FQDN, the run&rsquo;s UUID, and a timestamp.</li>
</ol>


<p>From the earlier example:</p>

<p><code>
% knife report resource 'role:supermarket-app AND chef_environment:supermarket-prod' execute 'apt-get update'
execute[apt-get update] changed in the following runs:
app-supermarket1.example.com 2230cf30-6d95-4e43-be18-211137eaf802 @ 2014-10-07T14:07:03Z
app-supermarket2.example.com c5e4d7bf-95a6-4385-9d8e-c6f5617ed79b @ 2014-10-07T14:14:04Z
app-supermarket3.example.com c4c4b4bb-91b6-4f73-9876-b24b093c7f1e @ 2014-10-07T14:09:54Z
app-supermarket4.example.com 3eb09034-7539-4a3c-af6d-5b01d35bc63f @ 2014-10-07T13:31:56Z
app-supermarket5.example.com aa48c1d3-da91-4031-a43d-582a577cbf2d @ 2014-10-07T13:35:15Z
Use `knife runs show` with the run UUID to get more info
</code></p>

<p>Then, we can drill down further into one of these runs with the <code>knife-reporting</code> plugin.</p>

<p>```
% knife runs show 2230cf30-6d95-4e43-be18-211137eaf802
run_detail:
  data:
  end_time:          2014-10-07T14:07:03Z
  node_name:         i-d7fed0df
  run_id:            2230cf30-6d95-4e43-be18-211137eaf802
  run_list:          [&ldquo;role[base]&rdquo;,&ldquo;role[supermarket-app]&rdquo;]
  start_time:        2014-10-07T14:03:59Z
  status:            success
  total_res_count:   271
  updated_res_count: 12
run_resources:
  cookbook_name:    chef-client
  cookbook_version: 3.6.0
  duration:         99
  final_state:</p>

<pre><code>enabled: true
running: false
</code></pre>

<p>  id:               chef-client
  initial_state:</p>

<pre><code>enabled: true
running: true
</code></pre>

<p>  name:             chef-client
  result:           enable
  type:             runit_service
  uri:              <a href="https://api.opscode.com/organizations/supermarket/reports/org/runs/2230cf30-6d95-4e43-be18-211137eaf802/0">https://api.opscode.com/organizations/supermarket/reports/org/runs/2230cf30-6d95-4e43-be18-211137eaf802/0</a>
&hellip;
  cookbook_name:    supermarket
  cookbook_version: 2.11.0
  duration:         8506
  final_state:
  id:               apt-get update
  initial_state:
  name:             apt-get update
  result:           run
  type:             execute
  uri:              <a href="https://api.opscode.com/organizations/supermarket/reports/org/runs/2230cf30-6d95-4e43-be18-211137eaf802/5">https://api.opscode.com/organizations/supermarket/reports/org/runs/2230cf30-6d95-4e43-be18-211137eaf802/5</a>
```</p>

<p>Hopefully you find this plugin useful! It is a RubyGem, and is available on RubyGems.org, and the source is available on GitHub.</p>

<ul>
<li><a href="https://supermarket.getchef.com/tools/knife-report-resource">Supermarket tool page</a></li>
<li><a href="https://rubygems.org/gems/knife-report-resource">RubyGem page</a></li>
<li><a href="https://github.com/jtimberman/knife-report-resource">GitHub repository</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Chef::Node.debug_value]]></title>
    <link href="http://jtimberman.housepub.org/blog/2014/09/02/chef-node-dot-debug-value/"/>
    <updated>2014-09-02T14:26:21-06:00</updated>
    <id>http://jtimberman.housepub.org/blog/2014/09/02/chef-node-dot-debug-value</id>
    <content type="html"><![CDATA[<p>Update: As mentioned by <a href="https://twitter.com/kallistec/status/506953082404483072">Dan DeLeo</a>, he discussed this feature on <a href="http://www.getchef.com/blog/2013/02/05/chef-11-in-depth-attributes-changes/">Chef 11 In-Depth: Attributes Changes</a> last year when Chef 11 was released. I somehow never got a chance to use it, and thought this post would be a helpful example.</p>

<p>Earlier today I was reminded by <a href="https://github.com/stevendanna">Steven Danna</a> about a newer feature of Chef called <code>debug_value</code>. This is a method on the <code>node</code> object (<code>Chef::Node</code>) which will show where in Chef&rsquo;s attribute hierarchy a particular attribute or sub-attribute was set on the node.</p>

<p>Fire up a chef shell in client mode on the node you want to see:</p>

<p><code>
chef-shell -z
</code></p>

<p>For example, I&rsquo;ll use my minecraft server, using the excellent <a href="https://supermarket.getchef.com/cookbooks/minecraft">minecraft cookbook</a>.</p>

<p><code>
chef &gt; node.run_list
 =&gt; role[minecraft-server]
</code></p>

<p>The cookbook itself sets a <code>node['minecraft']</code> attribute hash.</p>

<p><code>
chef &gt; node['minecraft']
 =&gt; {"user"=&gt;"mcserver", "group"=&gt;"mcserver", "install_dir"=&gt;"/srv/minecraft", "install_type"=&gt;"vanilla" ... omg a huge hash of attributes}
</code></p>

<p>Of note are the <a href="http://minecraft.gamepedia.com/Server.properties">server properties</a> attributes, which I customize in the role. Here is the <code>node['minecraft']['properties']</code> attributes hash on my node:</p>

<p><code>
chef &gt; node['minecraft']['properties']
 =&gt; {"allow-flight"=&gt;false, "allow-nether"=&gt;true, "difficulty"=&gt;"1", "enable-query"=&gt;false, "enable-rcon"=&gt;false, "enable-command-block"=&gt;false, "force-gamemode"=&gt;true, "gamemode"=&gt;"0", "generate-structures"=&gt;true, "hardcore"=&gt;false, "level-name"=&gt;"creative-survival", "level-seed"=&gt;"", "level-type"=&gt;"DEFAULT", "max-build-height"=&gt;"256", "max-players"=&gt;"20", "motd"=&gt;"It's the will to survive", "online-mode"=&gt;true, "op-permission-level"=&gt;4, "player-idle-timeout"=&gt;0, "pvp"=&gt;"false", "query.port"=&gt;"25565", "rcon.password"=&gt;"", "rcon.port"=&gt;"25575", "server-ip"=&gt;"", "server-name"=&gt;"Housepub", "server-port"=&gt;"25565", "snooper-enabled"=&gt;"false", "spawn-animals"=&gt;true, "spawn-monsters"=&gt;true, "spawn-npcs"=&gt;true, "spawn-protection"=&gt;1, "texture-pack"=&gt;"", "view-distance"=&gt;10, "white-list"=&gt;false}
</code></p>

<p>And I can see where these were set using the <code>#debug_value</code> method. Each sub-attribute should be passed as an argument.</p>

<p><code>
chef &gt; pp node.debug_value('minecraft', 'properties')
[["set_unless_enabled?", false],
 ["default",
  {"allow-flight"=&gt;false,
   "allow-nether"=&gt;true,
   "difficulty"=&gt;1,
   "enable-query"=&gt;false,
   "enable-rcon"=&gt;false,
   "enable-command-block"=&gt;false,
   "force-gamemode"=&gt;false,
   "gamemode"=&gt;0,
   "generate-structures"=&gt;true,
   "hardcore"=&gt;false,
   "level-name"=&gt;"world",
   "level-seed"=&gt;"",
   "level-type"=&gt;"DEFAULT",
   "max-build-height"=&gt;"256",
   "max-players"=&gt;"20",
   "motd"=&gt;"A Minecraft Server",
   "online-mode"=&gt;true,
   "op-permission-level"=&gt;4,
   "player-idle-timeout"=&gt;0,
   "pvp"=&gt;true,
   "query.port"=&gt;"25565",
   "rcon.password"=&gt;"",
   "rcon.port"=&gt;"25575",
   "server-ip"=&gt;"",
   "server-name"=&gt;"Unknown Server",
   "server-port"=&gt;"25565",
   "snooper-enabled"=&gt;true,
   "spawn-animals"=&gt;true,
   "spawn-monsters"=&gt;true,
   "spawn-npcs"=&gt;true,
   "spawn-protection"=&gt;16,
   "texture-pack"=&gt;"",
   "view-distance"=&gt;10,
   "white-list"=&gt;false}],
 ["env_default", :not_present],
 ["role_default",
  {"difficulty"=&gt;"1",
   "gamemode"=&gt;"0",
   "force-gamemode"=&gt;true,
   "motd"=&gt;"It's the will to survive",
   "pvp"=&gt;"false",
   "server-name"=&gt;"Housepub",
   "level-name"=&gt;"creative-survival",
   "spawn-protection"=&gt;1,
   "snooper-enabled"=&gt;"false"}],
 ["force_default", :not_present],
 ["normal", :not_present],
 ["override", :not_present],
 ["role_override", :not_present],
 ["env_override", :not_present],
 ["force_override", :not_present],
 ["automatic", :not_present]]
</code></p>

<p>From the role, we can see some properties attributes are set:</p>

<p><code>ruby
 ["role_default",
  {"difficulty"=&gt;"1",
   "gamemode"=&gt;"0",
   "force-gamemode"=&gt;true,
   "motd"=&gt;"It's the will to survive",
   "pvp"=&gt;"false",
   "server-name"=&gt;"Housepub",
   "level-name"=&gt;"creative-survival",
   "spawn-protection"=&gt;1,
   "snooper-enabled"=&gt;"false"}],
</code></p>

<p>Note that even though these are also set by default, we get them in the output here too.</p>
]]></content>
  </entry>
  
</feed>
