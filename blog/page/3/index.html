
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>jtimberman's Code Blog</title>
  <meta name="author" content="Joshua Timberman">

  
  <meta name="description" content="UPDATE: All non-default profiles must have their profile name start with &ldquo;profile.&rdquo; Below, this is &ldquo;profile nondefault.&rdquo; The &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jtimberman.housepub.org/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="jtimberman's Code Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud?source=profiles" />
<link rel="openid2.local_id" href="http://www.google.com/profiles/100567271038100401523" />

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26031299-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">jtimberman's Code Blog</a></h1>
  
    <h2>Chef, Ops, Ruby, Linux/Unix. Opinions are mine, not my employer's (CHEF).</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jtimberman.housepub.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/19/managing-multiple-aws-account-credentials/">Managing Multiple AWS Account Credentials</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-19T17:55:00-06:00" pubdate data-updated="true">Oct 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>UPDATE</strong>: All non-default profiles must have their profile name
  start with &ldquo;profile.&rdquo; Below, this is &ldquo;profile nondefault.&rdquo; The ruby
  code is updated to reflect this.</p>

<p>In this post, I will describe my local setup for using the
<a href="http://aws.amazon.com/cli/">AWS CLI</a>, the
<a href="http://aws.amazon.com/sdkforruby/">AWS Ruby SDK</a>, and of course the
<a href="http://rubygems.org/gems/knife-ec2">Knife EC2 plugin</a>.</p>

<p>The general practice I&rsquo;ve used is to set the appropriate shell
environment variables that are used by default by these tools (and the
&ldquo;legacy&rdquo; ec2-api-tools, the java-based CLI). Over time and between
tools, there have been several environment variables set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>AWS_ACCESS_KEY_ID
</span><span class='line'>AWS_SECRET_ACCESS_KEY
</span><span class='line'>AWS_DEFAULT_REGION
</span><span class='line'>AWS_SSH_KEY
</span><span class='line'>AMAZON_ACCESS_KEY_ID
</span><span class='line'>AMAZON_SECRET_ACCESS_KEY
</span><span class='line'>AWS_ACCESS_KEY
</span><span class='line'>AWS_SECRET_KEY
</span></code></pre></td></tr></table></div></figure>


<p>There is now a config file (ini-flavored) that can be used to set
credentials, <code>~/.aws/config</code>. Each ini section in this file is a
different account&rsquo;s credentials. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>default<span class="o">]</span>
</span><span class='line'><span class="nv">aws_access_key_id</span><span class="o">=</span>MY_DEFAULT_KEY
</span><span class='line'><span class="nv">aws_secret_access_key</span><span class="o">=</span>MY_DEFAULT_SECRET
</span><span class='line'><span class="nv">region</span><span class="o">=</span>us-east-1
</span><span class='line'><span class="o">[</span>profile nondefault<span class="o">]</span>
</span><span class='line'><span class="nv">aws_access_key_id</span><span class="o">=</span>NOT_MY_DEFAULT_KEY
</span><span class='line'><span class="nv">aws_secret_access_key</span><span class="o">=</span>NOT_MY_DEFAULT_SECRET
</span><span class='line'><span class="nv">region</span><span class="o">=</span>us-east-1
</span></code></pre></td></tr></table></div></figure>


<p>I have two accounts listed here. Obviously, the actual keys are not
listed :). I source a shell script that sets the environment variables
with these values. Before, I maintained a separate script for each
account. Now, I install the <code>inifile</code>
<a href="http://rubygems.org/gems/inifile">RubyGem</a> and use a one-liner for
each of the keys.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="sb">`</span>ruby -rinifile -e <span class="s2">&quot;puts IniFile.load(File.join(File.expand_path(&#39;~&#39;), &#39;.aws&#39;, &#39;config&#39;))[&#39;default&#39;][&#39;aws_access_key_id&#39;]&quot;</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="sb">`</span>ruby -rinifile -e <span class="s2">&quot;puts IniFile.load(File.join(File.expand_path(&#39;~&#39;), &#39;.aws&#39;, &#39;config&#39;))[&#39;default&#39;][&#39;aws_secret_access_key&#39;]&quot;</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_SSH_KEY</span><span class="o">=</span><span class="s1">&#39;jtimberman&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will load the specified file, <code>~/.aws/config</code> with the
<code>IniFile.load</code> method, retrieving the <code>default</code> section&rsquo;s
<code>aws_access_key_id</code> value. Then repeat the same for the
<code>aws_secret_access_key</code>.</p>

<p>To use the nondefault profile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="sb">`</span>ruby -rinifile -e <span class="s2">&quot;puts IniFile.load(File.join(File.expand_path(&#39;~&#39;), &#39;.aws&#39;, &#39;config&#39;))[&#39;profile nondefault&#39;][&#39;aws_access_key_id&#39;]&quot;</span><span class="sb">`</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="sb">`</span>ruby -rinifile -e <span class="s2">&quot;puts IniFile.load(File.join(File.expand_path(&#39;~&#39;), &#39;.aws&#39;, &#39;config&#39;))[&#39;profile nondefault&#39;][&#39;aws_secret_access_key&#39;]&quot;</span><span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that this uses <code>['profile nondefault']</code>.</p>

<p>Since different tools historically have used slightly different
environment variables, I export those too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">AMAZON_ACCESS_KEY_ID</span><span class="o">=</span><span class="nv">$AWS_ACCESS_KEY_ID</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AMAZON_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="nv">$AWS_SECRET_ACCESS_KEY</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY</span><span class="o">=</span><span class="nv">$AWS_ACCESS_KEY_ID</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AWS_SECRET_KEY</span><span class="o">=</span><span class="nv">$AWS_SECRET_ACCESS_KEY</span>
</span></code></pre></td></tr></table></div></figure>


<p>I create a separate config script for each account.</p>

<p>The AWS CLI tool will automatically use the <code>~/.aws/config</code>, and can
load different profiles with the <code>--profile</code> option. The <code>aws-sdk</code>
Ruby library will use the environment variables, however. So
authentication in a Ruby script is automatically set up.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;aws-sdk&#39;</span>
</span><span class='line'><span class="n">iam</span> <span class="o">=</span> <span class="ss">AWS</span><span class="p">:</span><span class="ss">:IAM</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without this, it would be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;aws-sdk&#39;</span>
</span><span class='line'><span class="n">iam</span> <span class="o">=</span> <span class="ss">AWS</span><span class="p">:</span><span class="ss">:IAM</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:access_key_id</span> <span class="o">=&gt;</span> <span class="s1">&#39;YOUR_ACCESS_KEY_ID&#39;</span><span class="p">,</span>
</span><span class='line'>                   <span class="ss">:secret_access_key</span> <span class="o">=&gt;</span> <span class="s1">&#39;YOUR_SECRET_ACCESS_KEY&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which is a little ornerous.</p>

<p>To use this with <code>knife-ec2</code>, I have the following in my
<code>.chef/knife.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">knife</span><span class="o">[</span><span class="ss">:aws_access_key_id</span><span class="o">]</span>      <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;AWS_ACCESS_KEY_ID&#39;</span><span class="o">]</span>
</span><span class='line'><span class="n">knife</span><span class="o">[</span><span class="ss">:aws_secret_access_key</span><span class="o">]</span>  <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;AWS_SECRET_ACCESS_KEY&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Naturally, since <code>knife.rb</code> is Ruby, I could use <code>Inifile.load</code> there,
but I only started using that library recently, and I have my knife
configuration setup already.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/10/preview-chef-client-local-mode/">Preview Chef Client Local Mode</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-10T23:39:00-06:00" pubdate data-updated="true">Oct 10<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Opscode Developer John Keiser
<a href="https://twitter.com/jkeiser2/status/388460927026085888">mentioned</a>
that a feature for Chef Zero he&rsquo;s been working on, &ldquo;local mode,&rdquo; is
now in Chef&rsquo;s master branch. This means it should be in the next
release (11.8). I took the liberty to check this <em>unreleased</em> feature
out.</p>

<p>Let&rsquo;s just say, it&rsquo;s super awesome and John has done some amazing work
here.</p>

<h2>PREVIEW</h2>

<p>This is a preview of an unreleased feature in Chef. All standard
disclaimers apply :).</p>

<h2>Install</h2>

<p>This is in the master branch of Chef, not released as a gem yet.
You&rsquo;ll need to get the source and build a gem locally. This totally
assumes you&rsquo;ve installed a sane ruby and bundler on your system.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git clone git://github.com/opscode/chef.git
</span><span class='line'><span class="nb">cd </span>chef
</span><span class='line'>bundle install
</span><span class='line'>bundle <span class="nb">exec </span>rake gem
</span><span class='line'>gem install  pkg/chef-11.8.0.alpha.0.gem
</span></code></pre></td></tr></table></div></figure>


<p><strong>Note</strong> Alpha!</p>

<h2>Setup</h2>

<p>Next, point it at a local repository. I&rsquo;ll use a simple example.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git clone git://github.com/opscode/chef-repo.git
</span><span class='line'><span class="nb">cd </span>chef-repo
</span><span class='line'>knife cookbook create zero -o ./cookbooks
</span><span class='line'>vi cookbooks/zero/recipes/default.rb
</span></code></pre></td></tr></table></div></figure>


<p>I created a fairly trivial example recipe to show that this will
support search, and data bag items:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s2">&quot;*:*&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">b</span> <span class="o">=</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s2">&quot;zero&quot;</span><span class="p">,</span> <span class="s2">&quot;fluff&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">file</span> <span class="s2">&quot;/tmp/zerofiles&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="n">a</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">to_s</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">file</span> <span class="s2">&quot;/tmp/fluff&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="n">b</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This simply searches for all nodes, and uses the content of the first
node (the one we&rsquo;re running on presumably) for a file in /tmp. It also
loads a data bag item (which I created) and uses it for the content of
another file in /tmp.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mkdir -p data_bags/zero
</span><span class='line'>vi data_bags/zero/fluff.json
</span></code></pre></td></tr></table></div></figure>


<p>The data bag item:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;fluff&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;clouds&quot;</span><span class="p">:</span> <span class="s2">&quot;Are fluffy&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Converge!</h2>

<p>Now, converge the node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>chef-client -z -o zero
</span></code></pre></td></tr></table></div></figure>


<p>The <code>-z</code>, or <code>--local-mode</code> argument is the magic that sets up Chef
Zero, and loads all the contents of the repository. The <code>-o zero</code>
tells Chef to use a one time run list of the &ldquo;zero&rdquo; recipe.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>2013-10-10T23:53:32-06:00<span class="o">]</span> WARN: No config file found or specified on <span class="nb">command </span>line, not loading.
</span><span class='line'>Starting Chef Client, version 11.8.0.alpha.0
</span><span class='line'><span class="o">[</span>2013-10-10T23:53:36-06:00<span class="o">]</span> WARN: Run List override has been provided.
</span><span class='line'><span class="o">[</span>2013-10-10T23:53:36-06:00<span class="o">]</span> WARN: Original Run List: <span class="o">[</span>recipe<span class="o">[</span>zero<span class="o">]]</span>
</span><span class='line'><span class="o">[</span>2013-10-10T23:53:36-06:00<span class="o">]</span> WARN: Overridden Run List: <span class="o">[</span>recipe<span class="o">[</span>zero<span class="o">]]</span>
</span><span class='line'>resolving cookbooks <span class="k">for </span>run list: <span class="o">[</span><span class="s2">&quot;zero&quot;</span><span class="o">]</span>
</span><span class='line'>Synchronizing Cookbooks:
</span><span class='line'>  - zero
</span><span class='line'>Compiling Cookbooks...
</span><span class='line'>Converging 2 resources
</span><span class='line'>Recipe: zero::default
</span><span class='line'>  * file<span class="o">[</span>/tmp/zerofiles<span class="o">]</span> action create
</span><span class='line'>    - create new file /tmp/zerofiles
</span><span class='line'>    - update content in file /tmp/zerofiles from none to 0a038a
</span><span class='line'>        --- /tmp/zerofiles      2013-10-10 23:53:36.368059768 -0600
</span><span class='line'>        +++ /tmp/.zerofiles20131010-6903-10cvytu        2013-10-10 23:53:36.368059768 -0600
</span><span class='line'>        @@ -1 +1,2 @@
</span><span class='line'>        +node<span class="o">[</span>jenkins.int.housepub.org<span class="o">]</span>
</span><span class='line'>  * file<span class="o">[</span>/tmp/fluff<span class="o">]</span> action create
</span><span class='line'>    - create new file /tmp/fluff
</span><span class='line'>    - update content in file /tmp/fluff from none to d46bab
</span><span class='line'>        --- /tmp/fluff  2013-10-10 23:53:36.372059683 -0600
</span><span class='line'>        +++ /tmp/.fluff20131010-6903-1l3i1h     2013-10-10 23:53:36.372059683 -0600
</span><span class='line'>        @@ -1 +1,2 @@
</span><span class='line'>        +data_bag_item<span class="o">[</span>fluff<span class="o">]</span>
</span><span class='line'>Chef Client finished, 2 resources updated
</span></code></pre></td></tr></table></div></figure>


<p>The diff output from each of the file resources shows that the content
does in fact come from the search (a node object was returned) and a
data bag item (a data bag item object was returned).</p>

<h2>What&rsquo;s Next?</h2>

<p>Since this is a feature of Chef, it will be documented and released,
so look for that in the next version of Chef.</p>

<p>I can see this used for testing purposes, especially for recipes that
make use of combinations of data bags and search, such as Opscode&rsquo;s
<a href="http://community.opscode.com/cookbooks/nagios">nagios cookbook</a>.</p>

<h2>Questions</h2>

<ul>
<li>Does it work with Berkshelf?</li>
</ul>


<p>I don&rsquo;t know. Probably not (yet).</p>

<ul>
<li>Does it work with Test Kitchen?</li>
</ul>


<p>I don&rsquo;t know. Probalby not (yet). Provisioners in test-kitchen
would need to be (re)written.</p>

<ul>
<li>Should I use this in production?</li>
</ul>


<p>This is an unreleased feature in the master branch. What do you think?
:)</p>

<ul>
<li>When will this be released?</li>
</ul>


<p>I don&rsquo;t know the schedule for 11.8.0. Soon?</p>

<ul>
<li>Where do I find out more, or get involved?</li>
</ul>


<p>Join #chef-hacking in irc.freenode.net, the chef-dev mailing list, or
attend the Chef Community Summit (November 12-13, 2013 in Seattle).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/23/switching-myopenid-to-google-openid/">Switching MyOpenID to Google OpenID</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-23T10:38:00-06:00" pubdate data-updated="true">Sep 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You may be aware that MyOpenID is
<a href="http://thenextweb.com/insider/2013/09/04/myopenid-to-shut-down/">shutting down in February 2014</a>.</p>

<p>The next best thing to use IMO, is Google&rsquo;s OpenID, since they have
2-factor authentication. Google doesn&rsquo;t really expose the OpenID URL
in a way that makes it as easy to use as &ldquo;username.myopenid.com.&rdquo;
Fortunately, it&rsquo;s relatively simple to add to a custom domain hosted
by, for example, <a href="http://pages.github.com/">GitHub pages</a>. My
coworker, Stephen Delano, pointed me to this pro-tip.</p>

<p>The requirement is to put a <code>&lt;link&gt;</code> tag in the HTML header of the
site. It should look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;openid2.provider&quot;</span> <span class="na">href=</span><span class="s">&quot;https://www.google.com/accounts/o8/ud?source=profiles&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;openid2.local_id&quot;</span> <span class="na">href=</span><span class="s">&quot;http://www.google.com/profiles/A_UNIQUE_GOOGLE_PROFILE_ID</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Obviously you need a Google Profile, but anyone interested in doing
this probably has a Google+ account for Google Hangouts anyway :).</p>

<p>If you&rsquo;re like me and have your custom domain hosted as an
<a href="http://octopress.org/">Octopress</a> blog, this goes in
<code>source/_includes/custom/head.html</code>. Then deploy the site and in a few
moments you&rsquo;ll be able to start using your site as an OpenID.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/10/managing-secrets-with-chef-vault/">Managing Secrets With Chef Vault</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-10T09:30:00-06:00" pubdate data-updated="true">Sep 10<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Two years ago, I wrote a post about
<a href="http://jtimberman.housepub.org/blog/2011/08/06/encrypted-data-bag-for-postfix-sasl-authentication/">using Chef encrypted data bags</a>
for SASL authentication with Postfix. At the time, my ISP didn&rsquo;t allow
non-authenticated SMTP, so I had to find a solution so I could get
cronspam and other vital email from my servers at home. I&rsquo;ve since
switched ISPs to one that doesn&rsquo;t care so much about this, so I&rsquo;m not
using any of that code anymore.</p>

<p>However, that doesn&rsquo;t mean I don&rsquo;t have secrets to manage! I actually
don&rsquo;t for my personal systems due to what I&rsquo;m managing with Chef now,
but we certainly do for Opscode&rsquo;s hosted Enterprise Chef environment.
The usual suspects for any web application are required: database
passwords, SSL certificates, service API tokens, etc.</p>

<p>We&rsquo;re evaluating chef-vault as a possible solution. This blog post
will serve as notes for me so I can remember what I did when my
terminal history is gone, and hopefully information for you to be able
to use in your own environment.</p>

<h1>Chef Vault</h1>

<p>Chef Vault is an
<a href="https://github.com/Nordstrom/chef-vault">open source project</a>
published by <a href="http://nordstrom.com">Nordstrom</a>. It is distributed as a
RubyGem. You&rsquo;ll need it installed on your local workstation so you can
encrypt sensitive secrets, and on any systems that need to decrypt
said secrets. Since the workstation is where we&rsquo;re going to start,
install the gem. I&rsquo;ll talk about using this in a recipe later.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% gem install chef-vault</span></code></pre></td></tr></table></div></figure>


<h1>Use Cases</h1>

<p>Now, for the use cases, I&rsquo;m going to take two fairly simple examples,
and explain how chef-vault works along the way.</p>

<ol>
<li>A username/password combination. The <code>vaultuser</code> will be created on
the system with Chef&rsquo;s built-in <code>user</code> resource.</li>
<li>A file with sensitive content. In this case, I&rsquo;m going to use a
junk RSA private key for <code>vaultuser</code>.</li>
</ol>


<p>Secrets are generally one of these things. Either a value passed into
a command-line program (like <code>useradd</code>) or a file that should live on
disk (like an SSL certificate or RSA key).</p>

<h1>Command-line Structure</h1>

<p>Chef Vault includes knife plugins to allow you to manage the secrets
from your workstation, uploading them to the Chef Server just like
normal data bags. The secrets themselves live in Data Bags on the Chef
Server. The &ldquo;bag&rdquo; is called the &ldquo;vault&rdquo; for chef-vault.</p>

<p>After installation, the <code>encrypt</code> and <code>decrypt</code> sub-commands will be
available for knife.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>knife encrypt create [VAULT] [ITEM] [VALUES] --mode MODE --search SEARCH --admins ADMINS --json FILE
</span><span class='line'>knife encrypt delete [VAULT] [ITEM] --mode MODE
</span><span class='line'>knife encrypt remove [VAULT] [ITEM] [VALUES] --mode MODE --search SEARCH --admins ADMINS
</span><span class='line'>knife rotate secret [VAULT] [ITEM] --mode MODE
</span><span class='line'>knife encrypt update [VAULT] [ITEM] [VALUES] --mode MODE --search SEARCH --admins ADMINS --json FILE
</span><span class='line'>knife decrypt [VAULT] [ITEM] [VALUES] --mode MODE</span></code></pre></td></tr></table></div></figure>


<p>The
<a href="https://github.com/Nordstrom/chef-vault/blob/master/README.md">README</a>
and
<a href="https://github.com/Nordstrom/chef-vault/blob/master/KNIFE_EXAMPLES.md">Examples</a>
document these quite well.</p>

<h2>Mode: Solo vs Client</h2>

<p>I&rsquo;m using Chef with a Chef Server (Enterprise Chef), so I&rsquo;ll specify
<code>--mode client</code> for the knife commands.</p>

<p>It is important to note the <code>MODE</code> in the chef-vault knife plugin
commands affects where the encrypted data bags will be saved. Chef
supports data bags with both Solo and Client/Server use. When using
chef-solo, you&rsquo;ll need to configure <code>data_bag_path</code> in your
<code>knife.rb</code>. That is, even if you&rsquo;re using Solo, since these are knife
plugins, the configuration is for knife, not chef-solo. I&rsquo;m using a
Chef Server though, so I&rsquo;m going to use <code>--mode client</code>.</p>

<h1>Create a User with a Password</h1>

<p>The user I&rsquo;m going to create is the arbitrarily named <code>vaultuser</code>,
with the super secret password, <code>chef-vault</code>. I&rsquo;m going to use this on
a Linux system with SHA512 hashing, so first I generate a password
using mkpasswd:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% mkpasswd -m sha-512
</span><span class='line'>Password: chef-vault
</span><span class='line'>$6$VqEIDjsp$7NtPMhA9cnxvSMTE9l7DMmydJJEymi9b4t1Vhk475vrWlfxMgVb3bDLhpk/RZt0J3X7l5H8WnqFgvq3dIa9Kt/</span></code></pre></td></tr></table></div></figure>


<p><strong>Note</strong>: This is the <code>mkpasswd(1)</code> command from the Ubuntu 10.04
  <a href="http://packages.ubuntu.com/lucid/mkpasswd">mkpasswd package</a>.</p>

<h2>Create the Item</h2>

<p>The command I&rsquo;m going to use is <code>knife encrypt create</code> since this is a
new secret. I&rsquo;ll show two examples. First, I&rsquo;ll pass in the raw JSON
data as &ldquo;values&rdquo;. You would do this if you&rsquo;re not going to store the
unencrypted secret on disk or in a repository. Second, I&rsquo;ll pass a
JSON file. You would do this if you want to store the unencrypted
secret on disk or in a repository.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife encrypt create secrets vaultuser \
</span><span class='line'>  '{"vaultuser":"$6$VqEIDjsp$7NtPMhA9cnxvSMTE9l7DMmydJJEymi9b4t1Vhk475vrWlfxMgVb3bDLhpk/RZt0J3X7l5H8WnqFgvq3dIa9Kt/"}' \
</span><span class='line'>  --search 'role:base' \
</span><span class='line'>  --admins jtimberman --mode client</span></code></pre></td></tr></table></div></figure>


<p>The <code>[VALUES]</code> in this command is raw JSON that will be created in the
data bag item by <code>chef-vault</code>. The <code>--search</code> option tells chef-vault
to use the <strong>public</strong> keys of the nodes matching the SOLR query for
encrypting the value. Then during the Chef run, chef-vault uses those
node&rsquo;s <strong>private</strong> keys to decrypt the value. The <code>--admins</code> option tells chef-vault
the list of users on the Chef Server who are also allowed to decrypt
the secret. This is specified as a comma separated string for
multiple admins. Finally, as I mentioned, I&rsquo;m using a Chef Server so I
need to specify <code>--mode client</code>, since &ldquo;solo&rdquo; is the default.</p>

<p>Here&rsquo;s the equivalent, using a JSON file named <code>secrets_vaultuser.json</code>. It has the content:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;vaultuser&quot;</span><span class="p">:</span><span class="s2">&quot;$6$VqEIDjsp$7NtPMhA9cnxvSMTE9l7DMmydJJEymi9b4t1Vhk475vrWlfxMgVb3bDLhpk/RZt0J3X7l5H8WnqFgvq3dIa9Kt/&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The command is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife encrypt create secrets vaultuser \
</span><span class='line'>  --json secrets_vaultuser.json
</span><span class='line'>  --search &#39;role:base&#39; \
</span><span class='line'>  --admins jtimberman --mode client
</span></code></pre></td></tr></table></div></figure>


<p>Now, let&rsquo;s see what has been created on the Chef Server. I&rsquo;ll use the
core Chef knife plugin, <code>data bag item show</code> for this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife data bag show secrets
</span><span class='line'>vaultuser
</span><span class='line'>vaultuser_keys
</span></code></pre></td></tr></table></div></figure>


<p>I now have a &ldquo;secrets&rdquo; data bag, with two items. The first,
<code>vaultuser</code> is the one that contains the actual secret. Let&rsquo;s see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife data bag show secrets vaultuser
</span><span class='line'>id:        vaultuser
</span><span class='line'>vaultuser:
</span><span class='line'>  cipher:         aes-256-cbc
</span><span class='line'>  encrypted_data: j+/fFM7ist6I7K360GNfzSgu6ix63HGyXN2ZAd99R6H4TAJ4pQKuFNpJXYnC
</span><span class='line'>  SXA5n68xn9frxHAJNcLuDXCkEv+F/MnW9vMlTaiuwW/jO++vS5mIxWU170mR
</span><span class='line'>  EgeB7gvPH7lfUdJFURNGQzdiTSSFua9E06kAu9dcrT83PpoQQzk=
</span><span class='line'>  iv:             cu2Ugw+RpTDVRu1QaaAfug==
</span><span class='line'>  version:        1
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, I have encrypted data. I also told chef-vault that my
user can decrypt this. I need to use the knife plugin to do so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife decrypt secrets vaultuser &#39;vaultuser&#39; --mode client
</span><span class='line'>secrets/vaultuser
</span><span class='line'>  vaultuser: $6$VqEIDjsp$7NtPMhA9cnxvSMTE9l7DMmydJJEymi9b4t1Vhk475vrWlfxMgVb3bDLhpk/RZt0J3X7l5H8WnqFgvq3dIa9Kt/
</span></code></pre></td></tr></table></div></figure>


<p>The <code>'vaultuser'</code> in quotes is the key from the hash of JSON data that
I specified earlier. As you can see, the password is that which was
generated from the mkpasswd command earlier.</p>

<p>But what nodes have access to decrypt this password? That&rsquo;s what
chef-vault stored in the <code>vaultuser_keys</code> item. Let&rsquo;s look:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife data bag show secrets vaultuser_keys
</span><span class='line'>admins:              jtimberman
</span><span class='line'>clients:
</span><span class='line'>  os-945926465950316
</span><span class='line'>  os-2790002246935003
</span><span class='line'>id:                  vaultuser_keys
</span><span class='line'>jtimberman:          0Q2bhw/kJl2aIVEwqY6wYhrrfdz9fdsf8tCiIrBih2ZORvV7EEIpzzKQggRX
</span><span class='line'>4P4vnVQjMjfkRwIXndTzctCJONQYF50OSZi5ByXWqbich9iCWvVIbnhcLWSp
</span><span class='line'>z5mQoSTNXyZz/JQZGnubkckh4wGLBFDrLJ6WKl6UNXH1dRwqDNo5sEK7/3Wn
</span><span class='line'>b4ztVSRxzB01wVli0wLvFSZzGsKYJYINBcidnbIgLh/xGYGtBJVlgG2z/7TV
</span><span class='line'>uN0b/qvGj8VlhbS6zPlwh39O3mexDdkLwry/+gbO1nj8qKNkKDKaix5zypwE
</span><span class='line'>XdmdfMKNYGaM6kzG8cwuKZXLAgGAgblVUB1HP8+8kQ==
</span><span class='line'>
</span><span class='line'>os-2790002246935003: kGQLsxsFmBe9uPuWxZpKiNBnqJq55hQZJLgaKdjG2Vvivv98RrFGz1y8Xbwe
</span><span class='line'>uzeSgPgAURCZmxpNxpHrwvvKcvL77sBOL6TTKiNzs8n5B3ZOawy17dsuG24v
</span><span class='line'>41R0cRMnYLgbLcjln9dpVe4Esr4goPxko+1XqBPik1SBapthQq/pLUJ1BIKh
</span><span class='line'>Fxu1QVGj1w4HPUftLaUzeS33jKbtfvgZyZsYZBdVCVEVidOxC90WRf4wtkd6
</span><span class='line'>Ueyj+0gd1QKv84Q387O1R5LtRMS6u+17PJinrcRIkVNZ6P1z6oT2Dasfvrex
</span><span class='line'>rK3s5vD7v6jpkUW12Wj74Lz3Z6x3sKuIDzCtvEUnWw==
</span><span class='line'>
</span><span class='line'>os-945926465950316:  XzTJrJ3TZZZ1u9L9p6DZledf3bo2ToH2yrLGZQKPV6/ANzElHXGcYrEdtP0q
</span><span class='line'>14Nz1NzsqEftzviAebUUnc6ke91ltD8s6hNQQrPJRqkUoDlM7lNEwiUiz/dD
</span><span class='line'>+sFI6CSzQptO3zPrUbAlUI1Zog5h7k/CCtiYtmFRD6wbAWnxmCqvLhO1jwqL
</span><span class='line'>VNJ1vfjlFsG77BDm2HFw7jgleuxRGYEgBfCCuBuW70FAdUTvNHIAwKQVkfU/
</span><span class='line'>Am75UYm7N4N0E+W76ZwojLoYtXXTV/iOGG1cw3C75SVAmCsBOuxUK/otub67
</span><span class='line'>zsNDsKToKa+laxzXGylrmkTricYXIqVpIQO8OL5nnw==
</span></code></pre></td></tr></table></div></figure>


<p>As we can see, I have two nodes that are API clients with access to
decrypt the data bag items. These values are all generated by
chef-vault, and I&rsquo;ll talk about how to update the list and rotate
secrets later in this post.</p>

<h2>Manage a User Password</h2>

<p>Let&rsquo;s manage a user resource with a password set to the value from our
encrypted data bag using Chef Vault.</p>

<p>First, I created a cookbook named <code>vault</code>, and added it to the base
role. It contains the following recipe:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chef_gem</span> <span class="s2">&quot;chef-vault&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;chef-vault&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">vault</span> <span class="o">=</span> <span class="ss">ChefVault</span><span class="p">:</span><span class="ss">:Item</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;secrets&quot;</span><span class="p">,</span> <span class="s2">&quot;vaultuser&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">user</span> <span class="s2">&quot;vaultuser&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">password</span> <span class="n">vault</span><span class="o">[</span><span class="s1">&#39;vaultuser&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">home</span> <span class="s2">&quot;/home/vaultuser&quot;</span>
</span><span class='line'>  <span class="n">supports</span> <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class='line'>  <span class="n">comment</span> <span class="s2">&quot;Chef Vault User&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let me break this down.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chef_gem</span> <span class="s2">&quot;chef-vault&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;chef-vault&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>chef-vault</code> is distributed as a RubyGem, and I want to use it in my
recipe(s), so here I use the
<a href="http://docs.opscode.com/resource_chef_gem.html"><code>chef_gem</code> resource</a>.
Then, I require it like any other Ruby library.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">vault</span> <span class="o">=</span> <span class="ss">ChefVault</span><span class="p">:</span><span class="ss">:Item</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;secrets&quot;</span><span class="p">,</span> <span class="s2">&quot;vaultuser&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is where the decryption happens. If I do this under a
<code>chef-shell</code>, I can see:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>chef:recipe &gt; vault = ChefVault::Item.load(&quot;secrets&quot;, &quot;vaultuser&quot;)
</span><span class='line'> =&gt; data_bag_item[&quot;secrets&quot;, &quot;vaultuser&quot;, {&quot;id&quot;=&gt;&quot;vaultuser&quot;, &quot;vaultuser&quot;=&gt;&quot;$6$VqEIDjsp$7NtPMhA9cnxvSMTE9l7DMmydJJEymi9b4t1Vhk475vrWlfxMgVb3bDLhpk/RZt0J3X7l5H8WnqFgvq3dIa9Kt/&quot;}]
</span></code></pre></td></tr></table></div></figure>


<p><code>ChefVault::Item.load</code> takes two arguments, the &ldquo;vault&rdquo; or data bag,
in this case <code>secrets</code>, and the &ldquo;item&rdquo;, in this case <code>vaultuser</code>. It
returns a data bag item. Then in the
<a href="http://docs.opscode.com/resource_user.html"><code>user</code> resource</a>, I use
the password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">user</span> <span class="s2">&quot;vaultuser&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">password</span> <span class="n">vault</span><span class="o">[</span><span class="s1">&#39;vaultuser&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">home</span> <span class="s2">&quot;/home/vaultuser&quot;</span>
</span><span class='line'>  <span class="n">supports</span> <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">shell</span> <span class="s2">&quot;/bin/bash&quot;</span>
</span><span class='line'>  <span class="n">comment</span> <span class="s2">&quot;Chef Vault User&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The important resource attribute here is <code>password</code>, where I&rsquo;m using
the local variable, <code>vault</code> and the <code>vaultuser</code> key from the item as
decrypted by <code>ChefVault::Item.load</code>. When Chef runs, it will look like
this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Recipe: vault::default
</span><span class='line'>  * chef_gem[chef-vault] action install
</span><span class='line'>    - install version 2.0.1 of package chef-vault
</span><span class='line'>  * chef_gem[chef-vault] action install (up to date)
</span><span class='line'>  * user[vaultuser] action create
</span><span class='line'>    - create user user[vaultuser]
</span></code></pre></td></tr></table></div></figure>


<p>Now, I can su to <code>vaultuser</code> using the password I created:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>ubuntu@-2790002246935003:~$ su - vaultuser
</span><span class='line'>Password: chef-vault
</span><span class='line'>vaultuser@os-2790002246935003:~$ id
</span><span class='line'>uid=1001(vaultuser) gid=1001(vaultuser) groups=1001(vaultuser)
</span><span class='line'>vaultuser@os-2790002246935003:~$ pwd
</span><span class='line'>/home/vaultuser
</span></code></pre></td></tr></table></div></figure>


<p>Yay! To show that the user was created with the right password,
here&rsquo;s the DEBUG log output:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>INFO: Processing user[vaultuser] action create ((irb#1) line 12)
</span><span class='line'>DEBUG: user[vaultuser] user does not exist
</span><span class='line'>DEBUG: user[vaultuser] setting comment to Chef Vault User
</span><span class='line'>DEBUG: user[vaultuser] setting password to $6$VqEIDjsp$7NtPMhA9cnxvSMTE9l7DMmydJJEymi9b4t1Vhk475vrWlfxMgVb3bDLhpk/RZt0J3X7l5H8WnqFgvq3dIa9Kt/
</span><span class='line'>DEBUG: user[vaultuser] setting shell to /bin/bash
</span><span class='line'>INFO: user[vaultuser] created
</span></code></pre></td></tr></table></div></figure>


<p>Next, I&rsquo;ll create a secret that is a file rendered on the system.</p>

<h1>Create a Private SSH Key</h1>

<p>Suppose this <code>vaultuser</code> is to be used for deploying code by cloning a
repository. It will need a private SSH key to authenticate, so I&rsquo;ll
create one, with an empty passphrase in this case.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% ssh-keygen -b 4096 -t rsa -f vaultuser-ssh
</span><span class='line'>Generating public/private rsa key pair.
</span><span class='line'>Enter passphrase (empty for no passphrase):
</span><span class='line'>Enter same passphrase again:
</span><span class='line'>Your identification has been saved in vaultuser-ssh.
</span><span class='line'>Your public key has been saved in vaultuser-ssh.pub.
</span></code></pre></td></tr></table></div></figure>


<p>Get the SHA256 checksum of the private key. I use SHA256 because
that&rsquo;s what Chef uses for file content. We&rsquo;ll use this to verify
content later.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% sha256sum vaultuser-ssh
</span><span class='line'>a83221c243c9d39d20761e87db6c781ed0729b8ff4c3b330214ebca26e2ea89d  vaultuser-ssh
</span></code></pre></td></tr></table></div></figure>


<p>Assume that I also
<a href="https://help.github.com/articles/generating-ssh-keys">created the SSH key on GitHub</a>
for this user.</p>

<p>In order to have a file&rsquo;s contents be a JSON value for the data bag
item, I&rsquo;ll remove the newlines (<code>\n</code>), and generate the JSON:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>ruby -rjson -e &#39;puts JSON.generate({&quot;vaultuser-ssh-private&quot; =&gt; File.read(&quot;vaultuser-ssh&quot;)})&#39; \
</span><span class='line'>  &gt; secrets_vaultuser-ssh-private.json
</span></code></pre></td></tr></table></div></figure>


<p>Now, create the secret on the Chef Server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>knife encrypt create secrets vaultuser-ssh-private \
</span><span class='line'>  --search &#39;role:base&#39; \
</span><span class='line'>  --json secrets_vaultuser-ssh-private.json \
</span><span class='line'>  --admins jtimberman \
</span><span class='line'>  --mode client
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s verify the server has what we need:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife data bag show secrets vaultuser-ssh-private
</span><span class='line'>id:                    vaultuser-ssh-private
</span><span class='line'>vaultuser-ssh-private:
</span><span class='line'>  cipher:         aes-256-cbc
</span><span class='line'>  encrypted_data: mRRToM2N/0F+OyJxkYlHo/cUtHSIuy69ROAKuGoHIhX9Fr5vFTCM4RyWQSTN
</span><span class='line'>  trimmed for brevity even though scrollbars
</span><span class='line'>% knife decrypt secrets vaultuser-ssh-private &#39;vaultuser-ssh-private&#39; --mode client
</span><span class='line'>secrets/vaultuser-ssh-private
</span><span class='line'>  vaultuser-ssh-private: -----BEGIN RSA PRIVATE KEY-----
</span><span class='line'>trimmed for brevity even though scrollbars
</span></code></pre></td></tr></table></div></figure>


<h2>Manage the Key File</h2>

<p>Now, I&rsquo;ll manage the private key file with the vault cookbook.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">vault_ssh</span> <span class="o">=</span> <span class="ss">ChefVault</span><span class="p">:</span><span class="ss">:Item</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;secrets&quot;</span><span class="p">,</span> <span class="s2">&quot;vaultuser-ssh-private&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">directory</span> <span class="s2">&quot;/home/vaultuser/.ssh&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s2">&quot;vaultuser&quot;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s2">&quot;vaultuser&quot;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0700</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">file</span> <span class="s2">&quot;/home/vaultuser/.ssh/id_rsa&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="n">vault_ssh</span><span class="o">[</span><span class="s2">&quot;vaultuser-ssh-private&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s2">&quot;vaultuser&quot;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s2">&quot;vaultuser&quot;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0600</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, let&rsquo;s break this up a bit. First, load the item from the
encrypted data bag like we did before.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">vault_ssh</span> <span class="o">=</span> <span class="ss">ChefVault</span><span class="p">:</span><span class="ss">:Item</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;secrets&quot;</span><span class="p">,</span> <span class="s2">&quot;vaultuser-ssh-private&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, make sure that the vaultuser has an <code>.ssh</code> directory with the
correct permissions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">directory</span> <span class="s2">&quot;/home/vaultuser/.ssh&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s2">&quot;vaultuser&quot;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s2">&quot;vaultuser&quot;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0700</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, manage the content of the private key file with a <code>file</code>
resource and the <code>content</code> resource attribute. The value of
<code>vault_ssh["vaultuser-ssh-private"]</code> will be a string, with <code>\n</code>&rsquo;s
embedded, but when it&rsquo;s rendered on disk, it will display properly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">file</span> <span class="s2">&quot;/home/vaultuser/.ssh/id_rsa&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="n">vault_ssh</span><span class="o">[</span><span class="s2">&quot;vaultuser-ssh-private&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">owner</span> <span class="s2">&quot;vaultuser&quot;</span>
</span><span class='line'>  <span class="n">group</span> <span class="s2">&quot;vaultuser&quot;</span>
</span><span class='line'>  <span class="n">mode</span> <span class="mo">0600</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now run chef on a target node:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Recipe: vault::default
</span><span class='line'>  * chef_gem[chef-vault] action install (up to date)
</span><span class='line'>  * user[vaultuser] action create (up to date)
</span><span class='line'>  * directory[/home/vaultuser/.ssh] action create
</span><span class='line'>    - create new directory /home/vaultuser/.ssh
</span><span class='line'>    - change mode from &#39;&#39; to &#39;0700&#39;
</span><span class='line'>    - change owner from &#39;&#39; to &#39;vaultuser&#39;
</span><span class='line'>    - change group from &#39;&#39; to &#39;vaultuser&#39;
</span><span class='line'>
</span><span class='line'>  * file[/home/vaultuser/.ssh/id_rsa] action create
</span><span class='line'>    - create new file /home/vaultuser/.ssh/id_rsa with content checksum a83221
</span><span class='line'>        --- /tmp/chef-tempfile20130909-1918-1v5hezo   2013-09-09 22:41:21.887239999 +0000
</span><span class='line'>        +++ /tmp/chef-diff20130909-1918-xwbmsn    2013-09-09 22:41:21.883240065 +0000
</span><span class='line'>        @@ -0,0 +1,51 @@
</span><span class='line'>        +-----BEGIN RSA PRIVATE KEY-----
</span><span class='line'>        +MIIJJwIBAAKCAgEAtZmwFTlVOBbr2ZfG+cDtUGx04xCcgaa0p0ISmeyMEoGYH/CP
</span><span class='line'>        output trimmed because its long even though scrollbars again
</span></code></pre></td></tr></table></div></figure>


<p>Note the content checksum, <code>a83221</code>. This will match the checksum of
the source file from earlier (scroll up!), and the one rendered:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>ubuntu@os-2790002246935003:~$ sudo sha256sum /home/vaultuser/.ssh/id_rsa
</span><span class='line'>a83221c243c9d39d20761e87db6c781ed0729b8ff4c3b330214ebca26e2ea89d  /home/vaultuser/.ssh/id_rsa
</span></code></pre></td></tr></table></div></figure>


<p>Yay! Now, we can SSH to GitHub (note, this is fake GitHub for example
purposes).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>ubuntu@os-2790002246935003:~$ su - vaultuser
</span><span class='line'>Password: chef-vault
</span><span class='line'>vaultuser@os-2790002246935003:~$ ssh -i .ssh/id_rsa github@172.31.7.15
</span><span class='line'>$ hostname
</span><span class='line'>os-945926465950316
</span><span class='line'>$ id
</span><span class='line'>uid=1002(github) gid=1002(github) groups=1002(github)
</span></code></pre></td></tr></table></div></figure>


<h1>Updating a Secret</h1>

<p>What happens if we need to update a secret? For example, if an
administrator leaves the organization, we will want to change the
<code>vaultuser</code> password (and SSH private key).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% mkpasswd -m sha-512
</span><span class='line'>Password: gone-user
</span><span class='line'>$6$zM5STNtXdmsrOSm$svJr0tauijqqxTjnMIGJGJPv5V3ovMFCQo.ZDBleiL.yOxcngRqh9yAjpMAsMBA7RlKPv5DKFd1aPZm/wUoKs.
</span></code></pre></td></tr></table></div></figure>


<p>The <code>encrypt create</code> command will return an error if the target
already exists:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife encrypt create secrets vaultuser --search &#39;role:base&#39; --json secrets_vaultuser.json --admins jtimberman --mode client
</span><span class='line'>ERROR: ChefVault::Exceptions::ItemAlreadyExists: secrets/vaultuser already exists, use &#39;knife encrypt remove&#39; and &#39;knife encrypt update&#39; to make changes.
</span></code></pre></td></tr></table></div></figure>


<p>So, I need to use <code>encrypt update</code>. <strong>Note</strong> make sure that the
contents of the JSON file are valid JSON.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife encrypt update secrets vaultuser --search &#39;role:base&#39; --json secrets_vaultuser.json --admins jtimberman --mode client
</span></code></pre></td></tr></table></div></figure>


<p><code>encrypt update</code> only updates the things that change, so I can also
shorten this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife encrypt update secrets vaultuser --json secrets_vaultuser.json --mode client
</span></code></pre></td></tr></table></div></figure>


<p>Since the search and the admins didn&rsquo;t change.</p>

<p>Verify it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife decrypt secrets vaultuser &#39;vaultuser&#39; --mode client
</span><span class='line'>secrets/vaultuser
</span><span class='line'>  vaultuser: $6$zM5STNtXdmsrOSm$svJr0tauijqqxTjnMIGJGJPv5V3ovMFCQo.ZDBleiL.yOxcngRqh9yAjpMAsMBA7RlKPv5DKFd1aPZm/wUoKs.
</span></code></pre></td></tr></table></div></figure>


<p>Now, just run Chef on any nodes affected.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Recipe: vault::default
</span><span class='line'>  * chef_gem[chef-vault] action install (up to date)
</span><span class='line'>  * user[vaultuser] action create
</span><span class='line'>    - alter user user[vaultuser]
</span><span class='line'>
</span><span class='line'>  * directory[/home/vaultuser/.ssh] action create (up to date)
</span><span class='line'>  * file[/home/vaultuser/.ssh/id_rsa] action create (up to date)
</span><span class='line'>Chef Client finished, 1 resources updated
</span></code></pre></td></tr></table></div></figure>


<p>And su to the vault user with the <code>gone-user</code> password:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>ubuntu@os-2790002246935003:~$ su - vaultuser
</span><span class='line'>Password: gone-user
</span><span class='line'>vaultuser@os-2790002246935003:~$
</span></code></pre></td></tr></table></div></figure>


<h1>Managing Access to Items</h1>

<p>There are three common scenarios which require managing the access to an item
in the vault.</p>

<ol>
<li>A system needs to be taken offline, or otherwise prevented from
accessing the item(s).</li>
<li>A new system comes online that needs access.</li>
<li>An admin user has left the organization.</li>
<li>A new admin user has joined the organization.</li>
</ol>


<p>Suppose we have a system that we need to take offline for some reason,
so we want to disable its access to a secret. Or, perhaps we have a
user who has left the organization that was an admin. We can do that in a
few ways.</p>

<h2>Update the Vault Item</h2>

<p>The most straightforward way to manage access to an item is to use the
<code>update</code> or <code>remove</code> sub-commands.</p>

<h3>Remove a System</h3>

<p>Suppose I want to remove node <code>DEADNODE</code>, I can qualify the search to
exclude the node named <code>DEADNODE</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife encrypt update secrets vaultuser \
</span><span class='line'>  --search &#39;role:base NOT name:DEADNODE&#39; \
</span><span class='line'>  --json secrets_vaultuser.json \
</span><span class='line'>  --admins jtimberman --mode client
</span></code></pre></td></tr></table></div></figure>


<p>Note, as before, admins didn&rsquo;t change so I don&rsquo;t need to pass that
argument.</p>

<h3>Add a New System</h3>

<p>If the node has run Chef and is indexed on the Chef Server already,
simply rerun the update command with the search:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife encrypt update secrets vaultuser \
</span><span class='line'>  --search &#39;role:base&#39; \
</span><span class='line'>  --json secrets_vaultuser.json \
</span><span class='line'>  --admins jtimberman --mode client
</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s a bit of a &ldquo;Chicken and Egg&rdquo; problem here, in that a new node
might not be indexed for search if it tried to load the secret during
a bootstrap beforehand. For example, if I create an OpenStack instance
with the base role in its run list, the node doesn&rsquo;t exist for the
search yet. A solution here is to create the node with an empty run
list, allowing it to register with the Chef Server, and then use
<code>knife bootstrap</code> to rerun Chef with the proper run list. This is
annoying, but no one claimed that chef-vault would solve <em>all</em>
problems with shared secret management :&ndash;).</p>

<h3>Remove an Admin</h3>

<p>The admins argument takes a list. Earlier, I only had my userid as an
admin. Suppose I created the item with &ldquo;bofh&rdquo; as an admin too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife encrypt create secrets vaultuser \
</span><span class='line'>  --search &#39;role:base&#39; \
</span><span class='line'>  --json secrets_vaultuser.json \
</span><span class='line'>  --admins &quot;jtimberman,bofh&quot; --mode client
</span></code></pre></td></tr></table></div></figure>


<p>To remove the bofh user, use the <code>encrypt remove</code> subcommand. In this
case, the <code>--admins</code> argument is the list of admins to remove, rather
than add.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife encrypt remove secrets vaultuser --admins bofh --mode client
</span></code></pre></td></tr></table></div></figure>


<h3>Add a New Admin</h3>

<p>I want to add &ldquo;mandi&rdquo; as an administrator because she&rsquo;s awesome and
will help manage our secrets. As above, I just pass a comma-separated
string, <code>"jtimberman,mandi"</code> to the <code>--admins</code> argument.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife encrypt update secrets vaultuser \
</span><span class='line'>  --search &#39;role:base&#39; \
</span><span class='line'>  --json secrets_vaultuser.json \
</span><span class='line'>  --admins &quot;jtimberman,mandi&quot; --mode client
</span></code></pre></td></tr></table></div></figure>


<h2>Regenerate the Client</h2>

<p>The heavyhanded way to remove access is to regenerate the API client
on the Chef Server. For example, of my nodes, say I want to remove
<code>os-945926465950316</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife client reregister os-945926465950316
</span><span class='line'>-----BEGIN RSA PRIVATE KEY-----
</span><span class='line'>MIIEpAIBAAKCAQEAybzwv53tDLIzW+GHRJwLthZmiGTfZVyqQX6m6RGuZjemEIdy
</span><span class='line'>trim trim
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;re familiar with Chef Server&rsquo;s authentication cycle, you&rsquo;ll
know that until that private key is copied to the node, it will
completely fail to authenticate. However, once the
<code>/etc/chef/client.pem</code> file is updated with the content from the knife
command, we&rsquo;ll see that the node fails to read the Chef Vault item:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>================================================================================
</span><span class='line'>Recipe Compile Error in /var/chef/cache/cookbooks/vault/recipes/default.rb
</span><span class='line'>================================================================================
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>OpenSSL::PKey::RSAError
</span><span class='line'>-----------------------
</span><span class='line'>padding check failed
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Cookbook Trace:
</span><span class='line'>---------------
</span><span class='line'>  /var/chef/cache/cookbooks/vault/recipes/default.rb:4:in `from_file&#39;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Relevant File Content:
</span><span class='line'>----------------------
</span><span class='line'>/var/chef/cache/cookbooks/vault/recipes/default.rb:
</span><span class='line'>
</span><span class='line'>  1:  chef_gem &quot;chef-vault&quot;
</span><span class='line'>  2:  require &quot;chef-vault&quot;
</span><span class='line'>  3:
</span><span class='line'>  4&gt;&gt; vault = ChefVault::Item.load(&quot;secrets&quot;, &quot;vaultuser&quot;)
</span><span class='line'>  5:
</span><span class='line'>  6:  user &quot;vaultuser&quot; do
</span><span class='line'>  7:    password vault[&quot;vaultuser&quot;]
</span><span class='line'>  8:    home &quot;/home/vaultuser&quot;
</span><span class='line'>  9:    supports :manage_home =&gt; true
</span><span class='line'> 10:    shell &quot;/bin/bash&quot;
</span><span class='line'> 11:    comment &quot;Chef Vault User&quot;
</span><span class='line'> 12:  end
</span><span class='line'> 13:
</span></code></pre></td></tr></table></div></figure>


<p><strong>Note</strong> I say this is heavy-handed because if you make a mistake, you
  need to re-upload every single secret that this node needs access to.</p>

<h2>Removing Users</h2>

<p>We can also remove user access from Enterprise Chef simply by
disassociating that user from the organization on the Chef Server. I
won&rsquo;t show an example of that here, since I&rsquo;m using Opscode&rsquo;s hosted
Enterprise Chef server and I&rsquo;m the only admin, however :&ndash;).</p>

<h1>Backing Up Secrets</h1>

<p>To back up the secrets, as encrypted data from the Chef Server, use
<code>knife-essentials</code> (comes with Chef 11+, available as a RubyGem for
Chef 10).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>% knife download data_bags/secrets/
</span><span class='line'>Created data_bags/secrets/vaultuser_keys.json
</span><span class='line'>Created data_bags/secrets/vaultuser.json
</span><span class='line'>Created data_bags/secrets/vaultuser-ssh-private_keys.json
</span><span class='line'>Created data_bags/secrets/vaultuser-ssh-private.json
</span></code></pre></td></tr></table></div></figure>


<p>For example, the vaultuser.json file looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;vaultuser&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;vaultuser&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;encrypted_data&quot;</span><span class="p">:</span> <span class="s2">&quot;3yREwInxdyKpf8nuTIivXAeuEzHt7o4vF4FsOwmVLHmMWol5nCBoMWF0YdaW\n3P3NpEAAAxYEYeJYdVkrdLqjjB2kTJdx0+ceh/RBHBWqmSeHOWFH9pCRGjV8\nfS5XaTueShb320b/+Ia8iqUJJWg6utnbJCDx+VMcGNggPXgPKC8=\n&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;iv&quot;</span><span class="p">:</span> <span class="s2">&quot;EI+y74Uj2uwq7EVaP+0K6Q==\n&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;cipher&quot;</span><span class="p">:</span> <span class="s2">&quot;aes-256-cbc&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since these are encrypted using a strong cipher (AES 256), they should
be safe to store in repository. Unless you think the NSA has access to
that repository ;&ndash;).</p>

<h1>Conclusion</h1>

<p>Secrets management is hard! Especially when you need to store secrets
that are used by multiple systems, services, and people. Chef&rsquo;s
encrypted data bag feature isn&rsquo;t a panacea, but it certainly helps.
Hopefully, this blog post was informative. While I don&rsquo;t always
respond, I do read all comments posted here via Disqus, so let me know
if something is out of whack, or needs an update.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/23/getting-started-with-zones-on-omnios/">Getting Started With Zones on OmniOS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-23T23:47:00-06:00" pubdate data-updated="true">Jun 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve become enamored with
<a href="http://wiki.illumos.org/display/illumos/illumos+Home">IllumOS</a>
recently. Years ago, I used Solaris (2.5.1 through 8) at IBM.
Unfortunately (for me), I stopped using it before Solaris 10 brought
all the cool toys to the yard &ndash; zones, zfs, dtrace, SMF. Thanks to
OmniTI&rsquo;s excellent IllumOS distribution,
<a href="http://omnios.omniti.com">OmniOS</a>, I&rsquo;m getting acclimated with the
awesomeness. I plan to write more about my experiences here.</p>

<p>First up, I spent today playing with zones. Zones are a kernel-level
container technology similar to Linux containers/cgroups, or BSD
jails. They&rsquo;re fast and lightweight. At least two of the plans I have
for them:</p>

<ol>
<li>Segregating the services on my home-server.</li>
<li>Adding support to various tools in Chef&rsquo;s ecosystem.</li>
</ol>


<p>The following is basically a compilation of several different blog
posts and documentation collections I&rsquo;ve been poring over. Like most
technical blog writers, I&rsquo;m posting this so I can find it later :&ndash;).</p>

<h2>Hardware</h2>

<p>I have a number of options for learning OmniOS. I have spare hardware,
or VMware, or
<a href="http://omnios.omniti.com/wiki.php/Installation#UsingVagrant">OmniTI&rsquo;s Vagrant box</a>.
I&rsquo;m doing all three of these, but the main use will be on physical
hardware, as I&rsquo;m planning to port the aforementioned server to OmniOS
(#1, above).</p>

<p>The details of the hardware are not important, except that I have a
hard disk device <code>c3t1d0</code>, and a physical NIC device <code>nge1</code> that are
devoted to zones. To adapt these instructions for your own
installation, change those device names where appropriate.</p>

<p>You can find the name of the disk device to use in your system with
the <code>format</code> command.</p>

<pre><code>root@menthe:~# format
Searching for disks...done


AVAILABLE DISK SELECTIONS:
       0. c3t0d0 &lt;ATA-WDCWD1500AHFD-0-7QR5 cyl 18238 alt 2 hd 255 sec 63&gt;
          /pci@0,0/pci1043,cb84@d/disk@0,0
       1. c3t1d0 &lt;ATA-SAMSUNG HD501LJ-0-12-465.76GB&gt;
          /pci@0,0/pci1043,cb84@d/disk@1,0
Specify disk (enter its number): ^D
</code></pre>

<p>Here I wanted to use the Samsung disk.</p>

<p>Use <code>dladm</code> to find the network devices:</p>

<pre><code>root@menthe:~# dladm show-phys
LINK         MEDIA                STATE      SPEED  DUPLEX    DEVICE
nge0         Ethernet             up         1000   full      nge0
nge1         Ethernet             up         1000   full      nge1
</code></pre>

<h2>Setup</h2>

<p>The example zone here is named <code>base</code>. Replace <code>base</code> with any zone
name you wish, e.g. <code>webserver37</code> or <code>noodlebarn</code>. It&rsquo;s also worth
noting that I&rsquo;m going to use DHCP, rather than static networking here.
There are plenty of guides out there for static networking, and I had
to hunt around for DHCP. Also worth noting is that this was all
performed right after installing the OS.</p>

<p>First, create a zpool to use for zones. This is a 500G disk, so I have
plenty of space.</p>

<pre><code>zpool create zones c3t1d0
</code></pre>

<p>Next, create a VNIC on the interface which is devoted to zones
(<code>nge1</code>). It can be named anything, but must end with a number.</p>

<pre><code>dladm create-vnic -l nge1 vnicbase0
</code></pre>

<p>Rather than use the <code>zonecfg</code> REPL, I used the following configuration
file, for repeatability.</p>

<pre><code>create -b
set zonepath=/zones/base
set ip-type=exclusive
set autoboot=false
add net
set physical=vnicbase0
end
commit
</code></pre>

<p>Use this config file to configure the zone with <code>zonecfg</code>.</p>

<pre><code>zonecfg -z base -f base.conf
</code></pre>

<p>Now we&rsquo;re ready to install the OS in the new zone. This may take
awhile as all the packages need to be downloaded.</p>

<pre><code>zoneadm -z base install
</code></pre>

<p>The default <code>nsswitch.conf(4)</code> does not use DNS for hosts. This is
fairly standard for Solaris/IllumOS. Also, the <code>resolv.conf(4)</code> is not
configured automatically, which is a departure from automagic Linux
distributions (and a thing I agree with).</p>

<pre><code>cp /etc/nsswitch.dns /etc/resolv.conf /zones/base/root/etc
</code></pre>

<p>OmniOS does not use
<a href="http://lists.omniti.com/pipermail/omnios-discuss/2012-December/000323.html"><code>sysidcfg</code></a>,
so the way to make the new zone boot up with an interface configured
for DHCP is to write out the <code>ipadm.conf</code> configuration for <code>ipadm</code>.
The following is <code>base.ipadm.conf</code> that I used, with the <code>vnicbase0</code>
VNIC created with <code>dladm</code> earlier.</p>

<pre><code>_ifname=vnicbase0;_family=2;
_ifname=vnicbase0;_family=26;
_ifname=vnicbase0;_aobjname=vnicbase0/v4;_dhcp=-1,no;
</code></pre>

<p>Copy this file to the zone.</p>

<pre><code>cp base.ipadm.conf /zones/base/root/etc/ipadm/ipadm.conf
</code></pre>

<p>Now, boot the zone.</p>

<pre><code>zoneadm -z base boot
</code></pre>

<p>Now you can log into the newly created zone and verify that things are
working, and do any further configuration required.</p>

<pre><code>zlogin -e ! base
</code></pre>

<p>I use <code>!</code> as the escape character because I&rsquo;m logging into my global
zone over SSH. This means you disconnect with <code>!.</code> instead of <code>~.</code>.</p>

<p>Once complete, the zone can be cloned.</p>

<h2>Clone a Zone</h2>

<p>I&rsquo;m going to clone the <code>base</code> zone to <code>clonebase</code>. Again, rename this
to whatever you like.</p>

<p>First, a zone must be halted before it can be cloned.</p>

<pre><code>zoneadm -z base halt
</code></pre>

<p>Now, create a new VNIC for the zone.</p>

<pre><code>dladm create-vnic -l nge1 clonebase
</code></pre>

<p>Read the <code>base</code> zone&rsquo;s configuration, and replace <code>base</code> with
<code>clonebase</code>.</p>

<pre><code>zonecfg -z base export | sed 's/base/clonebase/g' | tee clonebase.conf
</code></pre>

<p>Then, create the new zone configuration, and clone the base zone.</p>

<pre><code>zonecfg -z clonebase -f clonebase.conf
zoneadm -z clonebase clone base
</code></pre>

<p>Again, ensure that the network configuration to use DNS is available.</p>

<pre><code>cp /etc/nsswitch.dns /etc/resolv.conf /zones/clonebase/root/etc
</code></pre>

<p>Create the <code>ipadm.conf</code> config for the new zone. I named it <code>clonebase.ipadm.conf</code></p>

<pre><code>sed 's/base/clonebase/g' base.ipadm.conf &gt; clonebase.ipadm.conf
</code></pre>

<p>Now copy this to the zone.</p>

<pre><code>cp clonebase.ipadm.conf /zones/clonebase/root/etc/ipadm/ipadm.conf
</code></pre>

<p>Finally, boot the new zone.</p>

<pre><code>zoneadm -z clonebase boot
</code></pre>

<p>Login and verify the new zone.</p>

<pre><code>zlogin -e ! clonebase
</code></pre>

<h2>Cleaning Up</h2>

<p>Use the following to clean up the zone when it&rsquo;s not needed anymore.</p>

<pre><code>zone=clonebase
zoneadm -z $zone halt
zoneadm -z $zone uninstall -F
zonecfg -z $zone delete -F
</code></pre>

<h2>Sans Prose</h2>

<p><a href="https://gist.github.com/jtimberman/5848129">This gist</a> contains all
the things I did above minus the prose.</p>

<h2>What&rsquo;s Next?</h2>

<p>I have a few goals in mind for this system. First of all, I want to
manage the zones with Chef, of course. Some of the functions of the
zones may be:</p>

<ul>
<li>IPS package repository</li>
<li>Omnibus build system for OmniOS</li>
<li>Adding OmniOS support to cookbooks</li>
</ul>


<p>I also want to facilitate plugins and the ecosystem around Chef for
IllumOS, including zone based knife, vagrant and test-kitchen plugins.</p>

<p>Finally, I plan to convert my Linux home-server to OmniOS. There are a
couple things I&rsquo;m running that will require Linux (namely
<a href="http://www.plexapp.com">Plex</a>), but fortunately,
<a href="http://omnios.omniti.com/wiki.php/VirtualMachinesKVM">OmniOS has KVM</a>
thanks to <a href="http://smartos.org">SmartOS</a>.</p>

<h2>References</h2>

<p>The following links were helpful in composing this post, and of course
for the reference material they contain.</p>

<ul>
<li><a href="http://zero-knowledge.org/post/74">http://zero-knowledge.org/post/74</a></li>
<li><a href="https://blogs.oracle.com/mandalika/entry/solaris_10_zone_creation_for">https://blogs.oracle.com/mandalika/entry/solaris_10_zone_creation_for</a></li>
<li><a href="http://www.oracle.com/technetwork/articles/servers-storage-admin/o11-092-s11-zones-intro-524494.html">http://www.oracle.com/technetwork/articles/servers-storage-admin/o11-092-s11-zones-intro-524494.html</a></li>
<li><a href="http://lists.omniti.com/pipermail/omnios-discuss/2012-December/000322.html">http://lists.omniti.com/pipermail/omnios-discuss/2012-December/000322.html</a></li>
<li><a href="http://lists.omniti.com/pipermail/omnios-discuss/2012-December/000323.html">http://lists.omniti.com/pipermail/omnios-discuss/2012-December/000323.html</a></li>
<li><a href="http://omnios.omniti.com/ticket.php/11">http://omnios.omniti.com/ticket.php/11</a> (related to above list post(s))</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/09/starting-chefspec-example/">Starting ChefSpec Example</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-09T21:10:00-06:00" pubdate data-updated="true">May 9<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a quick post to introduce what I&rsquo;m starting on testing with
<a href="http://acrmp.github.io/chefspec/">ChefSpec</a>. This is from Opscode&rsquo;s
Java cookbook. While the recipe tested is really trivial, it actually
has some nuances that require detailed testing.</p>

<p>First off, the whole thing is in
<a href="https://gist.github.com/jtimberman/5552182">this gist</a>. I&rsquo;m going to
break it down into sections below. The file is <code>spec/default_spec.rb</code>
in the java cookbook (not committed/pushed yet).</p>

<p>The chefspec gem is where all the magic comes from. You can read about
ChefSpec on <a href="http://acrmp.github.io/chefspec/">its home page</a>. You&rsquo;ll
need to install the gem, and from there, run <code>rspec</code> to run the tests.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;chefspec&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we&rsquo;re going to describe the default recipe. We&rsquo;re using the
regular rspec &ldquo;let&rdquo; block to set up the runner to converge the recipe.
Then, because we know/assume that the openjdk recipe is the default,
we can say that this chef run should include the <code>java::openjdk</code> recipe.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">describe</span> <span class="s1">&#39;java::default&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">let</span> <span class="p">(</span><span class="ss">:chef_run</span><span class="p">)</span> <span class="p">{</span> <span class="ss">ChefSpec</span><span class="p">:</span><span class="ss">:ChefRunner</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="s1">&#39;java::default&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">it</span> <span class="s1">&#39;should include the openjdk recipe by default&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">chef_run</span><span class="o">.</span><span class="n">should</span> <span class="n">include_recipe</span> <span class="s1">&#39;java::openjdk&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, this cookbook supports Windows. However, we have to set up the
runner with the correct platform and version (this comes from
<a href="https://github.com/customink/fauxhai">fauxhai</a>), and then set
attributes that are required for it to work.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">context</span> <span class="s1">&#39;windows&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:chef_run</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">runner</span> <span class="o">=</span> <span class="ss">ChefSpec</span><span class="p">:</span><span class="ss">:ChefRunner</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;platform&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;windows&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;version&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2008R2&#39;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>      <span class="n">runner</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;java&#39;</span><span class="o">][</span><span class="s1">&#39;install_flavor&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;windows&#39;</span>
</span><span class='line'>      <span class="n">runner</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;java&#39;</span><span class="o">][</span><span class="s1">&#39;windows&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;http://example.com/windows-java.msi&#39;</span>
</span><span class='line'>      <span class="n">runner</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="s1">&#39;java::default&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should include the windows recipe&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">chef_run</span><span class="o">.</span><span class="n">should</span> <span class="n">include_recipe</span> <span class="s1">&#39;java::windows&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next are the contexts for other install flavors. The default recipe
will include the right recipe based on the flavor, which is set by an
attribute. So we set up an rspec context for each recipe, then set the
install flavor attribute, and test that the right recipe was included.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">context</span> <span class="s1">&#39;oracle&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:chef_run</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">runner</span> <span class="o">=</span> <span class="ss">ChefSpec</span><span class="p">:</span><span class="ss">:ChefRunner</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="n">runner</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;java&#39;</span><span class="o">][</span><span class="s1">&#39;install_flavor&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;oracle&#39;</span>
</span><span class='line'>      <span class="n">runner</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="s1">&#39;java::default&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should include the oracle recipe&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">chef_run</span><span class="o">.</span><span class="n">should</span> <span class="n">include_recipe</span> <span class="s1">&#39;java::oracle&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">context</span> <span class="s1">&#39;oracle_i386&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:chef_run</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">runner</span> <span class="o">=</span> <span class="ss">ChefSpec</span><span class="p">:</span><span class="ss">:ChefRunner</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="n">runner</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;java&#39;</span><span class="o">][</span><span class="s1">&#39;install_flavor&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;oracle_i386&#39;</span>
</span><span class='line'>      <span class="n">runner</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="s1">&#39;java::default&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should include the oracle_i386 recipe&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">chef_run</span><span class="o">.</span><span class="n">should</span> <span class="n">include_recipe</span> <span class="s1">&#39;java::oracle_i386&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, a recent addition to this cookbook is support for
<a href="http://tickets.opscode.com/browse/COOK-2897">IBM&rsquo;s Java</a>. In addition
to setting the install flavor, we must set the URL where the IBM Java
package is (see the README in the commit linked in that ticket for
detail), and we can see that the <code>ibm</code> recipe is in fact included.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">context</span> <span class="s1">&#39;ibm&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">let</span><span class="p">(</span><span class="ss">:chef_run</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">runner</span> <span class="o">=</span> <span class="ss">ChefSpec</span><span class="p">:</span><span class="ss">:ChefRunner</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="n">runner</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;java&#39;</span><span class="o">][</span><span class="s1">&#39;install_flavor&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;ibm&#39;</span>
</span><span class='line'>      <span class="n">runner</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set</span><span class="o">[</span><span class="s1">&#39;java&#39;</span><span class="o">][</span><span class="s1">&#39;ibm&#39;</span><span class="o">][</span><span class="s1">&#39;url&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;http://example.com/ibm-java.bin&#39;</span>
</span><span class='line'>      <span class="n">runner</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="s1">&#39;java::default&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should include the ibm recipe&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">chef_run</span><span class="o">.</span><span class="n">should</span> <span class="n">include_recipe</span> <span class="s1">&#39;java::ibm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is just the start of the testing for this cookbook. We&rsquo;ll need to
test each individual recipe. However as I&rsquo;ve not written that code
yet, I don&rsquo;t have examples. Stay tuned!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/08/test-kitchen-and-jenkins/">Test Kitchen and Jenkins</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-08T23:53:00-06:00" pubdate data-updated="true">May 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been working more with test-kitchen 1.0 alpha lately. The most
recent thing I&rsquo;ve done is set up a Jenkins build server to run
test-kitchen on cookbooks. This post will describe how I did this for
my own environment, and how you can use my new test-kitchen cookbook
in yours&hellip; if you&rsquo;re using Jenkins, anyway.</p>

<p>This is all powered by a relatively simple cookbook, and some
click-click-clicking in the Jenkins UI. I&rsquo;ll walk through what I did
to set up my Jenkins system.</p>

<p>First, I started with Debian 7.0 (stable, released this past weekend).
I installed the OS on it, and then bootstrapped with Chef. The initial
test was to make sure everything installed correctly, and the commands
were functioning. This was done in a VM, and is now handled by
test-kitchen itself (how meta!) in the cookbook, kitchen-jenkins.</p>

<p>The cookbook, <a href="http://ckbk.it/kitchen-jenkins">kitchen-jenkins</a> is
available on the Chef Community site. I started with a recipe, but
extracted it to a cookbook to make it easier to share with you all.
This is essentially a site cookbook that I use to customize my Jenkins
installation so I can run test-kitchen builds.</p>

<p>I apply the recipe with a role, because I love the roles primitive in
Chef :&ndash;). Here is the role I&rsquo;m using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;jenkins&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;Jenkins Build Server&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;run_list&quot;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="s2">&quot;recipe[kitchen-jenkins]&quot;</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="s2">&quot;default_attributes&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;jenkins&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="s2">&quot;server&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;home&quot;</span><span class="o">:</span> <span class="s2">&quot;/var/lib/jenkins&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;plugins&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;git-client&quot;</span><span class="p">,</span> <span class="s2">&quot;git&quot;</span><span class="p">],</span>
</span><span class='line'>        <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;1.511&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;war_checksum&quot;</span><span class="o">:</span> <span class="s2">&quot;7e676062231f6b80b60e53dc982eb89c36759bdd2da7f82ad8b35a002a36da9a&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="s2">&quot;json_class&quot;</span><span class="o">:</span> <span class="s2">&quot;Chef::Role&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;chef_type&quot;</span><span class="o">:</span> <span class="s2">&quot;role&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The run list is only slightly different here than my actual role, I
have a few other things in the run list, which are other site-specific
recipes. Don&rsquo;t worry about those now. The jenkins attributes are set
to ensure the right plugins I need are available, and the right
version of jenkins is installed.</p>

<p>(I&rsquo;m going to leave out the details such as uploading cookbooks and
roles, if you&rsquo;re interested in test-kitchen, I&rsquo;ll assume you&rsquo;ve got
that covered :&ndash;).)</p>

<p>Once Chef completes on the Jenkins node, I can reach the Jenkins UI,
conveniently enough, via &ldquo;<a href="http://jenkins:8080">http://jenkins:8080</a>&rdquo; (because I&rsquo;ve made a
DNS entry, of course). The next release of the Jenkins cookbook will
have a resource for managing jobs, but for now I&rsquo;m just going to
create them in the webui.</p>

<p>For this example, I want to have two kinds of cookbook testing jobs.
The first, is to simply run foodcritic and fail on any correctness
matches. Second, I want to actually run test-kitchen.</p>

<p>A foodcritic job is simple:</p>

<ol>
<li>New job &ndash;> Build a free-style software project
&ldquo;foodcritic-COOKBOOK&rdquo;.</li>
<li>Source Code Management &ndash;> Git, supply the repository and the master
branch.</li>
<li>Set a build trigger to Poll SCM every 5 minutes, once an hour,
whenever you like.</li>
<li>Add a build step to execute a shell, &ldquo;foodcritic . -f correctness&rdquo;</li>
</ol>


<p>I created a view for foodcritic jobs, and added them all to the view
for easy organizing.</p>

<p>Next, I create a test-kitchen job:</p>

<ol>
<li>New job &ndash;> Copy existing job &ldquo;foodcritic-COOKBOOK&rdquo;, name the new
job &ldquo;test-COOKBOOK&rdquo;.</li>
<li>Uncheck Poll SCM, check &ldquo;Build after other projects are built&rdquo; and
enter &ldquo;foodcritic-COOKBOOK&rdquo;.</li>
<li>Replace the foodcritic command in the build shell command with
&ldquo;kitchen test&rdquo;.</li>
</ol>


<p>Now, the test kitchen test will only run if the foodcritic build
succeeds. If the cookbook has any correctness lint errors, then the
foodcritic build fails, and the kitchen build won&rsquo;t run. This will
help conserve resources.</p>

<p>Hopefully the <code>kitchen-jenkins</code> cookbook is helpful and this blog post
will give you some ideas how to go about adding cookbook tests to your
CI system, even if it&rsquo;s not Jenkins.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/03/tdd-cookbook-ticket/">TDD Cookbook Ticket</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-03T14:36:00-06:00" pubdate data-updated="true">May 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post will briefly describe how I did a TDD update to Opscode&rsquo;s
<a href="http://ckbk.it/runit">runit</a> to resolve an
<a href="https://tickets.opscode.com/browse/COOK-2867">issue reported last night</a>.</p>

<p>First, the issue manifests itself only on Debian systems. The runit
cookbook&rsquo;s <code>runit_service</code> provider will write an
<a href="http://tickets.opscode.com/browse/COOK-1576">LSB init.d script</a> on
Debian, rather than symlinking to <code>/usr/bin/sv</code>. The problem raised in
the new ticket is that the template will follow the link and write to
<code>/usr/bin/sv</code>. This is bad, as it will end up in a forkbomb as
runsvdir attempts to restart sv on
<a href="http://drupal.org/files/x-all-the-things-template.png">all the things</a>.
Oops! Sorry about that. Let&rsquo;s get it fixed, and practice some TDD.</p>

<p>The runit cookbook includes support for test-kitchen, though I did
need to
<a href="https://github.com/opscode-cookbooks/runit/commit/8d2e0fcb9d6becf99c0d30694164e57d59fb667b">update it</a>
for this effort. Part of this change was adding a box for Debian in
the <code>.kitchen.yml</code>. I set about resolving this with TDD in mind.</p>

<p>First, the runit cookbook includes a couple
<a href="https://github.com/opscode-cookbooks/runit/tree/master/test/cookbooks">&ldquo;test&rdquo; cookbooks</a>
to facilitate setting up the system with the <code>runit_service</code> resource
so the outcome can be tested to ensure the behavior is correct. I
started by adding a &ldquo;failing test&rdquo; in the <code>runit_test::service</code>
recipe, meaning a link resource, and a <code>runit_service</code> resource that
would overwrite <code>/usr/bin/sv</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">link</span> <span class="s2">&quot;/etc/init.d/cook-2867&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">to</span> <span class="s2">&quot;/usr/bin/sv&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">runit_service</span> <span class="s2">&quot;cook-2867&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">default_logger</span> <span class="kp">true</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I ran <code>kitchen test</code> on the Debian box. As expected, the link was
created, and then the runit service was configured. The service&rsquo;s
provider will wait until the service is up. Since we&rsquo;ve destroyed the
sv binary, that will never happen, so I destroyed it. I manually
confirmed the behavior too, to make sure I wasn&rsquo;t seeing something
weird. Due to its very nature, this is <em>really</em> hard to test for
automatically, but it will happen consistently.</p>

<p>Next, I had to write the code to implement the fix for this bug.
Essentially, this means checking if the <code>/etc/init.d/cook-2867</code> file
is a symbolink link, and removing it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">initfile</span> <span class="o">=</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="s1">&#39;/etc&#39;</span><span class="p">,</span> <span class="s1">&#39;init.d&#39;</span><span class="p">,</span> <span class="n">new_resource</span><span class="o">.</span><span class="n">service_name</span><span class="p">)</span>
</span><span class='line'><span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">initfile</span><span class="p">)</span> <span class="k">if</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">symlink?</span><span class="p">(</span><span class="n">initfile</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Simple enough. Next I tested again by destroying the existing
environment and rerunning it from scratch. This takes some time, but
it verifies that everything is working properly. Here&rsquo;s the output on
Debian:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Processing</span> <span class="n">link</span><span class="o">[</span><span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span> <span class="p">(</span><span class="n">runit_test</span><span class="o">::</span><span class="n">service</span> <span class="n">line</span> <span class="mi">147</span><span class="p">)</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="n">link</span><span class="o">[</span><span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">created</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Processing</span> <span class="n">service</span><span class="o">[</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">action</span> <span class="n">nothing</span> <span class="p">(</span><span class="n">dynamically</span> <span class="n">defined</span><span class="p">)</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Processing</span> <span class="n">runit_service</span><span class="o">[</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">action</span> <span class="n">enable</span> <span class="p">(</span><span class="n">runit_test</span><span class="o">::</span><span class="n">service</span> <span class="n">line</span> <span class="mi">151</span><span class="p">)</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Processing</span> <span class="n">directory</span><span class="o">[</span><span class="sr">/etc/s</span><span class="n">v</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span> <span class="p">(</span><span class="n">dynamically</span> <span class="n">defined</span><span class="p">)</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Processing</span> <span class="n">template</span><span class="o">[</span><span class="sr">/etc/s</span><span class="n">v</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">/</span><span class="n">run</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span> <span class="p">(</span><span class="n">dynamically</span> <span class="n">defined</span><span class="p">)</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Processing</span> <span class="n">directory</span><span class="o">[</span><span class="sr">/etc/s</span><span class="n">v</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">/</span><span class="n">log</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span> <span class="p">(</span><span class="n">dynamically</span> <span class="n">defined</span><span class="p">)</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Processing</span> <span class="n">directory</span><span class="o">[</span><span class="sr">/etc/s</span><span class="n">v</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">main</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span> <span class="p">(</span><span class="n">dynamically</span> <span class="n">defined</span><span class="p">)</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Processing</span> <span class="n">directory</span><span class="o">[</span><span class="sr">/var/</span><span class="n">log</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span> <span class="p">(</span><span class="n">dynamically</span> <span class="n">defined</span><span class="p">)</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Processing</span> <span class="n">file</span><span class="o">[</span><span class="sr">/etc/s</span><span class="n">v</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">run</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span> <span class="p">(</span><span class="n">dynamically</span> <span class="n">defined</span><span class="p">)</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Processing</span> <span class="n">template</span><span class="o">[</span><span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">action</span> <span class="n">create</span> <span class="p">(</span><span class="n">dynamically</span> <span class="n">defined</span><span class="p">)</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="n">template</span><span class="o">[</span><span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">updated</span> <span class="n">content</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="n">template</span><span class="o">[</span><span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">owner</span> <span class="n">changed</span> <span class="n">to</span> <span class="mi">0</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="n">template</span><span class="o">[</span><span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">group</span> <span class="n">changed</span> <span class="n">to</span> <span class="mi">0</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="n">template</span><span class="o">[</span><span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">mode</span> <span class="n">changed</span> <span class="n">to</span> <span class="mi">755</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="n">runit_service</span><span class="o">[</span><span class="n">cook</span><span class="o">-</span><span class="mi">2867</span><span class="o">]</span> <span class="n">configured</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Chef</span> <span class="no">Run</span> <span class="n">complete</span> <span class="k">in</span> <span class="mi">7</span><span class="o">.</span><span class="mi">267132764</span> <span class="n">seconds</span>
</span><span class='line'><span class="ss">INFO</span><span class="p">:</span> <span class="no">Running</span> <span class="n">report</span> <span class="n">handlers</span>
</span></code></pre></td></tr></table></div></figure>


<p>I didn&rsquo;t feel I needed a specific test for this in minitest-chef,
because it wouldn&rsquo;t have finished converging (earlier behavior I saw
in the &ldquo;failing&rdquo; test).</p>

<p>If you&rsquo;re contributing to cookbooks, and they have support for
test-kitchen, it&rsquo;s awesome if you can open a bug report with a failing
test. In this case, it was fairly easy to reproduce the bug.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/19/anatomy-of-a-test-kitchen-1-dot-0-cookbook-part-2/">Anatomy of a Test Kitchen 1.0 Cookbook (Part 2)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-19T09:28:00-06:00" pubdate data-updated="true">Mar 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>DISCLAIMER</strong> Test Kitchen 1.0 is still in <em>alpha</em> at the time of
  this post.</p>

<p><strong>Update</strong> We&rsquo;re no longer required to use bundler, and in fact
  recommend installing the required RubyGems in your globalRuby
  environment (#3 below).</p>

<p><strong>Update</strong> The log output from the various kitchen commands is not
  updated with the latest and greatest. Play along at home, it&rsquo;ll be
  okay :&ndash;).</p>

<p>This is a continuation from <a href="/blog/2013/03/19/anatomy-of-a-test-kitchen-1-dot-0-cookbook-part-1/">part 1</a></p>

<p>In order to run the tests then, we need a few things on our machine:</p>

<ol>
<li>VirtualBox and Vagrant (1.1+)</li>
<li>A compiler toolchain with XML/XSLT development headers (for building Gem dependencies)</li>
<li>A sane, working Ruby environment (Ruby 1.9.3 or greater)</li>
<li>Git</li>
</ol>


<p>It is outside the scope of this post to cover how to get all those
installed.</p>

<p>Once those are installed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% vagrant plugin install vagrant-berkshelf
</span><span class='line'>% gem install berkshelf
</span><span class='line'>% gem install test-kitchen --pre
</span><span class='line'>% gem install kitchen-vagrant</span></code></pre></td></tr></table></div></figure>


<p>Test Kitchen combines the suite (default) with the platform names
(e.g., ubuntu-12.04). To run all the suites on all platforms, simply do:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% kitchen test</span></code></pre></td></tr></table></div></figure>


<p>This will take awhile, especially if you don&rsquo;t already have the
Vagrant boxes on your system, as it will download each one. To make
this faster, we&rsquo;ll just run Ubuntu 12.04:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% kitchen test default.*1204</span></code></pre></td></tr></table></div></figure>


<p>Test Kitchen 1.0 can take a regular expression for the instances to
test. This will match the box <code>default-ubuntu-12.04</code>. I could also
just say <code>12</code> as that will match the single entry in my kitchen list
(above).</p>

<p>It will take a few minutes to run Test Kitchen. Those familiar with
Chef know that if it encounters an unhandled exception, it exits with
a non-zero return code. This is important, because we know at the end
of a successful run, Chef did the right thing, assuming our recipe is
the right thing :&ndash;).</p>

<p>To recap the <a href="/blog/2013/03/19/anatomy-of-a-test-kitchen-1-dot-0-cookbook-part-1/">previous post</a>, we have a run list like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>["recipe[apt]", "recipe[minitest-handler]", "recipe[bluepill_test]"]</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s break down the output of our successful run. I&rsquo;ll show the
output first, and explain it after:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Starting Kitchen
</span><span class='line'>Cleaning up any prior instances of &lt;default-ubuntu-1204&gt;
</span><span class='line'>Destroying &lt;default-ubuntu-1204&gt;
</span><span class='line'>Finished destroying &lt;default-ubuntu-1204&gt; (0m0.00s).
</span><span class='line'>Testing &lt;default-ubuntu-1204&gt;
</span><span class='line'>Creating &lt;default-ubuntu-1204&gt;</span></code></pre></td></tr></table></div></figure>


<p>This is basic setup to ensure that &ldquo;The Kitchen&rdquo; is clean beforehand
and we don&rsquo;t have existing state interfering with the run.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[vagrant command] BEGIN (vagrant up default-ubuntu-1204 --no-provision)
</span><span class='line'>[default-ubuntu-1204] Importing base box 'canonical-ubuntu-12.04'...
</span><span class='line'>[default-ubuntu-1204] Matching MAC address for NAT networking...
</span><span class='line'>[default-ubuntu-1204] Clearing any previously set forwarded ports...
</span><span class='line'>[default-ubuntu-1204] Forwarding ports...
</span><span class='line'>[default-ubuntu-1204] -- 22 =&gt; 2222 (adapter 1)</span></code></pre></td></tr></table></div></figure>


<p>This will look familiar to Vagrant users, we&rsquo;re just getting some
basic setup from Vagrant initializing the box defined in the
<code>.kitchen.yml</code> (passed to the Vagrantfile by the kitchen-vagrant
plugin). This step does a <code>vagrant up --no-provision</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Berkshelf] installing cookbooks...
</span><span class='line'>[Berkshelf] Using bluepill (2.2.2) at path: '/Users/jtimberman/Development/opscode/cookbooks/bluepill'
</span><span class='line'>[Berkshelf] Using apt (1.8.4)
</span><span class='line'>[Berkshelf] Using yum (2.0.0)
</span><span class='line'>[Berkshelf] Using minitest-handler (0.1.2)
</span><span class='line'>[Berkshelf] Using bluepill_test (0.0.1) at path: './test/cookbooks/bluepill_test'
</span><span class='line'>[Berkshelf] Using rsyslog (1.5.0)
</span><span class='line'>[Berkshelf] Using chef_handler (1.1.0)</span></code></pre></td></tr></table></div></figure>


<p>Remember from the <a href="/blog/2013/03/19/anatomy-of-a-test-kitchen-1-dot-0-cookbook-part-1/">previous post</a> that we&rsquo;re using Berkshelf? This is
the integration with Vagrant that ensures that the cookbooks are
available. The first four, <code>apt</code>, <code>yum</code>, <code>minitest-handler</code> and
bluepill_test are defined in the Berksfile. The next, <code>rsyslog</code> is a
dependency of the <code>bluepill</code> cookbook (for rsyslog integration), and the
last, <code>chef_handler</code> is a dependency of <code>minitest-handler</code>. Berkshelf
extracts the dependencies from the cookbook metadata of each cookbook
defined in the Berksfile.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[default-ubuntu-1204] Creating shared folders metadata...
</span><span class='line'>[default-ubuntu-1204] Clearing any previously set network interfaces...
</span><span class='line'>[default-ubuntu-1204] Running any VM customizations...
</span><span class='line'>[default-ubuntu-1204] Booting VM...
</span><span class='line'>[default-ubuntu-1204] Waiting for VM to boot. This can take a few minutes.
</span><span class='line'>[default-ubuntu-1204] VM booted and ready for use!
</span><span class='line'>[default-ubuntu-1204] Setting host name...
</span><span class='line'>[default-ubuntu-1204] Mounting shared folders...
</span><span class='line'>[default-ubuntu-1204] -- v-root: /vagrant
</span><span class='line'>[default-ubuntu-1204] -- v-csc-1: /tmp/vagrant-chef-1/chef-solo-1/cookbooks
</span><span class='line'>[vagrant command] END (0m48.76s)
</span><span class='line'>Vagrant instance &lt;default-ubuntu-1204&gt; created.
</span><span class='line'>Finished creating &lt;default-ubuntu-1204&gt; (0m53.12s).</span></code></pre></td></tr></table></div></figure>


<p>Again, this is familiar output to Vagrant users, where Vagrant is
making the cookbooks available to the instance.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Converging &lt;default-ubuntu-1204&gt;
</span><span class='line'>[vagrant command] BEGIN (vagrant ssh default-ubuntu-1204 --command 'should_update_chef() {\n...')
</span><span class='line'>Installing Chef Omnibus (11.4.0)
</span><span class='line'>Downloading Chef 11.4.0 for ubuntu...
</span><span class='line'>Installing Chef 11.4.0
</span><span class='line'>Selecting previously unselected package chef.
</span><span class='line'>g database ...        60513 files and directories currently installed.)
</span><span class='line'>Unpacking chef (from .../chef_11.4.0_amd64.deb) ...
</span><span class='line'>Setting up chef (11.4.0-1.ubuntu.11.04) ...
</span><span class='line'>Thank you for installing Chef!
</span><span class='line'>[vagrant command] END (0m34.85s)
</span><span class='line'>[vagrant command] BEGIN (vagrant provision default-ubuntu-1204)
</span><span class='line'>[Berkshelf] installing cookbooks...
</span><span class='line'>[Berkshelf] Using bluepill (2.2.2) at path: '/Users/jtimberman/Development/opscode/cookbooks/bluepill'
</span><span class='line'>[Berkshelf] Using apt (1.8.4)
</span><span class='line'>[Berkshelf] Using yum (2.0.0)
</span><span class='line'>[Berkshelf] Using minitest-handler (0.1.2)
</span><span class='line'>[Berkshelf] Using bluepill_test (0.0.1) at path: './test/cookbooks/bluepill_test'
</span><span class='line'>[Berkshelf] Using rsyslog (1.5.0)
</span><span class='line'>[Berkshelf] Using chef_handler (1.1.0)</span></code></pre></td></tr></table></div></figure>


<p>This part is interesting, in that we&rsquo;re going to install the Full
Stack Chef (Omnibus) package. This means it doesn&rsquo;t matter what the
underlying base box has installed, we get the right version of Chef.
This is defined in the <code>.kitchen.yml</code>. This is done through <code>vagrant
ssh</code> (second line). Then, Test Kitchen does <code>vagrant provision</code>. The
provisioning step is where Berkshelf happens, so we do see this happen
again (perhaps a bug?).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[default-ubuntu-1204] Running provisioner: Vagrant::Provisioners::ChefSolo...
</span><span class='line'>[default-ubuntu-1204] Generating chef JSON and uploading...
</span><span class='line'>[default-ubuntu-1204] Running chef-solo...
</span><span class='line'>INFO: *** Chef 11.4.0 ***
</span><span class='line'>INFO: Setting the run_list to ["recipe[apt]", "recipe[minitest-handler]", "recipe[bluepill_test]"] from JSON
</span><span class='line'>INFO: Run List is [recipe[apt], recipe[minitest-handler], recipe[bluepill_test]]
</span><span class='line'>INFO: Run List expands to [apt, minitest-handler, bluepill_test]
</span><span class='line'>INFO: Starting Chef Run for default-ubuntu-1204.vagrantup.com</span></code></pre></td></tr></table></div></figure>


<p>This is the start of the actual Chef run, using Chef Solo by Vagrant&rsquo;s
provisioner. Note that we have our suite&rsquo;s run list. I&rsquo;m going to skip
a lot of the Chef output because it isn&rsquo;t required. Note that a few
resources in the minitest&mdash;handler will report as failed, but they can
be ignored because it means that those tests were simply not implemented.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO: Processing directory[/var/chef/minitest/bluepill_test] action create (minitest-handler::default line 50)
</span><span class='line'>INFO: directory[/var/chef/minitest/bluepill_test] created directory /var/chef/minitest/bluepill_test
</span><span class='line'>INFO: Processing cookbook_file[tests-bluepill_test-default] action create (minitest-handler::default line 53)
</span><span class='line'>INFO: cookbook_file[tests-bluepill_test-default] created file /var/chef/minitest/bluepill_test/default_test.rb
</span><span class='line'>INFO: Processing remote_directory[tests-support-bluepill_test-default] action create (minitest-handler::default line 60)
</span><span class='line'>INFO: remote_directory[tests-support-bluepill_test-default] created directory /var/chef/minitest/bluepill_test/support
</span><span class='line'>INFO: Processing cookbook_file[/var/chef/minitest/bluepill_test/support/helpers.rb] action create (dynamically defined)
</span><span class='line'>INFO: cookbook_file[/var/chef/minitest/bluepill_test/support/helpers.rb] mode changed to 644
</span><span class='line'>INFO: cookbook_file[/var/chef/minitest/bluepill_test/support/helpers.rb] created file /var/chef/minitest/bluepill_test/support/helpers.rb</span></code></pre></td></tr></table></div></figure>


<p>These are the relevant parts of the minitest-handler recipe, where it
has copied the tests from the <code>bluepill_test</code> cookbook into place.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO: Processing gem_package[i18n] action install (bluepill::default line 20)
</span><span class='line'>INFO: Processing gem_package[bluepill] action install (bluepill::default line 24)
</span><span class='line'>INFO: Processing directory[/etc/bluepill] action create (bluepill::default line 34)
</span><span class='line'>INFO: directory[/etc/bluepill] created directory /etc/bluepill
</span><span class='line'>INFO: directory[/etc/bluepill] owner changed to 0
</span><span class='line'>INFO: directory[/etc/bluepill] group changed to 0
</span><span class='line'>INFO: Processing directory[/var/run/bluepill] action create (bluepill::default line 34)
</span><span class='line'>INFO: directory[/var/run/bluepill] created directory /var/run/bluepill
</span><span class='line'>INFO: directory[/var/run/bluepill] owner changed to 0
</span><span class='line'>INFO: directory[/var/run/bluepill] group changed to 0
</span><span class='line'>INFO: Processing directory[/var/lib/bluepill] action create (bluepill::default line 34)
</span><span class='line'>INFO: directory[/var/lib/bluepill] created directory /var/lib/bluepill
</span><span class='line'>INFO: directory[/var/lib/bluepill] owner changed to 0
</span><span class='line'>INFO: directory[/var/lib/bluepill] group changed to 0
</span><span class='line'>INFO: Processing file[/var/log/bluepill.log] action create_if_missing (bluepill::default line 41)
</span><span class='line'>INFO: entered create
</span><span class='line'>INFO: file[/var/log/bluepill.log] owner changed to 0
</span><span class='line'>INFO: file[/var/log/bluepill.log] group changed to 0
</span><span class='line'>INFO: file[/var/log/bluepill.log] mode changed to 755
</span><span class='line'>INFO: file[/var/log/bluepill.log] created file /var/log/bluepill.log</span></code></pre></td></tr></table></div></figure>


<p>Recall from the <a href="/blog/2013/03/19/anatomy-of-a-test-kitchen-1-dot-0-cookbook-part-1/">previous post</a> that the <code>bluepill_test</code> recipe includes
the <code>bluepill</code> recipe. This is the basic setup of bluepill.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO: Processing package[nc] action install (bluepill_test::default line 4)
</span><span class='line'>INFO: Processing template[/etc/bluepill/test_app.pill] action create (bluepill_test::default line 16)
</span><span class='line'>INFO: template[/etc/bluepill/test_app.pill] updated content
</span><span class='line'>INFO: Processing bluepill_service[test_app] action enable (bluepill_test::default line 18)
</span><span class='line'>INFO: Processing bluepill_service[test_app] action load (bluepill_test::default line 18)
</span><span class='line'>INFO: Processing bluepill_service[test_app] action start (bluepill_test::default line 18)
</span><span class='line'>INFO: Processing link[/etc/init.d/test_app] action create (/tmp/vagrant-chef-1/chef-solo-1/cookbooks/bluepill/providers/service.rb line 30)
</span><span class='line'>INFO: link[/etc/init.d/test_app] created
</span><span class='line'>INFO: Chef Run complete in 81.099185824 seconds</span></code></pre></td></tr></table></div></figure>


<p>And this is the rest of the <code>bluepill_test</code> recipe. It sets up a test
service that will basically be a netcat process listening on a port.
Let&rsquo;s take a moment here and discuss what we have.</p>

<p>First, we have successfully converged the default recipe in the
<code>bluepill</code> cookbook via its inclusion in <code>bluepill_test</code>. This is
awesome, because we know the recipe works exactly as we defined it,
since Chef resources are declarative, and Chef exits if there&rsquo;s a
problem.</p>

<p>Second, we have successfully setup a service managed by bluepill
itself using the LWRP included in the <code>bluepill</code> cookbook,
<code>bluepill_service</code>. This means we know that the underlying provider
configured all the resources correctly.</p>

<p>At this point, we could say &ldquo;Ship it!&rdquo; and release the cookbook,
knowing it will do what we require. However, this may be disingenuous
because we don&rsquo;t know if the behavior of the system after all this
runs is actually correct. Therefore we look to the next segment of
output from Chef, from minitest:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO: Running report handlers
</span><span class='line'>Run options: -v --seed 38794
</span><span class='line'>\# Running tests:
</span><span class='line'>recipe::bluepill_test::default#test_0001_the_default_log_file_must_exist_cook_1295_ =
</span><span class='line'>0.00 s = .
</span><span class='line'>recipe::bluepill_test::default::create a bluepill configuration file#test_0001_anonymous =
</span><span class='line'>0.00 s = .
</span><span class='line'>recipe::bluepill_test::default::create a bluepill configuration file#test_0002_must_be_valid_ruby =
</span><span class='line'>0.06 s = .
</span><span class='line'>recipe::bluepill_test::default::runs the application as a service#test_0001_anonymous =
</span><span class='line'>0.72 s = .
</span><span class='line'>recipe::bluepill_test::default::runs the application as a service#test_0002_anonymous =
</span><span class='line'>0.71 s = .
</span><span class='line'>recipe::bluepill_test::default::spawn a netcat tcp client repeatedly#test_0001_should_receive_a_tcp_connection_from_netcat =
</span><span class='line'>2.24 s = .
</span><span class='line'>Finished tests in 3.746002s, 1.6017 tests/s, 1.8687 assertions/s.
</span><span class='line'>6 tests, 7 assertions, 0 failures, 0 errors, 0 skips</span></code></pre></td></tr></table></div></figure>


<p>This is performed by the minitest-handler, which runs the tests copied
from the <code>bluepill_test</code> cookbook before. It&rsquo;s outside the scope of
this post to describe how to write minitest-chef tests, but we can
talk about the output.</p>

<p>We have 6 separate tests that perform 7 assertions, and they all
passed. The tests are asserting:</p>

<ol>
<li>The log file is created, and by the full name of the test, this is
to check for a regression from
<a href="http://tickets.opscode.com/browse/COOK-1295">COOK-1295</a>.</li>
<li>The <code>.pill</code> config file for the service must exist and be valid
Ruby.</li>
<li>The bluepill service must actually be enabled and running, thereby
testing that those actions in the LWRP work.</li>
<li>The running service, which listens on a TCP port, must be up and
available, thereby testing that bluepill started the service
correctly.</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[vagrant command] END (1m29.24s)
</span><span class='line'>Finished converging &lt;default-ubuntu-1204&gt; (2m15.45s).
</span><span class='line'>Setting up &lt;default-ubuntu-1204&gt;
</span><span class='line'>Finished setting up &lt;default-ubuntu-1204&gt; (0m0.00s).
</span><span class='line'>Verifying &lt;default-ubuntu-1204&gt;
</span><span class='line'>Finished verifying &lt;default-ubuntu-1204&gt; (0m0.00s).
</span><span class='line'>Destroying &lt;default-ubuntu-1204&gt;
</span><span class='line'>[vagrant command] BEGIN (vagrant destroy default-ubuntu-1204 -f)
</span><span class='line'>[default-ubuntu-1204] Forcing shutdown of VM...
</span><span class='line'>[Berkshelf] cleaning Vagrant's shelf
</span><span class='line'>[default-ubuntu-1204] Destroying VM and associated drives...
</span><span class='line'>[vagrant command] END (0m3.68s)
</span><span class='line'>Vagrant instance &lt;default-ubuntu-1204&gt; destroyed.
</span><span class='line'>Finished destroying &lt;default-ubuntu-1204&gt; (0m4.04s).
</span><span class='line'>Finished testing &lt;default-ubuntu-1204&gt; (3m12.62s).
</span><span class='line'>Kitchen is finished. (3m12.62s)</span></code></pre></td></tr></table></div></figure>


<p>This output shows Test Kitchen cleaning up after itself. We destroy
the Vagrant instance on a successful convergence and test run in Chef,
because further investigation is not required. If the test failed for
some reason, Test Kitchen leaves it running so you can log into the
machine and poke around to find out what went wrong. Then simply
correct the required part of the cookbook (recipes, tests, etc) and
rerun Test Kitchen. For example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% bundle exec kitchen login 1204
</span><span class='line'>vagrant@ubuntu-1204$ ... run some commands
</span><span class='line'>vagrant@ubuntu-1204$ ^D
</span><span class='line'>% bundle exec kitchen converge 1204</span></code></pre></td></tr></table></div></figure>


<p>My goal with these posts is to get some information out for folks to
consider when examining Test Kitchen 1.0 alpha for their own projects.
There&rsquo;s a lot more to Test Kitchen, such as managing non-cookbook
projects, or even using other kinds of tests. We&rsquo;ll have more
documentation and guides as we get the 1.0 release out.</p>

<p>Enjoy!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/19/anatomy-of-a-test-kitchen-1-dot-0-cookbook-part-1/">Anatomy of a Test Kitchen 1.0 Cookbook (Part 1)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-19T09:28:00-06:00" pubdate data-updated="true">Mar 19<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>DISCLAIMER</strong> Test Kitchen 1.0 is still in <em>alpha</em> at the time of
  this post.</p>

<p><strong>Update</strong> Remove Gemfile and Vagrantfile</p>

<p>Let&rsquo;s take a look at the anatomy of a cookbook set up with
test-kitchen 1.0-alpha.</p>

<p><strong>Note</strong> It is outside the scope of this post to discuss how to write
  minitest-chef tests or &ldquo;test cookbook&rdquo; recipes. Use the cookbook
  described below as an example to get ideas for writing your own.</p>

<p>This is the full directory tree of Opscode&rsquo;s
&ldquo;<a href="http://ckbk.it/bluepill">bluepill</a>&rdquo; cookbook:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── .kitchen.yml
</span><span class='line'>├── Berksfile
</span><span class='line'>├── CHANGELOG.md
</span><span class='line'>├── CONTRIBUTING
</span><span class='line'>├── LICENSE
</span><span class='line'>├── README.md
</span><span class='line'>├── TESTING.md
</span><span class='line'>├── attributes
</span><span class='line'>│   └── default.rb
</span><span class='line'>├── metadata.rb
</span><span class='line'>├── providers
</span><span class='line'>│   └── service.rb
</span><span class='line'>├── recipes
</span><span class='line'>│   ├── default.rb
</span><span class='line'>│   └── rsyslog.rb
</span><span class='line'>├── resources
</span><span class='line'>│   └── service.rb
</span><span class='line'>├── templates
</span><span class='line'>│   └── default
</span><span class='line'>│       ├── bluepill_init.fedora.erb
</span><span class='line'>│       ├── bluepill_init.freebsd.erb
</span><span class='line'>│       ├── bluepill_init.rhel.erb
</span><span class='line'>│       └── bluepill_rsyslog.conf.erb
</span><span class='line'>└── test
</span><span class='line'>    └── cookbooks
</span><span class='line'>        └── bluepill_test
</span><span class='line'>            ├── README.md
</span><span class='line'>            ├── attributes
</span><span class='line'>            │   └── default.rb
</span><span class='line'>            ├── files
</span><span class='line'>            │   └── default
</span><span class='line'>            │       └── tests
</span><span class='line'>            │           └── minitest
</span><span class='line'>            │               ├── default_test.rb
</span><span class='line'>            │               └── support
</span><span class='line'>            │                   └── helpers.rb
</span><span class='line'>            ├── metadata.rb
</span><span class='line'>            ├── recipes
</span><span class='line'>            │   └── default.rb
</span><span class='line'>            └── templates
</span><span class='line'>                └── default
</span><span class='line'>                    └── test_app.pill.erb</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ll assume the reader is familiar with basic components of cookbooks
like &ldquo;recipes,&rdquo; &ldquo;templates,&rdquo; and the top-level documentation files, so
let&rsquo;s trim this down to just the areas of concern for Test Kitchen.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── .kitchen.yml
</span><span class='line'>├── Berksfile
</span><span class='line'>└── test
</span><span class='line'>    └── cookbooks
</span><span class='line'>        └── bluepill_test
</span><span class='line'>            ├── attributes
</span><span class='line'>            │   └── default.rb
</span><span class='line'>            ├── files
</span><span class='line'>            │   └── default
</span><span class='line'>            │       └── tests
</span><span class='line'>            │           └── minitest
</span><span class='line'>            │               ├── default_test.rb
</span><span class='line'>            │               └── support
</span><span class='line'>            │                   └── helpers.rb
</span><span class='line'>            ├── recipes
</span><span class='line'>            │   └── default.rb
</span><span class='line'>            └── templates
</span><span class='line'>                └── default
</span><span class='line'>                    └── test_app.pill.erb</span></code></pre></td></tr></table></div></figure>


<p>Note that this cookbook has a &ldquo;test&rdquo; cookbook. I&rsquo;ll get to that in a
minute.</p>

<p>First of all, we have the <code>.kitchen.yml</code>. This is the project
definition that describes what is required to run test kitchen itself.
This particular file tells Test Kitchen to bring up nodes of the
platforms we&rsquo;re testing with Vagrant, and defines the boxes with their
box names and URLs to download. You can view the full
<a href="https://github.com/opscode-cookbooks/bluepill/blob/master/.kitchen.yml"><code>.kitchen.yml</code> in the Git repo</a>.
For now, I&rsquo;m going to focus on the <code>suite</code> stanza in the
<code>.kitchen.yml</code>. This defines how Chef will run when Test Kitchen
brings up the Vagrant machine.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'>  <span class="l-Scalar-Plain">run_list</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">recipe[minitest-handler]</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">recipe[bluepill_test]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">attributes</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span><span class="nv">bluepill</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">bin</span><span class="p-Indicator">:</span> <span class="s">&quot;/opt/chef/embedded/bin/bluepill&quot;</span> <span class="p-Indicator">}</span> <span class="p-Indicator">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each platform has a recipe it will run with, in this case <code>apt</code> and
<code>yum</code>. Then the suite&rsquo;s run list is appended, so for example, the final run list of
the Ubuntu 12.04 node will be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">[</span><span class="s">&quot;recipe[apt]&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;recipe[minitest-handler]&quot;</span><span class="p-Indicator">,</span> <span class="s">&quot;recipe[bluepill_test]&quot;</span><span class="p-Indicator">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have apt so the apt cache on the node is updated before Chef does
anything else. This is pretty typical so we put it in the default run
list of each Ubuntu box.</p>

<p>The <code>minitest-handler</code> recipe existing in the run list means that the
Minitest Chef Handler will be run at the end of the Chef run. In this
case, it will use the tests from the test cookbook, <code>bluepill_test</code>.</p>

<p>The bluepill cookbook itself does not depend on any of these
cookbooks. So how does Test Kitchen know where to get them? Enter the
next file in the list above, <code>Berksfile</code>. This informs
<a href="http://berkshelf.com">Berkshelf</a> which cookbooks to download. The
relevant excerpt from the Berksfile is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cookbook</span> <span class="s2">&quot;apt&quot;</span>
</span><span class='line'><span class="n">cookbook</span> <span class="s2">&quot;yum&quot;</span>
</span><span class='line'><span class="n">cookbook</span> <span class="s2">&quot;minitest-handler&quot;</span>
</span><span class='line'><span class="n">cookbook</span> <span class="s2">&quot;bluepill_test&quot;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;./test/cookbooks/bluepill_test&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Based on the
<a href="https://github.com/opscode-cookbooks/bluepill/blob/master/Berksfile">Berksfile</a>,
it will download apt, yum, and minitest-handler from the Chef
Community site. It will also use the
<a href="https://github.com/opscode-cookbooks/bluepill/tree/master/test/cookbooks/bluepill_test">bluepill_test</a>
included in the bluepill cookbook. This is transparent to the user, as
I&rsquo;ll cover in a moment.</p>

<p>Test Kitchen&rsquo;s Vagrant driver plugin handles all the configuration of
Vagrant itself based on the entries in the <code>.kitchen.yml</code>. To get the
Berkshelf integration in the Vagrant boxes, we need to install the
vagrant-berkshelf plugin in Vagrant. Then, we automatically get
Berkshelf&rsquo;s Vagrant integration, meaning all the cookbooks defined in
the Berksfile are going to be available on the box we bring up.</p>

<p>Remember the test cookbook mentioned above? It&rsquo;s the next component.
The default <code>suite</code> in <code>.kitchen.yml</code> puts <code>bluepill_test</code> in the run
list. This particular recipe will include the <code>bluepill</code> default
recipe, then it sets up a test service using the <code>bluepill_service</code>
LWRP. This means that when the nodes brought up by Test Kitchen via
Vagrant converge, they&rsquo;ll have bluepill installed and set up, and then
a service running that we can test the final behavior. Since Chef will
exit with a non-zero return code if it encounters an exception, we
know that a successful run means everything is configured as defined
in the recipes, and we can run tests against the node.</p>

<p>The tests we&rsquo;ll run are written with the
<a href="https://github.com/calavera/minitest-chef-handler/">Minitest Chef Handler</a>.
These are defined in the test cookbook, <code>files/default/tests/minitest</code>
directory. The <code>minitest-handler</code> cookbook (also in the default suite
run list) will execute the
<a href="https://github.com/opscode-cookbooks/bluepill/blob/master/test/cookbooks/bluepill_test/files/default/tests/minitest/default_test.rb">default_test</a>
tests.</p>

<p>In the next post, we&rsquo;ll look at how to run Test Kitchen, and what all
the output means.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("jtimberman", 3, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/jtimberman" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @jtimberman</a>
  
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/30/quick-tip-stubbing-library-helpers-in-chefspec/">Quick Tip: Stubbing Library Helpers in ChefSpec</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/16/quick-tip-policyfile-run-lists/">Quick Tip: Policyfile Run Lists</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/15/quick-tip-chefdk-provision/">Quick Tip: ChefDK Provision</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/03/chef-audit-mode-introduction/">Chef Audit Mode Introduction</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/25/missing-transitive-dependencies/">Missing Transitive Dependencies</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jtimberman">@jtimberman</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jtimberman',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011-2015 - Joshua Timberman -
  <span class="credit">Powered
  by <a href="http://octopress.org">Octopress</a></span>
  <br /><a rel="license"
  href="http://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
  Commons License" style="border-width:0"
  src="http://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons Attribution-ShareAlike 3.0 United States License</a>.
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jtimberman';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
