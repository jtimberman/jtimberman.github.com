
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>jtimberman's Code Blog</title>
  <meta name="author" content="Joshua Timberman">

  
  <meta name="description" content="Most commonly, Vagrant&rsquo;s
Vagrantfile describes only a single VM. That&rsquo;s fine, but most
environments separate functionality to different &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jtimberman.housepub.org/blog/page/4">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="jtimberman's Code Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud?source=profiles" />
<link rel="openid2.local_id" href="http://www.google.com/profiles/100567271038100401523" />

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-26031299-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">jtimberman's Code Blog</a></h1>
  
    <h2>Chef, Ops, Ruby, Linux/Unix. Opinions are mine, not my employer's (Chef).</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jtimberman.housepub.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/18/multivm-vagrantfile-for-chef/">MultiVM Vagrantfile for Chef</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-18T00:16:00-06:00" pubdate data-updated="true">Mar 18<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Most commonly, <a href="http://vagrantup.com">Vagrant&rsquo;s</a>
Vagrantfile describes only a single VM. That&rsquo;s fine, but most
environments separate functionality to different servers (e.g.,
database and web app). For this reason, Vagrantfiles can be set up for
<a href="http://docs.vagrantup.com/v2/multi-machine/index.html">multi-VM arrangements</a>.</p>

<p>However, I&rsquo;m going to describe a different use case for multiple VMs.</p>

<h2>Testing Multiple Distributions</h2>

<p>As a cookbook developer for a variety of platforms and platform
versions, I have to ensure changes do not break existing functionality
across supported platforms &ndash; namely current releases of Ubuntu and
CentOS (and their parents, Debian and RHEL).</p>

<p>Enter Vagrant&rsquo;s Multi-VM Vagrantfile.</p>

<p>While I <a href="/blog/2012/02/15/testing-with-fission/">posted recently</a>
about testing with VMware Fusion, I am using Vagrant more. Primarily
because Opscode uses Vagrant internally &ndash;
<a href="http://twitter.com/schisamo">Seth Chisamore</a> built a multi-VM
Vagrantfile for bringing up our full stack. The specifics in his
Vagrantfile are tuned to that particular use case which is different
than mine. However, there are similar patterns that I adapted.</p>

<h2>Vagrantfile</h2>

<p>The Vagrantfile configures four virtual machines:</p>

<ul>
<li>CentOS 5.7 and 6.2</li>
<li>Ubuntu 10.04 and 11.10</li>
</ul>


<p>I built my VMs with <a href="https://github.com/jedi4ever/veewee">veewee</a>
templates that install Chef via the
<a href="http://opscode.com/chef/install">omnibus built chef-full package</a>.
That way I have a consistent installation that reflects what Opscode
will ship as the easiest and best supported way to install Chef.</p>

<p>Part of the magic of this configuration is that I&rsquo;m going to reuse my
knife configuration. The Vagrantfile itself goes into my cookbook
testing Chef Repository.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;chef&#39;</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;chef/config&#39;</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;chef/knife&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">current_dir</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>    <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s1">&#39;.chef&#39;</span><span class="p">,</span> <span class="s1">&#39;knife.rb&#39;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, I&rsquo;m going to describe data about the virtual machines that I&rsquo;m
going to run. This is a hash of named VMs, <code>centos5</code>, <code>lucid</code>, etc. I
assign their hostname, and give them a host only IP address. I also
set an initial run list, since Vagrant will (noisily) complain if the
run list is empty in a Chef provisioner.</p>

<p><em>Note</em> I have a <code>base</code> role as a holder, the actual relevant things
 are in the <code>base_redhat</code> and <code>base_debian</code> roles. The details really
 don&rsquo;t matter, though.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cookbook_testers</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">:centos5</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;centos5-cookbook-test&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:ipaddress</span> <span class="o">=&gt;</span> <span class="s2">&quot;172.16.13.5&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:run_list</span> <span class="o">=&gt;</span> <span class="s2">&quot;role[base],role[base_redhat]&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="ss">:centos6</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;centos6-cookbook-test&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:ipaddress</span> <span class="o">=&gt;</span> <span class="s2">&quot;172.16.13.6&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:run_list</span> <span class="o">=&gt;</span> <span class="s2">&quot;role[base],role[base_redhat]&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="ss">:lucid</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;lucid-cookbook-test&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:ipaddress</span> <span class="o">=&gt;</span> <span class="s2">&quot;172.16.13.10&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:run_list</span> <span class="o">=&gt;</span> <span class="s2">&quot;role[base],role[base_debian]&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="ss">:oneiric</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;oneiric-cookbook-test&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:ipaddress</span> <span class="o">=&gt;</span> <span class="s2">&quot;172.16.13.11&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:run_list</span> <span class="o">=&gt;</span> <span class="s2">&quot;role[base],role[base_debian]&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, I&rsquo;m going to set up the <code>Vagrant::Config</code> object as &ldquo;global&rdquo;
configuration for all the VMs, and then iterate over each of the VMs
described above.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Vagrant</span><span class="p">:</span><span class="ss">:Config</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">global_config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">cookbook_testers</span><span class="o">.</span><span class="n">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span>
</span><span class='line'>    <span class="n">global_config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="nb">name</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>      <span class="n">vm_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">-cookbook-test&quot;</span>
</span><span class='line'>      <span class="n">ipaddress</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:ipaddress</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>I disable the shared folder, since I&rsquo;m going to use a Chef Server, and
my recipes will download what they need from remote repositories, not
my local system.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">share_folder</span><span class="p">(</span><span class="s2">&quot;v-root&quot;</span><span class="p">,</span> <span class="s2">&quot;/vagrant&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="ss">:disabled</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Set up some basic configuration for the box. Modify this to suit your
environment. This section is on a per-VM basis. If particular tunables
were required, I&rsquo;d create additional config in the <code>cookbook_testers</code>
hash above, and use those values here.</p>

<p><em>Note</em> <code>name</code> will be a symbol, but only in some contexts of
 execution.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">boot_mode</span> <span class="o">=</span> <span class="ss">:headless</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">host_name</span> <span class="o">=</span> <span class="n">vm_name</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:hostonly</span><span class="p">,</span> <span class="n">ipaddress</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I set up the Chef provisioner. Again, I&rsquo;m using Chef with a Server
(<a href="http://opscode.com/hosted-chef">Opscode Hosted Chef</a>, of course). I
use the <code>chef_server_url</code>, and <code>validation_client_name</code> settings from
my <code>knife.rb</code>.</p>

<p>The nodes&#8217; names will be <code>NAME-cookbook-test</code>, rather than their FQDN.
I use this with a rake task that nukes them all from orbit
consistently :).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chef</span><span class="o">.</span><span class="n">chef_server_url</span> <span class="o">=</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:chef_server_url</span><span class="o">]</span>
</span><span class='line'><span class="n">chef</span><span class="o">.</span><span class="n">validation_key_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">current_dir</span><span class="si">}</span><span class="s2">/.chef/</span><span class="si">#{</span><span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:validation_client_name</span><span class="o">]</span><span class="si">}</span><span class="s2">.pem&quot;</span>
</span><span class='line'><span class="n">chef</span><span class="o">.</span><span class="n">validation_client_name</span> <span class="o">=</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:validation_client_name</span><span class="o">]</span>
</span><span class='line'><span class="n">chef</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">vm_name</span>
</span><span class='line'><span class="n">chef</span><span class="o">.</span><span class="n">provisioning_path</span> <span class="o">=</span> <span class="s2">&quot;/etc/chef&quot;</span>
</span><span class='line'><span class="n">chef</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="ss">:info</span>
</span></code></pre></td></tr></table></div></figure>


<p>The run list is going to be combined from the run lists defined from
the <code>cookbook_testers</code> hash above, and a shell environment variable,
<code>CHEF_RUN_LIST</code>, which is simply a comma-separated list of run list
items, similar to that used by <code>knife bootstrap</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">run_list</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="n">run_list</span> <span class="o">&lt;&lt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;CHEF_RUN_LIST&#39;</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="no">ENV</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="s1">&#39;CHEF_RUN_LIST&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">chef</span><span class="o">.</span><span class="n">run_list</span> <span class="o">=</span> <span class="o">[</span><span class="n">options</span><span class="o">[</span><span class="ss">:run_list</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">),</span> <span class="n">run_list</span><span class="o">].</span><span class="n">flatten</span>
</span></code></pre></td></tr></table></div></figure>


<p>To use the Vagrantfile, I export the shell variable with the
role(s)/recipe(s) I am testing, then run <code>vagrant up</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">% export </span><span class="no">CHEF_RUN_LIST</span><span class="o">=</span><span class="s2">&quot;recipe[apache2],recipe[apache2::mod_ssl]&quot;</span>
</span><span class='line'><span class="sx">% vagrant </span><span class="n">up</span>
</span></code></pre></td></tr></table></div></figure>


<p>Vagrant will bring up each VM one at a time, going through the full
cycle of provisioning. If there&rsquo;s an unhandled exception that causes
Chef to exit, then Vagrant also halts execution. If <code>vagrant up</code> is
rerun, then Vagrant continues to the <em>next</em> VM. To reprovision a
failed VM, it can be specified:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">% vagrant </span><span class="n">provision</span> <span class="n">centos5</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without the VM name, vagrant would reprovision all the VMs. Likewise,
<code>vagrant ssh NAME</code> can be used to open an SSH connection to the named
VM. This is useful to reprovision a VM that failed early, while
Vagrant is continuing on with the others.</p>

<h2>Full Vagrantfile</h2>

<p>The Vagrantfile is split up in the earlier section, but you can see
the full thing below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;chef&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;chef/config&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;chef/knife&#39;</span>
</span><span class='line'><span class="n">current_dir</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'><span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="s1">&#39;.chef&#39;</span><span class="p">,</span> <span class="s1">&#39;knife.rb&#39;</span><span class="p">))</span>
</span><span class='line'><span class="n">cookbook_testers</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">:centos5</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;centos5-cookbook-test&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:ipaddress</span> <span class="o">=&gt;</span> <span class="s2">&quot;172.16.13.5&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:run_list</span> <span class="o">=&gt;</span> <span class="s2">&quot;role[base],role[base_redhat]&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="ss">:centos6</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;centos6-cookbook-test&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:ipaddress</span> <span class="o">=&gt;</span> <span class="s2">&quot;172.16.13.6&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:run_list</span> <span class="o">=&gt;</span> <span class="s2">&quot;role[base],role[base_redhat]&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="ss">:lucid</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;lucid-cookbook-test&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:ipaddress</span> <span class="o">=&gt;</span> <span class="s2">&quot;172.16.13.10&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:run_list</span> <span class="o">=&gt;</span> <span class="s2">&quot;role[base],role[base_debian]&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="ss">:oneiric</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:hostname</span> <span class="o">=&gt;</span> <span class="s2">&quot;oneiric-cookbook-test&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:ipaddress</span> <span class="o">=&gt;</span> <span class="s2">&quot;172.16.13.11&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:run_list</span> <span class="o">=&gt;</span> <span class="s2">&quot;role[base],role[base_debian]&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="ss">Vagrant</span><span class="p">:</span><span class="ss">:Config</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">global_config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">cookbook_testers</span><span class="o">.</span><span class="n">each_pair</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="p">,</span> <span class="n">options</span><span class="o">|</span>
</span><span class='line'>    <span class="n">global_config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="nb">name</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>      <span class="n">vm_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">-cookbook-test&quot;</span>
</span><span class='line'>      <span class="n">ipaddress</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:ipaddress</span><span class="o">]</span>
</span><span class='line'>      <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">share_folder</span><span class="p">(</span><span class="s2">&quot;v-root&quot;</span><span class="p">,</span> <span class="s2">&quot;/vagrant&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="ss">:disabled</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>      <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>      <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">boot_mode</span> <span class="o">=</span> <span class="ss">:headless</span>
</span><span class='line'>      <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">host_name</span> <span class="o">=</span> <span class="n">vm_name</span>
</span><span class='line'>      <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:hostonly</span><span class="p">,</span> <span class="n">ipaddress</span>
</span><span class='line'>      <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:chef_client</span> <span class="k">do</span> <span class="o">|</span><span class="n">chef</span><span class="o">|</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">chef_server_url</span> <span class="o">=</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:chef_server_url</span><span class="o">]</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">validation_key_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">current_dir</span><span class="si">}</span><span class="s2">/.chef/</span><span class="si">#{</span><span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:validation_client_name</span><span class="o">]</span><span class="si">}</span><span class="s2">.pem&quot;</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">validation_client_name</span> <span class="o">=</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:validation_client_name</span><span class="o">]</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">node_name</span> <span class="o">=</span> <span class="n">vm_name</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">provisioning_path</span> <span class="o">=</span> <span class="s2">&quot;/etc/chef&quot;</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="ss">:info</span>
</span><span class='line'>        <span class="n">run_list</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>        <span class="n">run_list</span> <span class="o">&lt;&lt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;CHEF_RUN_LIST&#39;</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="no">ENV</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="s1">&#39;CHEF_RUN_LIST&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">chef</span><span class="o">.</span><span class="n">run_list</span> <span class="o">=</span> <span class="o">[</span><span class="n">options</span><span class="o">[</span><span class="ss">:run_list</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">),</span> <span class="n">run_list</span><span class="o">].</span><span class="n">flatten</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/04/github-is-classy/">Github Is Classy</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-04T18:42:00-07:00" pubdate data-updated="true">Mar 4<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Fact: GitHub is classy. This isn&rsquo;t just because
<a href="https://github.com/schacon">Scott Chacon</a> works there, either. Their
handling of a security issue today was very professional. That said, I
have some words to say about the issue itself and the aftermath, and
things you as an application developer can do to help, and to avoid
this kind of problem.</p>

<p><em>Disclaimer: I&rsquo;m not an application developer. I am a sysadmin with a
 diverse background in operating system security, including previously
 held GSEC and GCUX certifications from the SANS Institute/GIAC.</em></p>

<p><em>Second disclaimer: This is not an anti-Rails post. All web frameworks
 need to be conscious of security, and take bug reports for security
 issues seriously.</em></p>

<h1>Issue</h1>

<p><em>Update &ndash; Preface: I am not talking about a security vulnerability (a
la an exploit) in Rails. I am talking about a feature that allows
automatically generated code to do things that are not secure and it
is apparently on purpose and by design. This is the wrong thing to
do. Deny by default with whitelisting is the right thing to do.</em></p>

<p>There is a security issue in
<a href="https://github.com/rails/rails/issues/5228">Ruby on Rails</a>. The bug
is closed, but I haven&rsquo;t dug into find out if the actual problem is
fixed.</p>

<p>The bug itself is very serious. It allows a malicious user to send
arbitrary parameters to a Rails application without requiring
whitelisting up front. In fact,
<a href="https://github.com/rails/rails/pull/4062">three months ago an issue</a>
was opened in the Rails project to force new applications to enforce
whitelist mode by default. That bug was subsequently closed just a few
days ago. I&rsquo;m not going to do an analysis of the issue itself, you can go
read the linked tickets and do further research on the issue.</p>

<p><em>Update</em> I missed clarifying this. There is a second issue at hand.
 GitHub resolved the mass assignment bug by fixing their application.
 The second issue is that they had a vulnerability in their public key
 form update.</p>

<h2>Resolution and Aftermath</h2>

<p>You can read all about the initial resolution and retrospective on the
<a href="https://github.com/blog/1068-public-key-security-vulnerability-and-mitigation">GitHub blog</a>.
You can also read their
<a href="https://github.com/blog/1069-responsible-disclosure-policy">follow-up post</a>
on responsible disclosure.</p>

<p>The manner in which they handled the situation is a class act: they
behaved like professionals. Here&rsquo;s why:</p>

<ul>
<li>A user reported a problem with their app.</li>
<li>They worked with the user to resolve the problem.</li>
<li>The same user exploited another vulnerability to prove a point to
the Rails project, which is against the GitHub terms of service.</li>
<li>GitHub suspended the user&rsquo;s account in accordance with their terms
of service.</li>
</ul>


<p>As an unauthorized breach of a computer system, what Egor Homakov did
is illegal in the United States. It was also irresponsible and
unprofessional. However, his intent was not malicious. I think GitHub
did the right thing by giving him another chance in reinstating
Mr. Homakov&rsquo;s account several hours after the incident.</p>

<p>GitHub has issued two apologies about this incident. First for the
vulnerability existing in the first place, and second for not being
clear how customers and users can responsibly disclose security
vulnerabilities. They also committed to doing a security audit of
their code base.</p>

<p>GitHub is classy.</p>

<h1>Security</h1>

<p>After the above, I feel compelled to say some more things about
security in general. You are responsible for a lot of things regarding
the web applications in your infrastructure. One of those is security,
and you should do everything you can to write stable, secure code.</p>

<p>In a hackernews thread about this incident, Yehuda Katz said,
&ldquo;<a href="http://news.ycombinator.com/item?id=3664334">Not all security vulnerabilities can be protected automatically by a web framework</a>.&rdquo;</p>

<p>That is a fact. However, web frameworks should provide sane, secure
settings by default. Those settings should be modifiable by the
end-user, the developer. If a developer wishes to disable those
controls, they totally have that right. I think that they need to
understand the potential risk that they are accepting, and what impact
that might have on the business/organization implementing the
application.</p>

<p>This is <em>exactly</em> like the default setting of Red Hat Enterprise Linux
to enable SELinux by default on new installations. Whether you love or
hate this default, it is sane and secure. System administrators can
then use the system as is, or disable SELinux if that is an acceptable
level of risk.</p>

<p>Clearly in this incident, it is <em>not</em> an acceptable level of risk for
GitHub, as they have repaired their application. It would have better
to do that long ago, but at least it&rsquo;s fixed now.</p>

<p>Security and convenience are quite often polar opposites and mutually
exclusive. This is not always the case, but it is true much of the
time, if not most of the time. The choice for Rails to not have
whitelisting by default is in favor of developer convenience. Yes, it
is up to the developer to make their application secure, but that was
already the case. This simply creates extra work for them to do so.</p>

<p>Deny-all by default is the sane, correct and secure posture to take
when building systems. This is the practice of many tools and
operating system defaults &ndash; SELinux as mentioned, or &ldquo;no open ports&rdquo;
per Ubuntu&rsquo;s practice. You don&rsquo;t have to agree with it, and you
certainly can change it, but that doesn&rsquo;t change the fact that it is
<em>correct</em> and <em>sane</em>.</p>

<h2>Vulnerability Disclosure</h2>

<p>There is an entire field in information technology devoted to
vulnerability disclosure. This is typically done by people performing
&ldquo;ethical hacking&rdquo; and is one thing done when a code base goes through
a security audit. This is a field that has responsible professionals
participating in a variety of companies, and if it sounds interesting
to you, I recommend the variety of courses offered by the SANS
Institute:</p>

<ul>
<li><a href="https://www.sans.org/security-training/web-app-penetration-testing-ethical-hacking-942-mid">Web Application Penetration Testing (SEC542)</a></li>
<li><a href="https://www.sans.org/security-training/network-penetration-testing-ethical-hacking-937-mid">Network Penetration Testing (SEC560)</a></li>
<li><a href="https://www.sans.org/security-training/advanced-penetration-testing-exploits-ethical-hacking-1517-mid">Advanced Penetration Testing (SEC660)</a></li>
</ul>


<h1>What You Can Do</h1>

<p>First of all, understand the security guidelines and best practices
for the programming language you&rsquo;re using. Doing things that are
typesafe, or avoid buffer overflows, that kind of thing. Also
understand and follow the security guideslines and best practices for
the web framework you&rsquo;re using. The Ruby on Rails project has a fairly
detailed
<a href="http://guides.rubyonrails.org/security.html">security guide</a>. If
you&rsquo;re taking shortcuts, understand the possible risks with that. If
you don&rsquo;t know the risks, or understand the guidelines, please ask
someone in the community for help.</p>

<p>I strongly recommend you also learn the security guidelines and
associated best practices for the operating system or distribution
that your application will run on in production. If your organization
has operations staff, I&rsquo;m sure they can help you learn and understand.
If they don&rsquo;t, they&rsquo;re not doing their job :).</p>

<p>Every organization and every application is different. The security
implications are going to vary by industry. Talk to the business
owners and find out what the level of security risk they are
comfortable accepting.</p>

<p>Above all, be a professional. Don&rsquo;t flippantly close security bugs.
Don&rsquo;t be a dick on discussions about security topics.</p>

<p>In other words, be classy. Like GitHub.</p>

<p>Thank you.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/26/xcode-command-line-tools/">Xcode Command Line Tools</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-26T00:07:00-07:00" pubdate data-updated="true">Feb 26<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently, Apple did the most awesome thing for non-Xcode developers.</p>

<p>They made the development tools available as a
<a href="https://developer.apple.com/library/ios/#documentation/DeveloperTools/Conceptual/WhatsNewXcode/Articles/xcode_4_3.html">standalone package!</a></p>

<p>This is awesome news for those of us who only have<sup>Whad</sup> Xcode
installed to install RubyGems that compile native extensions, or for
installing software with Homebrew, MacPorts or similar.. You can
download them by logging into the
<a href="https://developer.apple.com/downloads">Developer Download</a> site.</p>

<p>This appears to be work started by
<a href="http://kennethreitz.com/xcode-gcc-and-homebrew.html">Kenneth Reitz</a>
with his
<a href="https://github.com/kennethreitz/osx-gcc-installer/">OSX GCC Installer</a>
project. I did try that project out, but ran into issues I didn&rsquo;t
resolve right away, so I reverted to using Xcode proper. However with
the package from Apple I don&rsquo;t seem to have any issues so far.</p>

<p>If you already have Xcode installed, you may want to remove it first.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo /Developer-3.2.6/Library/uninstall-devtools
</span><span class='line'>sudo /Developer/Library/uninstall-devtools --mode<span class="o">=</span>all /thx
</span></code></pre></td></tr></table></div></figure>


<p>My understanding is that you can remove the <code>/Developer*</code>
director(y|ies) when complete. I had ollllld Xcode on the system where
I first did this.</p>

<p>Next, download and install the package from Apple. It&rsquo;s about 170M and
takes only a couple minutes to install; sorry I don&rsquo;t have a Chef
recipe for this ;).</p>

<p>I did run into an issue with Homebrew where it wasn&rsquo;t finding the
right gcc binary. I had to run the following commands to fix
<a href="https://github.com/mxcl/homebrew/issues/10245">that issue</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo xcode-select -switch /usr/bin
</span><span class='line'>sudo ln -sf /usr/bin/llvm-gcc-4.2 /usr/bin/gcc-4.2
</span></code></pre></td></tr></table></div></figure>


<p>You wouldn&rsquo;t think that something like an 8G installation would matter
in 2012. However, disk space is a precious commodity on MacBook Airs
and systems that have SSDs as the root volume. This is very welcome
change for me, especially since it means that future Mac OS X
installations do not require a large download before I can start doing
things that get my
<a href="http://jtimberman.housepub.org/blog/2011/04/03/managing-my-workstations-with-chef/">system ready to use</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/25/recipe-for-building-emacs/">Recipe for Building Emacs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-25T23:51:00-07:00" pubdate data-updated="true">Feb 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It is no secret that
<a href="http://jtimberman.housepub.org/blog/2011/05/06/switching-to-gnu-emacs/">I use GNU Emacs</a>
as my default text editor. It is perhaps less evident but no less
relevant that I use Emacs 24. I really like the built-in color theme
support and the package management system for getting the various
modes I like to use.</p>

<p>Recently, I revamped my
<a href="https://github.com/jtimberman/.emacs.d">Emacs configuration</a>. This
post isn&rsquo;t about that topic. Instead, this post is about how I made
sure that all the systems I want to use Emacs on have the latest
version available.</p>

<p>Unfortunately, Emacs 24 is still unreleased, so it is not available as
the default package on the distributions I use for my personal systems
(Ubuntu/Debian flavors). I wrote a recipe to install Emacs
from source. This is easy enough to do, but since I already automate
everything on my home network with Chef, it was a natural fit for a
new recipe. I simply added this to my local <code>emacs</code> cookbook, in
<code>recipes/source24.rb</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">srcdir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:file_cache_path</span><span class="o">]</span><span class="si">}</span><span class="s2">/emacs-source&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">%w{ git-core build-essential texinfo autoconf libncurses-dev }</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">prereq</span><span class="o">|</span> <span class="n">package</span> <span class="n">prereq</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">git</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="ss">Chef</span><span class="p">:</span><span class="ss">:Config</span><span class="o">[</span><span class="ss">:file_cache_path</span><span class="o">]</span><span class="si">}</span><span class="s2">/emacs-source&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">repository</span> <span class="s2">&quot;git://git.savannah.gnu.org/emacs.git&quot;</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:checkout</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">bash</span> <span class="s2">&quot;build emacs24&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">cwd</span> <span class="n">srcdir</span>
</span><span class='line'>  <span class="n">creates</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">srcdir</span><span class="si">}</span><span class="s2">/src/emacs&quot;</span>
</span><span class='line'>  <span class="n">code</span> <span class="o">&lt;&lt;-</span><span class="no">EOH</span>
</span><span class='line'><span class="sh">    ./autogen.sh &amp;&amp; \</span>
</span><span class='line'><span class="sh">    ./configure --without-x &amp;&amp; \</span>
</span><span class='line'><span class="sh">    make bootstrap &amp;&amp; \</span>
</span><span class='line'><span class="sh">    make 2&gt;&amp;1 &gt;| make-#{node.name}-#{node[&#39;ohai_time&#39;]}</span>
</span><span class='line'><span class="no">  EOH</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">execute</span> <span class="s2">&quot;install emacs24&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">cwd</span> <span class="n">srcdir</span>
</span><span class='line'>  <span class="n">command</span> <span class="s2">&quot;make install 2&gt;&amp;1 &gt;| make-</span><span class="si">#{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;ohai_time&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">creates</span> <span class="s2">&quot;/usr/local/bin/emacs&quot;</span>
</span><span class='line'>  <span class="n">only_if</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">srcdir</span><span class="si">}</span><span class="s2">/src/emacs --version&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I updated my base role to replace <code>recipe[emacs]</code> with
<code>recipe[emacs::source24]</code> and ran Chef. It took about 25 minutes to do
the build, but now I have the same version of Emacs everywhere, and
there was much rejoicing.</p>

<p>And yes, you&rsquo;re absolutely right, I could just build a package and
install that. However, I don&rsquo;t want to set up and maintain a package
management repository for my small network, as
<a href="http://ckbk.it/reprepro">easy</a> as <a href="http://ckbk.it/apt">that</a> may be.</p>

<p>My OS X systems are a special case because I&rsquo;m using Homebrew, but the
<a href="http://ckbk.it/homebrew">homebrew cookbook</a> does not [yet?] support
install-time options, and I didn&rsquo;t spend the time adding support for
building the OS X Emacs w/ cocoa support from git. When I tackle that,
I&rsquo;ll make another post, so stay tuned!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/25/disable-airdrop-lion/">Disable AirDrop in Mac OS X Lion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-25T23:20:00-07:00" pubdate data-updated="true">Feb 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Mac OS X Lion introduced a new nifty feature called AirDrop. This
allows users on a local network to drag and drop files to each other
with Finder.</p>

<p>While it seems that this would be useful, there are security
implications. After looking through
<a href="https://www.google.com/?q=disable+airdrop#sclient=psy&amp;hl=en&amp;site=&amp;source=hp&amp;q=disable+airdrop&amp;pbx=1&amp;oq=disable+airdrop&amp;aq=f&amp;aqi=&amp;aql=&amp;gs_sm=3&amp;gs_upl=0l0l0l884l0l0l0l0l0l0l0l0ll0l0&amp;bav=on.2,or.r_gc.r_pw.,cf.osb&amp;fp=2c07cc10bcee84ff&amp;biw=1440&amp;bih=786">Google Search Results</a>
on the topic, I found some un-helpful information in a <a href="http://forums.macrumors.com/showthread.php?t=1191359">random forum</a>
post (unsurprising). A little more
<a href="http://derflounder.wordpress.com/2011/10/07/disabling-airdrop-from-the-command-line/">review of the search results</a>
resulted in finding the actual <code>defaults(1)</code> command to do so:</p>

<pre><code>defaults write com.apple.NetworkBrowser DisableAirDrop -bool YES
</code></pre>

<p>Naturally, I put this in a Chef recipe and applied it on all my Macs
post haste:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">mac_os_x_userdefaults</span> <span class="s2">&quot;Disable AirDrop&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">domain</span> <span class="s2">&quot;com.apple.NetworkBrowser&quot;</span>
</span><span class='line'>    <span class="n">key</span> <span class="s2">&quot;DisableAirDrop&quot;</span>
</span><span class='line'>    <span class="n">value</span> <span class="kp">true</span>
</span><span class='line'>    <span class="n">type</span> <span class="s2">&quot;bool&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The resource above is available in my <a href="http://ckbk.it/mac_os_x">mac_os_x cookbook</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/25/changing-class-names/">Changing Class Names</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-25T09:39:00-07:00" pubdate data-updated="true">Feb 25<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you change a class name in your library, <em>do a major version
change</em>! You don&rsquo;t know who is using your library, even the
undocumented parts.</p>

<h2>Background</h2>

<p>Recently, we had a post on the
<a href="http://lists.opscode.com">Chef mailing list</a> that using bluepill for
the Chef Server daemon process(es) was broken. Upon further
investigation of the output from
<a href="https://gist.github.com/1847128">Chef debug output</a>, it appeared to
be an issue with
<a href="https://github.com/arya/bluepill/issues/132">Bluepill itself</a>, but
after looking into that ticket, the <a href="http://rubygems.org/gems/daemons">daemons gem</a> had made a change.</p>

<p>Out of curiosity, I was compelled to find out what the source of the
change in the daemons gem was. This lead to a yak shave, as first, I
had to look up the <a href="http://rubygems.org/gems/daemons">daemons gem</a> on
RubyGems.org to try and find the source. The author of the gem still
uses RubyForge rather than GitHub. That&rsquo;s fine, but it means I have to
do some link-spelunking to find where the <a href="http://rubyforge.org/projects/daemons">source code lives</a>.</p>

<p>Now I take a look at the change log:</p>

<pre><code>Release 1.1.8: February 7, 2012
rename to daemonization.rb to daemonize.rb (and Daemonization to Daemonize) to ensure compatibility.

Release 1.1.7: February 6, 2012
start_proc: Write out the PID file in the newly created proc to avoid race conditions.
daemonize.rb: remove to simplify licensing (replaced by daemonization.rb).

Release 1.1.6: January 18, 2012
Add the :app_name option for the "call" daemonization mode.

Release 1.1.5: December 19, 2011
Catch the case where the pidfile is empty but not deleted and restart
the app (thanks to Rich Healey)
</code></pre>

<p>I then went to the ticket tracker to find out what the source of the
changes might be. Fortunately, there was an open issue that I could
<a href="http://rubyforge.org/tracker/index.php?func=detail&amp;aid=29516&amp;group_id=524&amp;atid=2084">reference</a>.</p>

<p>My question (which I posted to the ticket) is why wouldn&rsquo;t renaming a
class cause the author to do a new major version? This way other Gems
that rely on this as a dependency could use the paranoia operator,
<code>~&gt;</code> so the broken class name wouldn&rsquo;t break usage elsewhere.</p>

<p>I&rsquo;m glad that the daemons gem author did the right thing and yanked
the broken version. Open source worked well here. The process of
finding this was a bit slower than it should have been, and I think
that the bluepill maintainers moved too quickly to &ldquo;resolve&rdquo; the
issue, rather than post their concern about the class naming. Kudos to
thuehlinger for fixing his gem, though.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/15/testing-with-fission/">Testing With Fission</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-15T22:53:00-07:00" pubdate data-updated="true">Feb 15<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post, I&rsquo;m going to talk about the fission gem:</p>

<ul>
<li><a href="http://rubygems.org/gems/fission">http://rubygems.org/gems/fission</a></li>
<li><a href="https://github.com/thbishop/fission">https://github.com/thbishop/fission</a></li>
</ul>


<p>I primarily use this to manage the VMware Fusion virtual machines I
use for testing <a href="http://community.opscode.com/users/opscode">Opscode&rsquo;s Chef Cookbooks</a>.</p>

<p>This post is rather light on specific details about things that are
either &ldquo;common&rdquo; knowledge or documented elsewhere. Particularly, I
won&rsquo;t tell you how to set up the virtual machines, other than a few
notes that I think make it easier to manage virtual machines in this
way. In other words, you&rsquo;re smart and can figure them out.</p>

<h2>Install and Configure</h2>

<p>The first step to use the fission RubyGem is to install it. If you
don&rsquo;t like RubyGems, then create a package or grab the source from the
GitHub link, above.</p>

<pre><code>gem install fission
</code></pre>

<p>Test that it is detecting your VMware Fusion VMs:</p>

<pre><code>fission status
</code></pre>

<p>Fission has a configuration file, <code>~/.fissionrc</code>, which is yaml
format. If the status command fails, you may need to configure fission
to find the <code>vmrun</code> command. Here&rsquo;s the example from my system:</p>

<pre><code>---
vmrun_bin: /Applications/VMware Fusion.app/Contents/Library/vmrun
</code></pre>

<h2>Install an OS on a VM</h2>

<p>If you&rsquo;re reading this, I presume you know how to install an OS in a
VMware virtual machine. I do a number of tasks during the installation
to make it easy and consistent to work with all my test VMs.</p>

<ul>
<li>Use bridged networking with DHCP</li>
</ul>


<p>This usually results in the least amount of hassle for connecting to
the VM without any tunneling or port forwarding tomfoolery.</p>

<ul>
<li>Give it a simple VM name with alphanumeric characters only.</li>
<li>Use the same hostname during installation as the VM name</li>
</ul>


<p>In the examples below, I use my &ldquo;guineapig&rdquo; system. I also have other
systems like &ldquo;ubuntu1110&rdquo;, &ldquo;freebsd82&rdquo; and &ldquo;centos6&rdquo;. This is the name
you&rsquo;ll use to refer to the VM with fission, so it should be short,
easy to type and clearly identifiable.</p>

<ul>
<li>Set the root password, even if the OS doesn&rsquo;t use the root account</li>
<li>Make sure SSH as root is enabled</li>
</ul>


<p>Some Linux distributions such as Ubuntu do not enable the root login.
This is for testing, so I really don&rsquo;t care, and I can always write a
Chef recipe to lock things down (as I would in production) if
required.</p>

<p>I also set a simple password that I can use with <code>-P</code> to <code>knife
bootstrap</code> without the shell doing anything with special characters.</p>

<ul>
<li>Use NTP</li>
</ul>


<p>Install the NTP package for your operating system. The workflow here
(and the whole point really) is to make heavy use of VMware Fusion
snapshots and rollback, so it is important that the system time is
correct. I customized the bootstrap templates I use to add <code>ntpdate</code>.</p>

<h2>Using Fission</h2>

<p>And now the moment you&rsquo;ve been waiting for. First, see the fission
README for full detail on the commands available. I&rsquo;m going to focus
here on how I use it.</p>

<p>After the install and post install tasks are done, I create a
new snapshot for the VM.</p>

<pre><code>% fission status
guineapig        [running]
% fission snapshot create guineapig base
</code></pre>

<p>The name is &ldquo;base&rdquo; because thats a good name for a baseline. It can be
useful to create specifically named snapshots for particular purposes.</p>

<p>I use Opscode Hosted Chef as my server and I already have my local
workstation set up with the validation key, a Chef repository and have
uploaded the cookbook(s) I use for testing. I&rsquo;ll use &ldquo;knife
bootstrap&rdquo; to kick off a run on my VM:</p>

<pre><code>% knife bootstrap 10.1.1.129 -x root -Pvanilla -r 'recipe[apache2]'
...
INFO: service[apache2] restarted
INFO: Chef Run complete in 44.324473 seconds
</code></pre>

<p>Sweet, it worked. However, if the Chef run fails, I can log in as
root, fix the bug and rerun, or whatever else may need to be done.
Then once I&rsquo;m ready to reset the VM, fission comes back to play.</p>

<pre><code>% fission snapshot revert guineapig base
Reverting to snapshot 'base'
Reverted to snapshot 'base'
</code></pre>

<p>Note that fission will poweroff the VM when reverting the snapshot.
Turn it on again with the start command.</p>

<pre><code>% fission status
guineapig        [not running]

% fission start guineapig
Starting 'guineapig'
VM 'guineapig' started

% fission status
guineapig        [running]
</code></pre>

<p>And after logging in, we can see that apache2 is not installed as it
should not be after the snapshot is restored.</p>

<pre><code>% ssh root@guineapig 
root@guineapig's password: 
root@guineapig:~# dpkg -l apache2
No packages found matching apache2.
</code></pre>

<p>The VM is now ready to do my bidding once again.</p>

<h1>Cleanup</h1>

<p>Note that reverting the snapshot doesn&rsquo;t delete the Chef node or
client objects. Since fission is a Ruby library, a simple knife plugin
can wrap up all the fission revert, restart and Chef cleanup, though.
I called mine nukular.</p>

<pre><code>% knife nukular guineapig base guineapig.int.example.com
</code></pre>

<p>And here&rsquo;s the plugin I&rsquo;m using:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;chef/knife&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">KnifePlugins</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Nukular</span> <span class="o">&lt;</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Knife</span>
</span><span class='line'>      <span class="n">deps</span> <span class="k">do</span>
</span><span class='line'>        <span class="nb">require</span> <span class="s1">&#39;fission&#39;</span>
</span><span class='line'>        <span class="nb">require</span> <span class="s1">&#39;chef/node&#39;</span>
</span><span class='line'>        <span class="nb">require</span> <span class="s1">&#39;chef/api_client&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">banner</span> <span class="s2">&quot;knife nukular VM SNAPSHOT [NODE]&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">run</span>
</span><span class='line'>        <span class="n">vm</span><span class="p">,</span> <span class="n">snapshot</span> <span class="o">=</span> <span class="vi">@name_args</span>
</span><span class='line'>        <span class="n">node</span> <span class="o">=</span> <span class="vi">@name_args</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="n">nil?</span> <span class="p">?</span> <span class="n">vm</span> <span class="p">:</span> <span class="vi">@name_args</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
</span><span class='line'>        <span class="ss">Fission</span><span class="p">:</span><span class="ss">:Command</span><span class="o">::</span><span class="no">SnapshotRevert</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">args</span><span class="o">=[</span><span class="n">vm</span><span class="p">,</span> <span class="n">snapshot</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span>
</span><span class='line'>        <span class="ss">Fission</span><span class="p">:</span><span class="ss">:Command</span><span class="o">::</span><span class="no">Start</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">args</span><span class="o">=[</span><span class="n">vm</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span>
</span><span class='line'>        <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Node</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</span><span class='line'>        <span class="ss">Chef</span><span class="p">:</span><span class="ss">:ApiClient</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The command-line usage takes 2 or 3 arguments. The first two must be
the VM name and the snapshot name, e.g. <code>guineapig</code> and <code>base</code>. If the
node name is different than the VM name, then specify it.</p>

<pre><code>% knife nukular guineapig base guineapig.int.example.com
</code></pre>

<p>Note that the plugin has <em>zero</em> error handling or any other sensible
things. You may want to modify it before you use it. Or not, these are
just test systems after all.</p>

<h2>Full example</h2>

<p>Minus the output from the commands, here is the full output of testing
the Opscode apache2 cookbook on my guinea pig. Assume that all the
required things from my Chef Repository have been uploaded to the Chef
Server and the knife configuration is correct. Also, the <code>chef-full</code>
bootstrap template specified here is a customized version of the
template in the
<a href="https://github.com/opscode/chef/blob/master/chef/lib/chef/knife/bootstrap/chef-full.erb">Chef source master branch template</a>
that has <code>ntpdate -u pool.ntp.org</code> in it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sx">% fission </span><span class="n">status</span>
</span><span class='line'><span class="sx">% fission </span><span class="n">snapshot</span> <span class="n">create</span> <span class="n">guineapig</span> <span class="n">testing</span><span class="o">-</span><span class="n">apache2</span>
</span><span class='line'><span class="sx">% knife </span><span class="n">bootstrap</span> <span class="mi">10</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="mi">129</span> <span class="o">-</span><span class="n">x</span> <span class="n">root</span> <span class="o">-</span><span class="n">P</span> <span class="n">vanilla</span> <span class="p">\</span>
</span><span class='line'>  <span class="o">-</span><span class="n">r</span> <span class="s1">&#39;recipe[apache2]&#39;</span> <span class="o">-</span><span class="n">d</span> <span class="n">chef</span><span class="o">-</span><span class="n">full</span>
</span><span class='line'><span class="sx">% knife </span><span class="n">nukular</span> <span class="n">guineapig</span> <span class="n">testing</span><span class="o">-</span><span class="n">apache2</span> <span class="n">guineapig</span><span class="o">.</span><span class="n">int</span><span class="o">.</span><span class="n">housepub</span><span class="o">.</span><span class="n">org</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it. I hope you find this helpful!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/29/dnsimple-self-registration-recipe/">DNSimple Self Registration Recipe</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-29T19:00:00-07:00" pubdate data-updated="true">Jan 29<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Earlier this month, I completed a
<a href="/blog/2012/01/02/switching-to-dnsimple/">switch to DNSimple</a> for my
domain&rsquo;s DNS provider. I am still happy with the switch, and finally,
just now, got around to writing a recipe to have my systems
automatically register themselves in DNS.</p>

<p>In the post, I described automatically adding the DNS entries with the
<a href="http://community.opscode.com/cookbooks/dnsimple">dnsimple cookbook</a>.
I did this as a proof of concept, but I didn&rsquo;t add it to all my nodes,
instead using my existing data bag-driven solution.</p>

<p>That said, this post serves as a brief document on how you can mimic
this behavior with your own environment.</p>

<h1>Encrypted Data Bag</h1>

<p>I put my DNSimple credentials in an
<a href="http://wiki.opscode.com/display/chef/Encrypted+Data+Bags">encrypted data bag</a>.
Since I have to decrypt and read the entire thing anyway, I also store
the relevant data there. I keep my encrypted data bags in a bag called
secrets. The structure looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;dnsimple&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;api_token&quot;</span><span class="o">:</span> <span class="s2">&quot;DNSimple API Token Here&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;domain&quot;</span><span class="o">:</span> <span class="s2">&quot;your-domain.example.com&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;username&quot;</span><span class="o">:</span> <span class="s2">&quot;DNSimple username&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;password&quot;</span><span class="o">:</span> <span class="s2">&quot;DNSimple password&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Replace the values with your values. Encrypting the data is optional,
but requires that you create a secret key or key file. Read my
<a href="/blog/2011/08/06/encrypted-data-bag-for-postfix-sasl-authentication/">previous post on the topic</a>
for more information.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="o">%</span> <span class="nx">knife</span> <span class="nx">data</span> <span class="nx">bag</span> <span class="nx">from</span> <span class="nx">file</span> <span class="nx">secrets</span> <span class="nx">dnsimple</span><span class="p">.</span><span class="nx">json</span>
</span><span class='line'><span class="o">%</span> <span class="nx">knife</span> <span class="nx">data</span> <span class="nx">bag</span> <span class="nx">from</span> <span class="nx">file</span> <span class="nx">secrets</span> <span class="nx">dnsimple</span><span class="p">.</span><span class="nx">json</span> <span class="o">--</span><span class="nx">secret</span><span class="o">-</span><span class="nx">file</span> <span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">chef</span><span class="o">/</span><span class="nx">encrypted_data_bag_secret</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first command just uploads the data bag item, the second encrypts
it. Note that I manage my workstation with Chef, so I will use the
same secret file as the Chef default. The secret file needs to be
copied to each system that will need it.</p>

<h1>Recipe</h1>

<p>The recipe looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dnsimple</span> <span class="o">=</span> <span class="n">encrypted_data_bag_item</span><span class="p">(</span><span class="s2">&quot;secrets&quot;</span><span class="p">,</span> <span class="s2">&quot;dnsimple&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">dnsimple_record</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;hostname&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">.int.</span><span class="si">#{</span><span class="n">dnsimple</span><span class="o">[</span><span class="s1">&#39;domain&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">content</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;ipaddress&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">type</span> <span class="s2">&quot;A&quot;</span>
</span><span class='line'>  <span class="n">action</span> <span class="ss">:create</span>
</span><span class='line'>  <span class="n">username</span> <span class="n">dnsimple</span><span class="o">[</span><span class="s1">&#39;username&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">password</span> <span class="n">dnsimple</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">domain</span> <span class="n">dnsimple</span><span class="o">[</span><span class="s1">&#39;domain&#39;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As
<a href="/blog/2011/08/06/encrypted-data-bag-for-postfix-sasl-authentication/">mentioned in the previous blog post</a>,
the <code>encrypted_data_bag_item</code> method is in a library. Either add that
library to your cookbook, or use the class directly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dnsimple</span> <span class="o">=</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;secrets&quot;</span><span class="p">,</span> <span class="s2">&quot;dnsimple&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;re not using an encrypted data bag, then the item can be
accessed with the normal method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">dnsimple</span> <span class="o">=</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s2">&quot;bagname&quot;</span><span class="p">,</span> <span class="s2">&quot;dnsimple&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The real work happens in the <code>dnsimple_record</code> LWRP, which will add an
&ldquo;A&rdquo; record for the system running the recipe. Note that the actual
entry is going to use the <code>int</code> subdomain, and it will use the domain
stored in the data bag item. It also will use the default IP address
of the node, which means the IP for the interface with the default
route.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/28/iterm2-with-tmux/">iTerm2 With Tmux</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-28T15:03:00-07:00" pubdate data-updated="true">Jan 28<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A new &ldquo;which tool is best&rdquo; battle is raging in the internets amongst
developers and system administrators. The contestants are <a href="http://www.gnu.org/software/screen/">screen</a>
and <a href="http://tmux.sourceforge.net/">tmux</a>, and the
<a href="https://www.google.com/search?q=tmux+vs+screen">jury is still out</a>.
This is very much an argument over what color to paint the bikeshed,
but with the latest version of
<a href="http://www.iterm2.com/">iTerm2</a>, I think tmux is even more
compelling. Personally, I chose tmux awhile ago.</p>

<p>At my <a href="http://opscode.com">day job</a>, I worked with a customer that
uses tmux for remote pairing between developers. At the time, tmux had
better customizability, and better split-pane support (screen didn&rsquo;t
yet have vertical split). I stuck with tmux ever since, and was very
pleased when an iTerm2 update announced integration with tmux.</p>

<h1>iTerm2</h1>

<p>For those who aren&rsquo;t aware, iTerm2 is an alternate terminal program
for Mac OS X. It is actually an updated codebase from the original,
<a href="http://iterm.sourceforge.net/">iTerm</a>, which is effectively
<a href="http://iterm.sourceforge.net/news.shtml">unmaintained</a>. iTerm2 offers
a lot of excellent features like split panes, Growl support, and
<a href="http://www.iterm2.com/#/section/features">many more</a>.</p>

<p>One of the excellent new features is integration with tmux.</p>

<h1>iTerm2&rsquo;s tmux integration</h1>

<p>If you already have iTerm2 installed, you may have seen the update
check prompt you to update. You also need to install a special version
of tmux that has the integration patched. The iTerm2 author is working
with the tmux author to get this into the latest tmux codebase, so
hopefully the custom compiled version won&rsquo;t be necessary soon.</p>

<p>Using the new feature is relatively straightforward. Start up iTerm2
like normal. Then run <code>tmux -C</code> to open a new iTerm2 window that works
like tmux.</p>

<p><img src="http://img.skitch.com/20120128-cxjbh9hf9feagn5p5ieg574uce.png" alt="Launch tmux in iTerm2" /></p>

<p>Use the tmux menu in iTerm2 to open new windows in tmux. Note that there
are keyboard shortcuts for each of these, and they are not the same as
the tmux window commands.</p>

<p><img src="http://img.skitch.com/20120128-diexhy69d8t3b9da6g65yjmsum.png" alt="Use tmux menu to open buffers" /></p>

<p>You can also attach to a tmux session running in iTerm2. In the
screenshot, this is running on the same system, for example purposes.
However, since OS X has SSH, this can be useful if you want to SSH to
another system in the local network and connect to the running
session. For example, the system shown below is my wife&rsquo;s iMac over
screensharing, but I wouldn&rsquo;t need to use screenshare (or participate
in its lag) to connect to this anymore. The same holds true for
connecting to my work laptop if necessary.</p>

<p><img src="http://img.skitch.com/20120128-txr67q3jftmcw26n84jm5hpgm.png" alt="Attach to tmux session in iTerm2" /></p>

<p>In this final example screenshot, you can see that I have multiple
panes split in one iTerm2 tab. These correspond to the split windows
in the attached tmux in the other window. Also, the two tabs in the
iTerm2 window are separate tmux windows (<code>0:zsh</code> and <code>1:zsh</code>).</p>

<p><img src="http://img.skitch.com/20120128-miaa1dkeatt2hebxcxst8sydy1.png" alt="iTerm2 panes are panes in tmux" /></p>

<p>And now, I can SSH to that system and attach to the tmux session
started by iTerm2.</p>

<p><img src="http://img.skitch.com/20120129-gjgajqnekq93da59m4r86ewh2k.png" alt="SSH to remote and run tmux attach" /></p>

<p><img src="http://img.skitch.com/20120129-j2x4iir5557nt68n5jmr64f8dp.png" alt="tmux is attached to iTerm2 session" /></p>

<h1>Automating Installation with Chef</h1>

<p>Installing OS X apps is quite easy, but I automate them
<a href="/blog/2011/04/03/managing-my-workstations-with-chef/">with Chef</a>
anyway. While it is a simple &ldquo;install update and restart&rdquo;, with a
couple commands to install the update, I do have three systems I want
this on. I updated my
<a href="http://community.opscode.com/cookbooks/iterm2">iterm2 cookbook</a> to
support installing the tmux integration for iTerm2. This is disabled
by default, so it needs to be enabled via a node attribute. For
example, I have this in my <code>workstation</code> role applied to my OS X
workstations.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">name</span> <span class="s2">&quot;workstation&quot;</span>
</span><span class='line'><span class="n">description</span> <span class="s2">&quot;Mac OS X workstations&quot;</span>
</span><span class='line'><span class="n">run_list</span><span class="p">(</span><span class="s2">&quot;recipe[tmux]&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">default_attributes</span><span class="p">(</span>
</span><span class='line'>  <span class="s2">&quot;iterm2&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;tmux_enabled&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check out the iterm2 cookbook&rsquo;s README for more information.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/01/02/chef-report-handler-for-growl/">Chef Report Handler for Growl</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-01-02T20:37:00-07:00" pubdate data-updated="true">Jan 2<span>nd</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few weeks ago, I listened to the
<a href="http://thechangelog.com/post/11317828888/episode-0-6-8-growl-and-open-source-in-the-app-store-wit">Changelog Podcast</a>
episode featuring Chris Forsythe, lead of the Growl project. I
actually don&rsquo;t<sup>Wdidn</sup>&rsquo;t use Growl for a long time, because I really
disliked notifications of any kind, as they are distracting. However,
I do appreciate the project, and supporting them by purchasing Growl
on the App Store seemed totally reasonable.</p>

<p>Of course, buying the app means it was installed on the spot. I always
resisted it in the past because it was bundled with so many apps, but
I don&rsquo;t want unsolicited software to show up on my computer. Now, it
seemed a bit more natural, and I made a few configuration tweaks (I
should put those into Chef&hellip;). I&rsquo;m actually happy to use it now,
especially since it has a nice network accessible API.</p>

<h1>Growlnotify</h1>

<p>Shortly after I started using Growl on my work system, I looked into
ways I could get notifications fired off from the command-line after
long running processes finished. In particular, I wanted to get a
notification that <code>knife ec2 server create</code> was done. I found the
<code>growlnotify</code> program, which is available via
<a href="https://github.com/mxcl/homebrew">homebrew</a>. This is quite a nifty
tool, and I set it to use immediately, doing things like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>knife ec2 server create <span class="se">\</span>
</span><span class='line'>  -f m1.small -I <span class="nv">$lucid_small</span> -x ubuntu <span class="se">\</span>
</span><span class='line'>  -r <span class="s1">&#39;role[base],role[webserver]&#39;</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>growlnotify -m <span class="s2">&quot;Finished launching 1 instance&quot;</span> <span class="o">||</span> <span class="se">\</span>
</span><span class='line'>growlnotify -m <span class="s2">&quot;failed to launch instance&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I could kick off the server creation, switch focus to another
workspace, and then know via growl if the instance was created.</p>

<h1>Chef Handler</h1>

<p>As many know, I
<a href="http://jtimberman.housepub.org/blog/2011/04/03/managing-my-workstations-with-chef/">manage my workstations with Chef</a>.
Chef has a pretty cool
<a href="http://wiki.opscode.com/display/chef/Exception+and+Report+Handlers">exception and report handler API</a>
that has a lot of flexibility. I thought it would be fun to throw
together a simple report handler that would send a growl notification
after a Chef run. In this case, it will report the elapsed time of the
run if it was successful, or report an exception if it failed.</p>

<p>Using the handler is pretty straightforward. Install the
<code>chef-handler-growl</code> Gem, then configure chef-client (or solo).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;chef/handler/growl&quot;</span>
</span><span class='line'><span class="n">report_handlers</span> <span class="o">&lt;&lt;</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Growl</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">exception_handlers</span> <span class="o">&lt;&lt;</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">Growl</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then run Chef, and see something like this:</p>

<p><img src="https://img.skitch.com/20120103-emxnsfht3557xjcp4rshxcufka.png" alt="Chef Handler Growl" /></p>

<p>The handler is available as a
<a href="http://rubygems.org/gems/chef-handler-growl">RubyGem</a>. You can also
view the <a href="https://github.com/jtimberman/chef-handler-growl">source</a>. I
created issues on the GitHub project for the two items on the roadmap, too.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/5/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/3/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("jtimberman", 3, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/jtimberman" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @jtimberman</a>
  
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/09/02/chef-node-dot-debug-value/">Chef::Node.debug_value</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/21/load-current-resource-and-chef-shell/">Load_current_resource and Chef-shell</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/30/chefdk-and-ruby/">ChefDK and Ruby</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/01/evolution-of-cookbook-development/">Evolution of Cookbook Development</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/19/managing-multiple-aws-account-credentials/">Managing Multiple AWS Account Credentials</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jtimberman">@jtimberman</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jtimberman',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011-2014 - Joshua Timberman -
  <span class="credit">Powered
  by <a href="http://octopress.org">Octopress</a></span>
  <br /><a rel="license"
  href="http://creativecommons.org/licenses/by-sa/3.0/us/"><img alt="Creative
  Commons License" style="border-width:0"
  src="http://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" /></a> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons Attribution-ShareAlike 3.0 United States License</a>.
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jtimberman';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
