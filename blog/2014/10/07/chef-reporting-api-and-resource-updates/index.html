<p>So the earlier example:&mdash;&ndash;
layout: post
title: &ldquo;Chef Reporting API and Resource Updates&rdquo;
date: 2014-10-07 06:18:34 -0600
comments: true</p>

<h2>categories: chef, knife, reporting, plugins</h2>

<p>Have you ever wanted to find a list of nodes that updated a specific resource in a period of time? Such as &ldquo;show me all the nodes in production that had an application service restart in the last hour&rdquo;? Or, &ldquo;which nodes have updated their apt cache recently?&rdquo; For example,</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife report resource 'role:supermarket-app AND chef_environment:supermarket-prod' execute 'apt-get update'
</span><span class='line'>execute[apt-get update] changed in the following runs:
</span><span class='line'>app-supermarket1.example.com 2230cf30-6d95-4e43-be18-211137eaf802 @ 2014-10-07T14:07:03Z
</span><span class='line'>app-supermarket2.example.com c5e4d7bf-95a6-4385-9d8e-c6f5617ed79b @ 2014-10-07T14:14:04Z
</span><span class='line'>app-supermarket3.example.com c4c4b4bb-91b6-4f73-9876-b24b093c7f1e @ 2014-10-07T14:09:54Z
</span><span class='line'>app-supermarket4.example.com 3eb09034-7539-4a3c-af6d-5b01d35bc63f @ 2014-10-07T13:31:56Z
</span><span class='line'>app-supermarket5.example.com aa48c1d3-da91-4031-a43d-582a577cbf2d @ 2014-10-07T13:35:15Z
</span><span class='line'>Use `knife runs show` with the run UUID to get more info</span></code></pre></td></tr></table></div></figure>


<p>I have released a new knife plugin to do that, but first some background.</p>

<p>At CHEF, we run the community&rsquo;s cookbook site, <a href="https://supermarket.getchef.com">Supermarket</a>. We monitor the systems that run the site with <a href="http://sensuapp.org">Sensu</a>. The current infrastructure runs instances on Amazon Web Services EC2, with an Elastic Load Balancer (ELB) in front of them. As a corrective action for a <a href="https://www.getchef.com/blog/2014/07/10/supermarket-intermittent-unresponsiveness-postmortem/">Supermarket outage</a>, CHEF&rsquo;s operations team added a new check for elevated HTTP 500 responses from the application servers behind the ELB. One thing we found was that when Supermarket was deployed, and the <code>unicorn</code> server restarted, we would see elevated 500&rsquo;s, but the site often wouldn&rsquo;t actually be impacted.</p>

<p>The Sensu check is run from a &ldquo;relay&rdquo; node. That is, it isn&rsquo;t run on the application servers or the Sensu server &ndash; it&rsquo;s run out of band since it&rsquo;s for the ELB. One might imagine we could have similar checks for other services that aren&rsquo;t run on &ldquo;managed nodes,&rdquo; but that&rsquo;s neither here nor there. The issue is that we get an alert message that looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Sensu Alerts  ALERT - [i-d1dfd5d9/check-elb-backend-500] - CheckELBMetrics CRITICAL: supermarket-elb; Sum of HTTPCode_Backend_5XX is 2538.0. (expected lower than 30.0); (HTTPCode_Backend_5XX '2538.0' within 300 seconds between 2014-08-19 13:33:36 +0000 to 2014-08-19 13:38:36 +0000) [Playbook].</span></code></pre></td></tr></table></div></figure>


<p>The first part, <code>[i-d1dfd5d9/check-elb-backend-500]</code> is the node name and the check that alerted. The node name here is the monitoring relay that runs the check, not the actual node or nodes where Supermarket was deployed and restarted. This is where Chef Reporting comes into play. In Chef Reporting, we can view information about recent Chef client runs, which gives us a graph like this.</p>

<p><img src="/images/reporting-graph.png"></p>

<p>If we go look at the reports in the Chef Manage console, we can drill down to something like this.</p>

<p><img src="/images/reporting-resources.png"></p>

<p>This shows that unicorn was restarted in this run. That&rsquo;s great, but if I&rsquo;m getting this alert at a time when I&rsquo;m not particularly coherent (e.g, 2AM), I want a command in a playbook that I can run to get more information quickly without having to log into the webui and click around imprecisely. CHEF publishes a <code>knife-reporting</code> gem that has a couple handy sub-commands to retrieve this run data. For example, we can list runs.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife runs list
</span><span class='line'>node_name:  i-3022aa3b
</span><span class='line'>run_id:     9eccd8f6-876b-4a57-87ac-0b3e7b7ef1e7
</span><span class='line'>start_time: 2014-08-21T17:03:56Z
</span><span class='line'>status:     started
</span><span class='line'>
</span><span class='line'>node_name:  i-a09424a8
</span><span class='line'>run_id:     f2b7871a-149b-4fd3-abdc-d74a838d719a
</span><span class='line'>start_time: 2014-08-21T17:00:23Z
</span><span class='line'>status:     success</span></code></pre></td></tr></table></div></figure>


<p>Or, we can display a specific run.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife runs show eecb04fb-11df-438a-8e81-dd610eb66616
</span><span class='line'>run_detail:
</span><span class='line'>  data:
</span><span class='line'>  end_time:          2014-08-20T17:50:12Z
</span><span class='line'>  node_name:         i-9f22aa94
</span><span class='line'>  run_id:            eecb04fb-11df-438a-8e81-dd610eb66616
</span><span class='line'>  run_list:          ["role[base]","role[supermarket-app]"]
</span><span class='line'>  start_time:        2014-08-20T17:45:37Z
</span><span class='line'>  status:            success
</span><span class='line'>  total_res_count:   261
</span><span class='line'>  updated_res_count: 17
</span><span class='line'>run_resources:
</span><span class='line'>  cookbook_name:    supermarket
</span><span class='line'>  cookbook_version: 2.7.2
</span><span class='line'>  duration:         209
</span><span class='line'>  final_state:
</span><span class='line'>    enabled: false
</span><span class='line'>    running: true
</span><span class='line'>  id:               unicorn
</span><span class='line'>  initial_state:
</span><span class='line'>    enabled: false
</span><span class='line'>    running: true
</span><span class='line'>  name:             unicorn
</span><span class='line'>  result:           restart
</span><span class='line'>  type:             service
</span><span class='line'>  uri:              https://api.opscode.com/organizations/supermarket/reports/org/runs/eecb04fb-11df-438a-8e81-dd610eb66616/15</span></code></pre></td></tr></table></div></figure>


<p>This is handy, but a little limited. What if I want to display only the runs containing the <code>service[unicorn]</code> resource?</p>

<p>That&rsquo;s where my <code>knife-report-resource</code> plugin helps. At first, it was very much specific to finding unicorn restarts on Supermarket app servers. However, I wanted to make it more general purpose as I think people would want to be able to find when arbitrary resources were updated. This is how it works:</p>

<ol>
<li>Query the Chef Server for a particular set of nodes. For example, <code>'role:supermarket-app AND chef_environment:supermarket-prod'</code>.</li>
<li>Get all the Chef client runs for a specified time period up until the current time. By default, it starts from one hour ago, but we can pass an ISO8601 timestamp.</li>
<li>Iterate over all the runs looking for runs by the nodes that were returned by the search query, gathering the specified resource type and name.</li>
<li>Display some nice output with the node&rsquo;s FQDN, the run&rsquo;s UUID, and a timestamp.</li>
</ol>


<p>From the earlier example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife report resource 'role:supermarket-app AND chef_environment:supermarket-prod' execute 'apt-get update'
</span><span class='line'>execute[apt-get update] changed in the following runs:
</span><span class='line'>app-supermarket1.example.com 2230cf30-6d95-4e43-be18-211137eaf802 @ 2014-10-07T14:07:03Z
</span><span class='line'>app-supermarket2.example.com c5e4d7bf-95a6-4385-9d8e-c6f5617ed79b @ 2014-10-07T14:14:04Z
</span><span class='line'>app-supermarket3.example.com c4c4b4bb-91b6-4f73-9876-b24b093c7f1e @ 2014-10-07T14:09:54Z
</span><span class='line'>app-supermarket4.example.com 3eb09034-7539-4a3c-af6d-5b01d35bc63f @ 2014-10-07T13:31:56Z
</span><span class='line'>app-supermarket5.example.com aa48c1d3-da91-4031-a43d-582a577cbf2d @ 2014-10-07T13:35:15Z
</span><span class='line'>Use `knife runs show` with the run UUID to get more info</span></code></pre></td></tr></table></div></figure>


<p>Then, we can drill down further into one of these runs with the <code>knife-reporting</code> plugin.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% knife runs show 2230cf30-6d95-4e43-be18-211137eaf802
</span><span class='line'>run_detail:
</span><span class='line'>  data:
</span><span class='line'>  end_time:          2014-10-07T14:07:03Z
</span><span class='line'>  node_name:         i-d7fed0df
</span><span class='line'>  run_id:            2230cf30-6d95-4e43-be18-211137eaf802
</span><span class='line'>  run_list:          ["role[base]","role[supermarket-app]"]
</span><span class='line'>  start_time:        2014-10-07T14:03:59Z
</span><span class='line'>  status:            success
</span><span class='line'>  total_res_count:   271
</span><span class='line'>  updated_res_count: 12
</span><span class='line'>run_resources:
</span><span class='line'>  cookbook_name:    chef-client
</span><span class='line'>  cookbook_version: 3.6.0
</span><span class='line'>  duration:         99
</span><span class='line'>  final_state:
</span><span class='line'>    enabled: true
</span><span class='line'>    running: false
</span><span class='line'>  id:               chef-client
</span><span class='line'>  initial_state:
</span><span class='line'>    enabled: true
</span><span class='line'>    running: true
</span><span class='line'>  name:             chef-client
</span><span class='line'>  result:           enable
</span><span class='line'>  type:             runit_service
</span><span class='line'>  uri:              https://api.opscode.com/organizations/supermarket/reports/org/runs/2230cf30-6d95-4e43-be18-211137eaf802/0
</span><span class='line'>...
</span><span class='line'>  cookbook_name:    supermarket
</span><span class='line'>  cookbook_version: 2.11.0
</span><span class='line'>  duration:         8506
</span><span class='line'>  final_state:
</span><span class='line'>  id:               apt-get update
</span><span class='line'>  initial_state:
</span><span class='line'>  name:             apt-get update
</span><span class='line'>  result:           run
</span><span class='line'>  type:             execute
</span><span class='line'>  uri:              https://api.opscode.com/organizations/supermarket/reports/org/runs/2230cf30-6d95-4e43-be18-211137eaf802/5</span></code></pre></td></tr></table></div></figure>


<p>Hopefully you find this plugin useful! It is a RubyGem, and is available on RubyGems.org, and the source is available on GitHub.</p>

<ul>
<li><a href="https://supermarket.getchef.com/tools/knife-report-resource">Supermarket tool page</a></li>
<li><a href="https://rubygems.org/gems/knife-report-resource">RubyGem page</a></li>
<li><a href="https://github.com/jtimberman/knife-report-resource">GitHub repository</a></li>
</ul>

